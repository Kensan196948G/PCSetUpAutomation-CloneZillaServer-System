# システムアーキテクチャ

## 概要

本システムは、Clonezilla Server Editionをコアとして、DHCP/TFTP/PXEブート/NFSを組み合わせた完全自動PCキッティングシステムです。

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    Clonezilla Server                        │
│                  (Ubuntu Server 22.04 LTS)                  │
│                                                             │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐ │
│  │   DHCP Server  │  │   TFTP Server  │  │ NFS Server   │ │
│  │   (dnsmasq)    │  │   (dnsmasq)    │  │ (nfs-kernel) │ │
│  │                │  │                │  │              │ │
│  │ IP割当         │  │ PXEブートイメ  │  │ Clonezilla   │ │
│  │ レンジ管理     │  │ ージ配信       │  │ イメージ共有 │ │
│  └────────────────┘  └────────────────┘  └──────────────┘ │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         Clonezilla Server Edition (DRBL)             │  │
│  │                                                      │  │
│  │  - イメージ作成（savedisk）                          │  │
│  │  - イメージ復元（restoredisk）                       │  │
│  │  - マルチキャスト配信                                │  │
│  │  - ユニキャスト配信                                  │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │         イメージストレージ                           │  │
│  │         /home/partimag/                              │  │
│  │                                                      │  │
│  │  - win11-base-2025/                                  │  │
│  │  - win11-sales-2025/                                 │  │
│  │  - win11-accounting-2025/                            │  │
│  │  - logs/ (展開履歴)                                  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ Gigabit Ethernet
                              │
                ┌─────────────┴─────────────┐
                │                           │
        ┌───────┴────────┐          ┌──────┴───────┐
        │  Gigabit       │          │   Layer 2/3  │
        │  Switch        │          │   Switch     │
        │  (Unmanaged)   │          │  (Managed)   │
        └───────┬────────┘          └──────┬───────┘
                │                          │
                │                          │ VLAN 100
                │                          │ (Kitting Network)
                │                          │
        ┌───────┴──────────────────────────┴───────┐
        │                                          │
   ┌────┴─────┐  ┌──────────┐  ┌──────────┐  ┌───┴──────┐
   │ Target   │  │ Target   │  │ Target   │  │ Target   │
   │  PC #1   │  │  PC #2   │  │  PC #3   │  │  PC #40  │
   │          │  │          │  │          │  │          │
   │ PXE Boot │  │ PXE Boot │  │ PXE Boot │  │ PXE Boot │
   └──────────┘  └──────────┘  └──────────┘  └──────────┘
```

## データフロー

### イメージ作成フロー

```
┌──────────────┐
│ マスターPC   │
│ (準備済み)   │
└──────┬───────┘
       │ ① 電源ON (PXEブート)
       ▼
┌──────────────┐
│ DHCP Request │
└──────┬───────┘
       │ ② IP割当 (192.168.100.x)
       ▼
┌──────────────┐
│ TFTP Request │
└──────┬───────┘
       │ ③ pxelinux.0 取得
       ▼
┌─────────────────┐
│ Clonezilla起動 │
└──────┬──────────┘
       │ ④ NFS経由でサーバー接続
       ▼
┌─────────────────┐
│ イメージ作成    │
│ (savedisk)      │
└──────┬──────────┘
       │ ⑤ 圧縮・保存
       ▼
┌─────────────────────┐
│ /home/partimag/     │
│   win11-base-2025/  │
│     ├── disk        │
│     ├── parts       │
│     └── sda*.gz     │
└─────────────────────┘
```

### マルチキャスト展開フロー

```
┌────────────────────┐
│ 管理者             │
│ 展開スクリプト実行 │
└─────────┬──────────┘
          │
          ▼
┌────────────────────┐
│ Clonezilla SE起動  │
│ (Multicast mode)   │
└─────────┬──────────┘
          │
          ▼
┌────────────────────────────────────────┐
│ マルチキャストセッション開始           │
│ - イメージ: win11-base-2025            │
│ - グループ: 239.192.0.1:2232           │
│ - 待機台数: 20                         │
│ - タイムアウト: 600秒                  │
└────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│        ターゲットPC群 (1-20)            │
│  ① PXEブート                            │
│  ② DHCP/TFTP経由でClonezilla起動        │
│  ③ マルチキャストグループに参加         │
│  ④ サーバーからのデータ受信待機         │
└─────────┬───────────────────────────────┘
          │
          │ 指定台数到達 or タイムアウト
          ▼
┌─────────────────────────────────────────┐
│      マルチキャスト配信開始             │
│  - 圧縮イメージデータを一斉配信         │
│  - すべてのクライアントが同時受信       │
│  - 帯域: 400-800 Mbps (典型値)          │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│    各ターゲットPCでイメージ展開         │
│  - 受信データの解凍                     │
│  - ディスクへの書き込み                 │
│  - パーティションテーブル復元           │
└─────────┬───────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│        展開完了・自動再起動             │
│  - Windows起動                          │
│  - OOBE (初期設定画面)                  │
└─────────────────────────────────────────┘
```

## ネットワークプロトコル詳細

### 使用ポート

| プロトコル | ポート    | 用途                           |
|-----------|----------|--------------------------------|
| DHCP      | 67/udp   | IP アドレス割当                |
| TFTP      | 69/udp   | PXEブートイメージ配信          |
| RPC       | 111/tcp  | NFS用リモートプロシージャコール |
| RPC       | 111/udp  | NFS用リモートプロシージャコール |
| NFS       | 2049/tcp | Clonezillaイメージ共有         |
| NFS       | 2049/udp | Clonezillaイメージ共有         |
| Multicast | 2232/udp | マルチキャストデータ配信       |
| HTTP      | 2556/tcp | Clonezilla SE管理画面          |

### IPアドレス設計

```
ネットワーク: 192.168.100.0/24

┌──────────────────┬─────────────────┬─────────────────┐
│ 範囲             │ 用途            │ 備考            │
├──────────────────┼─────────────────┼─────────────────┤
│ 192.168.100.1    │ サーバー        │ 静的IP          │
│ 192.168.100.10-  │ DHCP範囲        │ 自動割当        │
│ 192.168.100.100  │ (ターゲットPC)  │ 最大91台        │
│ 192.168.100.200- │ 管理用端末      │ 静的IP推奨      │
│ 192.168.100.250  │                 │                 │
│ 192.168.100.254  │ ゲートウェイ    │ オプション      │
└──────────────────┴─────────────────┴─────────────────┘
```

## パフォーマンス特性

### 展開速度の目安

```
条件:
- サーバー: Core i7, 16GB RAM, SSD
- ネットワーク: Gigabit Ethernet
- クライアント: 標準的なビジネスPC
- イメージサイズ: 30GB (圧縮後 10GB)

┌───────────┬──────────────┬─────────────┐
│ 台数      │ 所要時間     │ 配信モード  │
├───────────┼──────────────┼─────────────┤
│ 1台       │ 15-20分      │ ユニキャスト│
│ 10台      │ 25-30分      │ マルチキャスト│
│ 20台      │ 30-40分      │ マルチキャスト│
│ 40台      │ 40-50分      │ マルチキャスト│
└───────────┴──────────────┴─────────────┘

※ イメージサイズや圧縮率により変動します
```

### ボトルネック分析

```
┌─────────────────────┬──────────────┬──────────────┐
│ コンポーネント      │ 推奨スペック │ ボトルネック │
├─────────────────────┼──────────────┼──────────────┤
│ サーバーCPU         │ 4コア以上    │ 圧縮/解凍    │
│ サーバーRAM         │ 16GB以上     │ キャッシュ   │
│ サーバーストレージ  │ SSD 500GB+   │ I/O速度      │
│ ネットワーク帯域    │ 1Gbps        │ 転送速度     │
│ スイッチ性能        │ L2/L3        │ マルチキャスト│
└─────────────────────┴──────────────┴──────────────┘
```

## セキュリティ層

### ネットワーク分離

```
┌──────────────────────────────────────┐
│         本番ネットワーク             │
│       (VLAN 10 / 物理分離)           │
│                                      │
│  - 社内PC                            │
│  - サーバー                          │
│  - プリンター                        │
└──────────────────────────────────────┘
               │
               │ ファイアウォール/ルーター
               │
┌──────────────┴───────────────────────┐
│      キッティングネットワーク        │
│       (VLAN 100 / 物理分離)          │
│                                      │
│  - Clonezilla Server                 │
│  - ターゲットPC（キッティング中）    │
│  - 管理用端末（オプション）          │
└──────────────────────────────────────┘
```

### アクセス制御

1. **ファイアウォールルール**
   - キッティングNWから本番NWへのアクセス: 拒否
   - 管理用端末からサーバーSSH: 許可（特定IP）
   - その他外部アクセス: 拒否

2. **認証**
   - SSH公開鍵認証のみ
   - rootログイン無効
   - パスワード認証無効

3. **監査ログ**
   - すべてのSSHアクセスログ記録
   - 展開履歴の自動記録
   - システムログの保持

## 高可用性設計（オプション）

大規模環境向けの冗長化構成:

```
┌─────────────────┐      ┌─────────────────┐
│ Primary Server  │      │ Secondary Server│
│ (Active)        │◄────►│ (Standby)       │
│                 │      │                 │
│ - DHCP Master   │      │ - DHCP Backup   │
│ - Clonezilla SE │      │ - イメージ同期  │
│ - NFS Export    │      │ - NFS Export    │
└────────┬────────┘      └────────┬────────┘
         │                        │
         └────────┬───────────────┘
                  │
            Shared Storage
         (NFS/iSCSI/DRBD)
              │
      /home/partimag/
    (イメージ共有)
```

## スケーラビリティ

### 小規模環境（年間20-50台）

```
- サーバー: 1台
- スペック: Core i5, 8GB RAM, 500GB HDD
- ネットワーク: 小規模スイッチ
- 同時展開: 最大10台
```

### 中規模環境（年間50-100台）

```
- サーバー: 1台
- スペック: Core i7, 16GB RAM, 1TB SSD
- ネットワーク: Gigabitスイッチ
- 同時展開: 最大40台
```

### 大規模環境（年間100台以上）

```
- サーバー: 2台（冗長化）
- スペック: Xeon, 32GB RAM, 2TB SSD RAID
- ネットワーク: Layer 3スイッチ、VLAN構成
- 同時展開: 最大100台（複数バッチ）
- 専用ストレージ: NAS/SAN
```

## 技術スタック

```
┌─────────────────────────────────────┐
│           Application Layer          │
│  - Clonezilla SE (イメージ管理)     │
│  - 自動化スクリプト (Bash)           │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│          Service Layer               │
│  - DRBL (PXE/Network Boot)           │
│  - dnsmasq (DHCP/TFTP)               │
│  - NFS (File Sharing)                │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│         Operating System             │
│  - Ubuntu Server 22.04 LTS           │
│  - Linux Kernel 5.15+                │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│          Hardware Layer              │
│  - x86_64 Server                     │
│  - Gigabit Ethernet                  │
│  - SSD Storage                       │
└─────────────────────────────────────┘
```

## 関連ドキュメント

- [README.md](../README.md) - システム概要と詳細説明
- [QUICK_START.md](./QUICK_START.md) - 30分セットアップガイド
- [WORKFLOWS.md](./WORKFLOWS.md) - 運用ワークフロー
- [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) - トラブルシューティング
