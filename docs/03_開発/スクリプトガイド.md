# スクリプトガイド

本ドキュメントでは、PC Setup Automation プロジェクトで使用する各種スクリプトの概要と使用方法を説明します。

## 目次

1. [共通スクリプト](#共通スクリプト)
2. [開発環境スクリプト](#開発環境スクリプト)
3. [本番環境スクリプト](#本番環境スクリプト)
4. [トラブルシューティング](#トラブルシューティング)

---

## 共通スクリプト

### 1. prepare-migration.sh

**パス**: `/scripts/prepare-migration.sh`

**機能概要**:
- 現在のファイル構造をバックアップ
- 移行前チェックリストの実行
- 移行計画の出力
- dry-runモード対応

**使用例**:
```bash
# dry-runモード（実際には変更しない）
./scripts/prepare-migration.sh --dry-run

# 実際の移行実行
./scripts/prepare-migration.sh

# バックアップのみ実行
./scripts/prepare-migration.sh --backup
```

**主な機能**:
- Flask動作確認
- データベース整合性確認
- 設定ファイル存在確認
- ディスク容量確認
- 自動バックアップ作成

**出力**:
- バックアップ: `/backups/migration-YYYYMMDD-HHMMSS/`
- ログ: `/logs/migration-YYYYMMDD-HHMMSS.log`

---

### 2. switch-environment.sh

**パス**: `/scripts/switch-environment.sh`

**機能概要**:
- 開発環境と本番環境の切り替え
- 環境変数の切り替え
- サービスの再起動
- 現在の環境表示

**使用例**:
```bash
# 開発環境に切り替え
./scripts/switch-environment.sh development

# 本番環境に切り替え
./scripts/switch-environment.sh production

# 現在の環境を表示
./scripts/switch-environment.sh status
```

**切り替え内容**:
- 環境変数ファイル（.env）のシンボリックリンク変更
- systemdサービスの起動/停止
- Nginxの起動/停止
- 環境状態ファイルの更新

**注意事項**:
- 本番環境への切り替え時は確認プロンプトが表示されます
- サービスの起動/停止には管理者権限が必要な場合があります

---

## 開発環境スクリプト

### 1. init-dev-env.sh

**パス**: `/development/scripts/init-dev-env.sh`

**機能概要**:
- Python仮想環境の作成
- 依存パッケージのインストール
- 開発用データベースの初期化
- テストデータの投入
- 開発サーバの起動確認

**使用例**:
```bash
# 通常実行
./development/scripts/init-dev-env.sh

# 既存環境をリセットして再構築
./development/scripts/init-dev-env.sh --reset

# テストデータも投入
./development/scripts/init-dev-env.sh --test
```

**実行内容**:
1. 前提条件チェック
   - Python 3.10以上
   - pip3
   - venv
   - SQLite3
   - ディスク容量

2. Python仮想環境作成
   - `/development/venv/` に作成
   - pip更新

3. 依存パッケージインストール
   - Flask
   - Flask-SQLAlchemy
   - Flask-Migrate
   - pytest
   - pytest-cov

4. 環境変数ファイル作成
   - `/development/.env.dev`

5. データベース初期化
   - `/development/pc_setup.db`
   - テーブル作成

6. テストデータ投入（--testオプション時）
   - 3台のテストPC情報
   - セットアップログサンプル

**出力**:
- 仮想環境: `/development/venv/`
- データベース: `/development/pc_setup.db`
- ログ: `/logs/init-dev-YYYYMMDD-HHMMSS.log`

---

### 2. start-dev.sh

**パス**: `/development/scripts/start-dev.sh`

**機能概要**:
- 開発サーバの起動
- 自動的に仮想環境をアクティベート
- Flask開発サーバをバックグラウンド起動

**使用例**:
```bash
./development/scripts/start-dev.sh
```

---

### 3. stop-dev.sh

**パス**: `/development/scripts/stop-dev.sh`

**機能概要**:
- 開発サーバの停止
- Flaskプロセスの終了

**使用例**:
```bash
./development/scripts/stop-dev.sh
```

---

### 4. run-tests.sh

**パス**: `/development/scripts/run-tests.sh`

**機能概要**:
- ユニットテスト実行
- 統合テスト実行
- カバレッジレポート生成

**使用例**:
```bash
# すべてのテスト実行
./development/scripts/run-tests.sh

# ユニットテストのみ
./development/scripts/run-tests.sh --unit

# カバレッジレポート生成
./development/scripts/run-tests.sh --coverage
```

---

### 5. reset-db.sh

**パス**: `/development/scripts/reset-db.sh`

**機能概要**:
- 開発用データベースのリセット
- テーブル再作成
- テストデータ再投入

**使用例**:
```bash
./development/scripts/reset-db.sh
```

---

## 本番環境スクリプト

### 1. init-prod-env.sh

**パス**: `/production/scripts/init-prod-env.sh`

**機能概要**:
- Python仮想環境の作成（本番用）
- 本番用依存パッケージのインストール
- systemdサービスの登録
- Nginx設定の適用
- ファイアウォール設定確認
- セキュリティチェック

**使用例**:
```bash
# 通常実行（要root権限）
sudo ./production/scripts/init-prod-env.sh

# 既存環境をリセット
sudo ./production/scripts/init-prod-env.sh --reset

# サービス起動をスキップ
sudo ./production/scripts/init-prod-env.sh --no-start
```

**実行内容**:
1. 前提条件チェック
   - Python 3.10以上
   - Nginx
   - systemd
   - PostgreSQL（オプション）
   - ufw（ファイアウォール）

2. ディレクトリ構造作成
   - `/production/flask-app/`
   - `/production/logs/`
   - `/production/uploads/`
   - `/production/backups/`
   - `/production/odj-files/`

3. Python仮想環境作成
   - `/production/venv/`

4. 本番用パッケージインストール
   - Flask
   - Flask-SQLAlchemy
   - Flask-Migrate
   - Gunicorn（WSGIサーバ）
   - psycopg2-binary

5. 本番環境変数ファイル作成
   - `/production/.env.prod`
   - SECRET_KEY自動生成
   - 権限600に設定

6. 本番データベース初期化
   - `/production/pc_setup.db`

7. systemdサービスファイル作成
   - `/production/systemd/pcsetup-flask.service`
   - `/etc/systemd/system/` にインストール

8. Nginx設定ファイル作成
   - `/production/nginx/pcsetup.conf`
   - `/etc/nginx/sites-available/` にインストール
   - sites-enabledにシンボリックリンク作成

9. ファイアウォール設定
   - HTTP (80/tcp) 許可
   - HTTPS (443/tcp) 許可

10. セキュリティチェック
    - .env.prod権限確認
    - DEBUG設定確認
    - SECRET_KEY確認

11. サービス起動
    - pcsetup-flask.service
    - nginx.service

**出力**:
- 仮想環境: `/production/venv/`
- データベース: `/production/pc_setup.db`
- systemdサービス: `/etc/systemd/system/pcsetup-flask.service`
- Nginx設定: `/etc/nginx/sites-available/pcsetup`
- ログ: `/logs/init-prod-YYYYMMDD-HHMMSS.log`

**セキュリティ考慮事項**:
- .env.prodは権限600で作成
- SECRET_KEYは自動生成
- DEBUG=0に設定
- www-dataユーザで実行
- ファイアウォールルール設定

---

### 2. start-prod.sh

**パス**: `/production/scripts/start-prod.sh`

**機能概要**:
- 本番サービスの起動
- Flaskサービス起動
- Nginx起動

**使用例**:
```bash
sudo ./production/scripts/start-prod.sh
```

---

### 3. stop-prod.sh

**パス**: `/production/scripts/stop-prod.sh`

**機能概要**:
- 本番サービスの停止
- Flaskサービス停止
- Nginx停止

**使用例**:
```bash
sudo ./production/scripts/stop-prod.sh
```

---

### 4. backup.sh

**パス**: `/production/scripts/backup.sh`

**機能概要**:
- 本番データベースのバックアップ
- 設定ファイルのバックアップ
- ODJファイルのバックアップ

**使用例**:
```bash
# 通常バックアップ
sudo ./production/scripts/backup.sh

# 圧縮バックアップ
sudo ./production/scripts/backup.sh --compress
```

**バックアップ先**:
- `/production/backups/backup-YYYYMMDD-HHMMSS/`

---

### 5. restore.sh

**パス**: `/production/scripts/restore.sh`

**機能概要**:
- バックアップからの復元
- データベース復元
- 設定ファイル復元

**使用例**:
```bash
sudo ./production/scripts/restore.sh /production/backups/backup-20251117-120000/
```

---

### 6. health-check.sh

**パス**: `/production/scripts/health-check.sh`

**機能概要**:
- 本番環境のヘルスチェック
- サービス状態確認
- データベース接続確認
- API応答確認
- ディスク容量確認

**使用例**:
```bash
./production/scripts/health-check.sh

# 詳細モード
./production/scripts/health-check.sh --verbose
```

**チェック項目**:
- Flaskサービス稼働状態
- Nginx稼働状態
- データベース接続
- API `/health` エンドポイント応答
- ディスク容量
- メモリ使用量
- CPU使用率

---

## トラブルシューティング

### 開発環境でFlaskが起動しない

**症状**:
- `flask run` でエラーが発生
- `ModuleNotFoundError` が表示

**対処法**:
```bash
# 仮想環境を再作成
./development/scripts/init-dev-env.sh --reset

# 仮想環境がアクティベートされているか確認
source development/venv/bin/activate

# Flask再インストール
pip install Flask
```

---

### 本番環境でサービスが起動しない

**症状**:
- `systemctl start pcsetup-flask` でエラー

**対処法**:
```bash
# サービス状態確認
sudo systemctl status pcsetup-flask

# ログ確認
sudo journalctl -u pcsetup-flask -f

# 設定ファイル確認
cat /etc/systemd/system/pcsetup-flask.service

# systemd再読み込み
sudo systemctl daemon-reload

# サービス再起動
sudo systemctl restart pcsetup-flask
```

---

### データベースマイグレーションエラー

**症状**:
- テーブルが作成されない
- マイグレーションエラー

**対処法**:
```bash
# 開発環境の場合
./development/scripts/reset-db.sh

# 本番環境の場合（バックアップ後）
sudo ./production/scripts/backup.sh
cd production/flask-app
source ../venv/bin/activate
flask db upgrade
```

---

### Nginx設定エラー

**症状**:
- Nginx起動エラー
- 502 Bad Gateway

**対処法**:
```bash
# Nginx設定テスト
sudo nginx -t

# エラーログ確認
sudo tail -f /var/log/nginx/pcsetup-error.log

# Flaskサービス確認
sudo systemctl status pcsetup-flask

# Nginx再起動
sudo systemctl restart nginx
```

---

## 環境移行の手順

### 1. 移行準備

```bash
# バックアップ作成
./scripts/prepare-migration.sh --dry-run
./scripts/prepare-migration.sh
```

### 2. 開発環境セットアップ

```bash
# 開発環境初期化
./development/scripts/init-dev-env.sh --test

# 動作確認
cd development/flask-app
source ../venv/bin/activate
flask run
```

### 3. 本番環境セットアップ

```bash
# 本番環境初期化
sudo ./production/scripts/init-prod-env.sh

# ヘルスチェック
./production/scripts/health-check.sh
```

### 4. 環境切り替え

```bash
# 開発環境に切り替え
./scripts/switch-environment.sh development

# 本番環境に切り替え
./scripts/switch-environment.sh production
```

---

## スクリプト一覧表

| スクリプト名 | パス | 用途 | 実行権限 |
|------------|------|------|----------|
| prepare-migration.sh | /scripts/ | 環境移行準備 | 通常ユーザ |
| switch-environment.sh | /scripts/ | 環境切り替え | sudo推奨 |
| init-dev-env.sh | /development/scripts/ | 開発環境初期化 | 通常ユーザ |
| start-dev.sh | /development/scripts/ | 開発サーバ起動 | 通常ユーザ |
| stop-dev.sh | /development/scripts/ | 開発サーバ停止 | 通常ユーザ |
| run-tests.sh | /development/scripts/ | テスト実行 | 通常ユーザ |
| reset-db.sh | /development/scripts/ | DB リセット | 通常ユーザ |
| init-prod-env.sh | /production/scripts/ | 本番環境初期化 | sudo必須 |
| start-prod.sh | /production/scripts/ | 本番サーバ起動 | sudo必須 |
| stop-prod.sh | /production/scripts/ | 本番サーバ停止 | sudo必須 |
| backup.sh | /production/scripts/ | バックアップ | sudo必須 |
| restore.sh | /production/scripts/ | 復元 | sudo必須 |
| health-check.sh | /production/scripts/ | ヘルスチェック | 通常ユーザ |

---

## ログファイルの場所

すべてのスクリプトは実行時にログを出力します:

```
/logs/
├── migration-YYYYMMDD-HHMMSS.log     # 移行準備ログ
├── switch-env-YYYYMMDD-HHMMSS.log    # 環境切り替えログ
├── init-dev-YYYYMMDD-HHMMSS.log      # 開発環境初期化ログ
├── init-prod-YYYYMMDD-HHMMSS.log     # 本番環境初期化ログ
├── backup-YYYYMMDD-HHMMSS.log        # バックアップログ
└── health-check-YYYYMMDD-HHMMSS.log  # ヘルスチェックログ
```

---

## よくある質問（FAQ）

### Q1: スクリプトの実行権限がない場合は?

```bash
chmod 755 /path/to/script.sh
```

### Q2: 仮想環境がアクティベートされない場合は?

```bash
source /path/to/venv/bin/activate
```

### Q3: 環境変数ファイルが見つからない場合は?

```bash
# 開発環境
cp .env.example development/.env.dev

# 本番環境
cp .env.example production/.env.prod
# 本番環境の場合は SECRET_KEY を変更すること
```

### Q4: データベースファイルが見つからない場合は?

```bash
# 開発環境
./development/scripts/init-dev-env.sh --reset

# 本番環境
sudo ./production/scripts/init-prod-env.sh --reset
```

---

**最終更新**: 2025-11-17
**バージョン**: 1.0.0
