<?xml version="1.0" encoding="utf-8"?>
<!--
    Windows 11 Sysprep用 unattend.xml

    概要:
    - マスターイメージ作成時のSysprep応答ファイル
    - 初回起動時の自動セットアップスクリプト実行設定
    - 日本語環境・タイムゾーン自動設定
    - 自動ログオン設定（初回のみ）

    配置先: C:\Windows\System32\Sysprep\unattend.xml

    使用方法:
    sysprep.exe /generalize /oobe /shutdown /unattend:C:\Windows\System32\Sysprep\unattend.xml
-->
<unattend xmlns="urn:schemas-microsoft-com:unattend">

    <!-- =========================================== -->
    <!-- Pass 1: windowsPE (ブート・パーティション) -->
    <!-- =========================================== -->
    <settings pass="windowsPE">
        <component name="Microsoft-Windows-International-Core-WinPE" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <!-- 言語設定: 日本語 -->
            <SetupUILanguage>
                <UILanguage>ja-JP</UILanguage>
            </SetupUILanguage>
            <InputLocale>ja-JP</InputLocale>
            <SystemLocale>ja-JP</SystemLocale>
            <UILanguage>ja-JP</UILanguage>
            <UserLocale>ja-JP</UserLocale>
        </component>

        <component name="Microsoft-Windows-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <!-- ディスク構成設定（不要な場合はコメントアウト） -->
            <!--
            <DiskConfiguration>
                <Disk wcm:action="add">
                    <CreatePartitions>
                        <CreatePartition wcm:action="add">
                            <Order>1</Order>
                            <Type>EFI</Type>
                            <Size>100</Size>
                        </CreatePartition>
                        <CreatePartition wcm:action="add">
                            <Order>2</Order>
                            <Type>MSR</Type>
                            <Size>128</Size>
                        </CreatePartition>
                        <CreatePartition wcm:action="add">
                            <Order>3</Order>
                            <Type>Primary</Type>
                            <Extend>true</Extend>
                        </CreatePartition>
                    </CreatePartitions>
                    <DiskID>0</DiskID>
                    <WillWipeDisk>true</WillWipeDisk>
                </Disk>
            </DiskConfiguration>
            -->

            <!-- プロダクトキー設定（ボリュームライセンスの場合） -->
            <!--
            <UserData>
                <ProductKey>
                    <Key>XXXXX-XXXXX-XXXXX-XXXXX-XXXXX</Key>
                    <WillShowUI>OnError</WillShowUI>
                </ProductKey>
                <AcceptEula>true</AcceptEula>
            </UserData>
            -->
        </component>
    </settings>

    <!-- =========================================== -->
    <!-- Pass 4: specialize (コンピューター固有設定) -->
    <!-- =========================================== -->
    <settings pass="specialize">
        <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <!-- コンピューター名（自動セットアップスクリプトで変更） -->
            <ComputerName>TEMP-PC</ComputerName>

            <!-- タイムゾーン: 日本標準時 -->
            <TimeZone>Tokyo Standard Time</TimeZone>

            <!-- プロダクトキー（ボリュームライセンス） -->
            <!--
            <ProductKey>XXXXX-XXXXX-XXXXX-XXXXX-XXXXX</ProductKey>
            -->
        </component>

        <component name="Microsoft-Windows-International-Core" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <!-- 地域・言語設定: 日本 -->
            <InputLocale>ja-JP</InputLocale>
            <SystemLocale>ja-JP</SystemLocale>
            <UILanguage>ja-JP</UILanguage>
            <UserLocale>ja-JP</UserLocale>
        </component>

        <component name="Microsoft-Windows-Deployment" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <!-- Sysprep実行ログ保存 -->
            <RunSynchronous>
                <RunSynchronousCommand wcm:action="add">
                    <Order>1</Order>
                    <Path>cmd /c echo Sysprep Specialize Pass Completed > C:\sysprep_specialize.log</Path>
                    <Description>Sysprep Specialize Pass Log</Description>
                </RunSynchronousCommand>
            </RunSynchronous>
        </component>
    </settings>

    <!-- =========================================== -->
    <!-- Pass 7: oobeSystem (初回起動時設定) -->
    <!-- =========================================== -->
    <settings pass="oobeSystem">
        <component name="Microsoft-Windows-Shell-Setup" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">

            <!-- OOBE設定 -->
            <OOBE>
                <!-- ネットワーク接続をスキップ -->
                <HideEULAPage>true</HideEULAPage>
                <HideOEMRegistrationScreen>true</HideOEMRegistrationScreen>
                <HideOnlineAccountScreens>true</HideOnlineAccountScreens>
                <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
                <NetworkLocation>Work</NetworkLocation>
                <ProtectYourPC>3</ProtectYourPC>
                <SkipMachineOOBE>true</SkipMachineOOBE>
                <SkipUserOOBE>true</SkipUserOOBE>
            </OOBE>

            <!-- ローカルアカウント作成（自動ログオン用） -->
            <UserAccounts>
                <LocalAccounts>
                    <LocalAccount wcm:action="add">
                        <Password>
                            <!-- 初期パスワード（Base64エンコード） -->
                            <!-- 平文: TempPass123! -->
                            <Value>VABlAG0AcABQAGEAcwBzADEAMgAzACEAUABhAHMAcwB3AG8AcgBkAA==</Value>
                            <PlainText>false</PlainText>
                        </Password>
                        <DisplayName>Setup Administrator</DisplayName>
                        <Group>Administrators</Group>
                        <Name>SetupAdmin</Name>
                    </LocalAccount>
                </LocalAccounts>
            </UserAccounts>

            <!-- 自動ログオン設定（初回のみ） -->
            <AutoLogon>
                <Password>
                    <!-- 上記と同じパスワード -->
                    <Value>VABlAG0AcABQAGEAcwBzADEAMgAzACEAUABhAHMAcwB3AG8AcgBkAA==</Value>
                    <PlainText>false</PlainText>
                </Password>
                <Enabled>true</Enabled>
                <LogonCount>3</LogonCount>
                <Username>SetupAdmin</Username>
            </AutoLogon>

            <!-- 初回ログオン時コマンド実行 -->
            <FirstLogonCommands>

                <!-- コマンド1: PowerShell実行ポリシー変更 -->
                <SynchronousCommand wcm:action="add">
                    <Order>1</Order>
                    <CommandLine>powershell.exe -NoProfile -ExecutionPolicy Bypass -Command "Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope LocalMachine -Force"</CommandLine>
                    <Description>Set PowerShell Execution Policy</Description>
                    <RequiresUserInput>false</RequiresUserInput>
                </SynchronousCommand>

                <!-- コマンド2: 自動セットアップログ開始 -->
                <SynchronousCommand wcm:action="add">
                    <Order>2</Order>
                    <CommandLine>cmd /c echo FirstLogonCommands Started: %DATE% %TIME% > C:\AutoSetup\setup.log</CommandLine>
                    <Description>Log FirstLogonCommands Start</Description>
                    <RequiresUserInput>false</RequiresUserInput>
                </SynchronousCommand>

                <!-- コマンド3: 自動セットアップスクリプト実行 -->
                <SynchronousCommand wcm:action="add">
                    <Order>3</Order>
                    <CommandLine>powershell.exe -NoProfile -ExecutionPolicy Bypass -File "C:\AutoSetup\setup.ps1" -LogPath "C:\AutoSetup\setup.log"</CommandLine>
                    <Description>Run Auto Setup Script</Description>
                    <RequiresUserInput>false</RequiresUserInput>
                </SynchronousCommand>

                <!-- コマンド4: タスクスケジューラ登録（再起動後の継続処理用） -->
                <SynchronousCommand wcm:action="add">
                    <Order>4</Order>
                    <CommandLine>schtasks /Create /TN "AutoSetup-PostReboot" /TR "powershell.exe -NoProfile -ExecutionPolicy Bypass -File C:\AutoSetup\post-reboot.ps1" /SC ONLOGON /RU SYSTEM /RL HIGHEST /F</CommandLine>
                    <Description>Schedule Post-Reboot Task</Description>
                    <RequiresUserInput>false</RequiresUserInput>
                </SynchronousCommand>

                <!-- コマンド5: 完了ログ -->
                <SynchronousCommand wcm:action="add">
                    <Order>5</Order>
                    <CommandLine>cmd /c echo FirstLogonCommands Completed: %DATE% %TIME% >> C:\AutoSetup\setup.log</CommandLine>
                    <Description>Log FirstLogonCommands Completion</Description>
                    <RequiresUserInput>false</RequiresUserInput>
                </SynchronousCommand>

            </FirstLogonCommands>

        </component>

        <component name="Microsoft-Windows-International-Core" processorArchitecture="amd64" publicKeyToken="31bf3856ad364e35" language="neutral" versionScope="nonSxS" xmlns:wcm="http://schemas.microsoft.com/WMIConfig/2002/State" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
            <!-- 言語・地域設定 -->
            <InputLocale>ja-JP</InputLocale>
            <SystemLocale>ja-JP</SystemLocale>
            <UILanguage>ja-JP</UILanguage>
            <UserLocale>ja-JP</UserLocale>
        </component>

    </settings>

</unattend>
