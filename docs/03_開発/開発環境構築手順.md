# 開発環境構築手順

## 目次
1. [前提条件](#前提条件)
2. [システム要件](#システム要件)
3. [開発環境セットアップ](#開発環境セットアップ)
4. [データベース初期化](#データベース初期化)
5. [開発サーバ起動](#開発サーバ起動)
6. [テストデータ投入](#テストデータ投入)
7. [VSCode推奨設定](#vscode推奨設定)
8. [トラブルシューティング](#トラブルシューティング)

---

## 前提条件

### 必要なソフトウェア
- **OS**: Ubuntu 22.04 LTS（推奨）または Windows 11 + WSL2
- **Python**: 3.10以上
- **Git**: 2.30以上
- **エディタ**: Visual Studio Code（推奨）
- **データベース**: SQLite（開発）、PostgreSQL 14+（本番）

### ハードウェア要件
- CPU: 2コア以上
- メモリ: 4GB以上
- ストレージ: 20GB以上の空き容量

---

## システム要件

### Ubuntuの場合

```bash
# システムパッケージの更新
sudo apt update
sudo apt upgrade -y

# Python3とpip、開発ツールのインストール
sudo apt install -y python3 python3-pip python3-venv git curl

# PostgreSQL（本番環境用）のインストール（任意）
sudo apt install -y postgresql postgresql-contrib

# Python バージョン確認
python3 --version
# Python 3.10.12 以上であることを確認
```

### Windowsの場合（WSL2）

```powershell
# WSL2のインストール（管理者権限で実行）
wsl --install -d Ubuntu-22.04

# WSL2を起動してUbuntuの手順を実行
```

---

## 開発環境セットアップ

### 1. リポジトリのクローン

```bash
# プロジェクトディレクトリに移動
cd /opt
sudo mkdir -p PCSetUpAutomation
sudo chown $USER:$USER PCSetUpAutomation
cd PCSetUpAutomation

# リポジトリをクローン（実際のURLに置き換える）
git clone https://github.com/your-org/pcsetup-automation.git
cd pcsetup-automation
```

### 2. Python仮想環境の作成

```bash
# 仮想環境の作成
python3 -m venv venv

# 仮想環境の有効化
source venv/bin/activate

# 仮想環境が有効化されると、プロンプトに(venv)が表示される
# (venv) user@hostname:~/pcsetup-automation$
```

### 3. 依存パッケージのインストール

```bash
# pipのアップグレード
pip install --upgrade pip

# 依存パッケージのインストール
pip install -r requirements.txt
```

**requirements.txt の内容例**:
```txt
Flask==3.0.0
Flask-SQLAlchemy==3.1.1
Flask-Migrate==4.0.5
Flask-CORS==4.0.0
SQLAlchemy==2.0.23
psycopg2-binary==2.9.9
pytest==7.4.3
pytest-cov==4.1.0
pytest-flask==1.3.0
black==23.11.0
flake8==6.1.0
isort==5.12.0
python-dotenv==1.0.0
requests==2.31.0
PyYAML==6.0.1
```

### 4. 環境変数の設定

```bash
# .envファイルの作成
cat > .env << 'EOF'
# Flask設定
FLASK_APP=app.py
FLASK_ENV=development
FLASK_DEBUG=1
SECRET_KEY=dev-secret-key-change-in-production

# データベース設定（開発環境はSQLite）
DATABASE_URL=sqlite:///dev.db

# 本番環境用PostgreSQL（コメントアウト）
# DATABASE_URL=postgresql://user:password@localhost:5432/pcsetup_db

# API設定
API_TOKEN=dev-api-token-12345
API_TIMEOUT=30

# ログ設定
LOG_LEVEL=DEBUG
LOG_FILE=logs/app.log

# ODJファイル格納パス
ODJ_FILE_PATH=/srv/odj
EOF

# .envファイルの権限設定
chmod 600 .env
```

### 5. ディレクトリ構造の作成

```bash
# 必要なディレクトリの作成
mkdir -p logs
mkdir -p uploads
mkdir -p tests
mkdir -p static/css
mkdir -p static/js
mkdir -p templates
mkdir -p instance

# 権限設定
chmod 755 logs uploads
```

---

## データベース初期化

### SQLite（開発環境）

```bash
# Flask-Migrateの初期化
flask db init

# マイグレーションファイルの作成
flask db migrate -m "Initial migration"

# データベースの作成
flask db upgrade

# データベースファイルの確認
ls -l instance/dev.db
```

### PostgreSQL（本番環境）

```bash
# PostgreSQLユーザーとデータベースの作成
sudo -u postgres psql << EOF
CREATE USER pcsetup_user WITH PASSWORD 'secure_password';
CREATE DATABASE pcsetup_db OWNER pcsetup_user;
GRANT ALL PRIVILEGES ON DATABASE pcsetup_db TO pcsetup_user;
\q
EOF

# .envファイルのDATABASE_URLを更新
# DATABASE_URL=postgresql://pcsetup_user:secure_password@localhost:5432/pcsetup_db

# マイグレーションの実行
flask db upgrade
```

### データベーススキーマの確認

```bash
# SQLiteの場合
sqlite3 instance/dev.db ".schema"

# PostgreSQLの場合
psql -U pcsetup_user -d pcsetup_db -c "\dt"
```

---

## 開発サーバ起動

### 基本的な起動方法

```bash
# 仮想環境が有効化されていることを確認
source venv/bin/activate

# Flaskアプリケーションの起動
flask run

# または
python app.py
```

**出力例**:
```
 * Serving Flask app 'app.py'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment.
 * Running on http://127.0.0.1:5000
Press CTRL+C to quit
```

### ホストとポートの指定

```bash
# すべてのネットワークインターフェースでリッスン
flask run --host=0.0.0.0 --port=5000

# 特定のポートでリッスン
flask run --port=8080
```

### デバッグモードの有効化

```bash
# 環境変数で設定
export FLASK_ENV=development
export FLASK_DEBUG=1
flask run

# または.envファイルに記述（推奨）
```

### 自動リロードの確認

開発モードでは、Pythonファイルを編集すると自動的にサーバーがリロードされます。

```bash
# ログに以下のメッセージが表示される
 * Detected change in 'app.py', reloading
 * Restarting with stat
```

---

## テストデータ投入

### 1. テストデータスクリプトの作成

```bash
# テストデータ投入スクリプト
cat > scripts/seed_data.py << 'EOF'
#!/usr/bin/env python3
"""テストデータ投入スクリプト"""

import sys
sys.path.append('.')

from app import app, db
from models import PCMaster, SetupLog
from datetime import datetime

def seed_data():
    """テストデータを投入"""
    with app.app_context():
        # 既存データのクリア（開発環境のみ）
        db.drop_all()
        db.create_all()

        # テストPC情報
        test_pcs = [
            PCMaster(
                serial='ABC123456',
                pcname='20251116M',
                odj_path='/srv/odj/20251116M.txt',
                created_at=datetime.now()
            ),
            PCMaster(
                serial='DEF789012',
                pcname='20251117M',
                odj_path='/srv/odj/20251117M.txt',
                created_at=datetime.now()
            ),
            PCMaster(
                serial='GHI345678',
                pcname='20251118M',
                odj_path='/srv/odj/20251118M.txt',
                created_at=datetime.now()
            ),
        ]

        # データベースに追加
        for pc in test_pcs:
            db.session.add(pc)

        db.session.commit()
        print(f"✓ {len(test_pcs)}件のテストPCデータを投入しました")

        # テストログデータ
        test_logs = [
            SetupLog(
                serial='ABC123456',
                pcname='20251116M',
                status='completed',
                timestamp=datetime.now(),
                logs='セットアップ完了'
            ),
        ]

        for log in test_logs:
            db.session.add(log)

        db.session.commit()
        print(f"✓ {len(test_logs)}件のテストログデータを投入しました")

if __name__ == '__main__':
    seed_data()
EOF

chmod +x scripts/seed_data.py
```

### 2. テストデータの投入

```bash
# スクリプトの実行
python scripts/seed_data.py

# データの確認
sqlite3 instance/dev.db << EOF
SELECT * FROM pc_master;
SELECT * FROM setup_logs;
EOF
```

### 3. CSVからのインポート

```bash
# テストCSVファイルの作成
cat > test_data.csv << 'EOF'
serial,pcname,odj_path
ABC123456,20251116M,/srv/odj/20251116M.txt
DEF789012,20251117M,/srv/odj/20251117M.txt
GHI345678,20251118M,/srv/odj/20251118M.txt
EOF

# WebUIまたはAPIからCSVをインポート
curl -X POST http://localhost:5000/api/import \
  -F "file=@test_data.csv" \
  -H "Authorization: Bearer dev-api-token-12345"
```

---

## VSCode推奨設定

### 1. 推奨拡張機能

`.vscode/extensions.json`:
```json
{
  "recommendations": [
    "ms-python.python",
    "ms-python.vscode-pylance",
    "ms-python.black-formatter",
    "ms-python.isort",
    "ms-python.flake8",
    "ms-azuretools.vscode-docker",
    "redhat.vscode-yaml",
    "esbenp.prettier-vscode",
    "dbaeumer.vscode-eslint",
    "ms-vscode.powershell"
  ]
}
```

### 2. VSCode設定

`.vscode/settings.json`:
```json
{
  "python.defaultInterpreterPath": "${workspaceFolder}/venv/bin/python",
  "python.linting.enabled": true,
  "python.linting.flake8Enabled": true,
  "python.linting.pylintEnabled": false,
  "python.formatting.provider": "black",
  "python.formatting.blackArgs": ["--line-length", "88"],
  "editor.formatOnSave": true,
  "editor.codeActionsOnSave": {
    "source.organizeImports": true
  },
  "files.exclude": {
    "**/__pycache__": true,
    "**/*.pyc": true,
    "**/.pytest_cache": true,
    "**/venv": true
  },
  "python.testing.pytestEnabled": true,
  "python.testing.pytestArgs": [
    "tests",
    "-v"
  ]
}
```

### 3. デバッグ設定

`.vscode/launch.json`:
```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python: Flask",
      "type": "python",
      "request": "launch",
      "module": "flask",
      "env": {
        "FLASK_APP": "app.py",
        "FLASK_ENV": "development",
        "FLASK_DEBUG": "1"
      },
      "args": [
        "run",
        "--no-debugger",
        "--no-reload"
      ],
      "jinja": true,
      "justMyCode": true
    },
    {
      "name": "Python: Current File",
      "type": "python",
      "request": "launch",
      "program": "${file}",
      "console": "integratedTerminal",
      "justMyCode": true
    }
  ]
}
```

### 4. タスク設定

`.vscode/tasks.json`:
```json
{
  "version": "2.0.0",
  "tasks": [
    {
      "label": "Run Tests",
      "type": "shell",
      "command": "pytest tests/ -v",
      "group": "test",
      "presentation": {
        "reveal": "always",
        "panel": "new"
      }
    },
    {
      "label": "Format Code",
      "type": "shell",
      "command": "black . && isort .",
      "group": "none"
    },
    {
      "label": "Lint Code",
      "type": "shell",
      "command": "flake8 .",
      "group": "none"
    }
  ]
}
```

---

## トラブルシューティング

### 問題1: 仮想環境が有効化されない

**症状**:
```bash
source venv/bin/activate
# プロンプトに(venv)が表示されない
```

**解決策**:
```bash
# 仮想環境を再作成
rm -rf venv
python3 -m venv venv
source venv/bin/activate

# bashの場合
source venv/bin/activate

# fishの場合
source venv/bin/activate.fish
```

### 問題2: Flask アプリケーションが起動しない

**症状**:
```
Error: Could not locate a Flask application.
```

**解決策**:
```bash
# FLASK_APP環境変数を設定
export FLASK_APP=app.py

# または.envファイルを確認
cat .env | grep FLASK_APP

# .envファイルが読み込まれているか確認
pip install python-dotenv
```

### 問題3: データベース接続エラー

**症状**:
```
sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) unable to open database file
```

**解決策**:
```bash
# instanceディレクトリのパーミッション確認
ls -ld instance/
chmod 755 instance/

# データベースファイルの確認
ls -l instance/dev.db

# データベースを再作成
rm instance/dev.db
flask db upgrade
```

### 問題4: ポート5000が既に使用されている

**症状**:
```
OSError: [Errno 98] Address already in use
```

**解決策**:
```bash
# ポートを使用しているプロセスを確認
sudo lsof -i :5000

# プロセスを終了
kill -9 <PID>

# または別のポートを使用
flask run --port=8080
```

### 問題5: モジュールがインポートできない

**症状**:
```
ModuleNotFoundError: No module named 'flask'
```

**解決策**:
```bash
# 仮想環境が有効化されているか確認
which python
# /path/to/venv/bin/python が表示されるべき

# 依存パッケージを再インストール
pip install -r requirements.txt

# インストール済みパッケージの確認
pip list
```

### 問題6: マイグレーションエラー

**症状**:
```
Error: Can't locate revision identified by 'xxxxx'
```

**解決策**:
```bash
# マイグレーション履歴の確認
flask db history

# マイグレーションをリセット（開発環境のみ）
rm -rf migrations/
rm instance/dev.db
flask db init
flask db migrate -m "Initial migration"
flask db upgrade
```

### 問題7: APIトークンエラー

**症状**:
```
401 Unauthorized: Invalid API token
```

**解決策**:
```bash
# .envファイルのAPI_TOKENを確認
cat .env | grep API_TOKEN

# curlでトークンを指定
curl -H "Authorization: Bearer dev-api-token-12345" \
  http://localhost:5000/api/pcinfo?serial=ABC123456
```

### 問題8: 静的ファイルが読み込まれない

**症状**:
```
404 Not Found: /static/css/style.css
```

**解決策**:
```bash
# 静的ファイルディレクトリの確認
ls -la static/css/

# Flaskの静的ファイル設定を確認（app.py）
# app = Flask(__name__, static_folder='static', static_url_path='/static')
```

### ログの確認方法

```bash
# アプリケーションログ
tail -f logs/app.log

# Flaskの開発サーバーログ
# コンソールに直接出力される

# データベースクエリログ（SQLAlchemy）
# .envファイルに追加
echo "SQLALCHEMY_ECHO=True" >> .env
```

---

## 次のステップ

開発環境が正常に構築できたら、以下のドキュメントを参照してください：

1. **コーディング規約.md** - コーディングスタイルと規約
2. **API仕様書.md** - REST API の詳細仕様
3. **データベースアクセス規約.md** - データベース操作のベストプラクティス

---

## 参考リンク

- [Flask公式ドキュメント](https://flask.palletsprojects.com/)
- [SQLAlchemy公式ドキュメント](https://www.sqlalchemy.org/)
- [pytest公式ドキュメント](https://docs.pytest.org/)
- [Python公式スタイルガイド (PEP 8)](https://peps.python.org/pep-0008/)
