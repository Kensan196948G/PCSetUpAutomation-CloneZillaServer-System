# ネットワーク構成手順

## 目次
1. [ネットワーク設計概要](#ネットワーク設計概要)
2. [IPアドレス設計](#ipアドレス設計)
3. [VLAN設定](#vlan設定)
4. [スイッチ設定](#スイッチ設定)
5. [マルチキャスト設定](#マルチキャスト設定)
6. [DHCPスコープ設定](#dhcpスコープ設定)
7. [疎通確認](#疎通確認)
8. [トラブルシューティング](#トラブルシューティング)

---

## ネットワーク設計概要

### ネットワーク構成図

```
[インターネット]
      |
[ルーター] 192.168.1.1
      |
[L2スイッチ] (VLAN対応)
      |
      +--- VLAN 1 (管理VLAN) 192.168.1.0/24
      |      |
      |      +--- DRBLサーバー: 192.168.1.100
      |      +--- 管理PC: 192.168.1.10
      |
      +--- VLAN 10 (キッティングVLAN) 192.168.10.0/24
             |
             +--- DRBLサーバー: 192.168.10.1 (セカンダリIP)
             +--- クライアントPC: 192.168.10.100-199 (DHCP)
```

### 設計方針

1. **VLAN分離**: キッティング専用VLANを設ける（セキュリティ・パフォーマンス向上）
2. **マルチキャスト対応**: 高速展開のためIGMP Snooping有効化
3. **帯域確保**: ギガビットイーサネット必須、ジャンボフレーム推奨
4. **冗長性**: DRBLサーバーは2NIC構成（管理用・配信用）

---

## IPアドレス設計

### アドレス割り当て表

#### VLAN 1 (管理VLAN)
| 用途 | IPアドレス | サブネットマスク | ゲートウェイ |
|------|-----------|----------------|-------------|
| ルーター | 192.168.1.1 | 255.255.255.0 | - |
| DRBLサーバー | 192.168.1.100 | 255.255.255.0 | 192.168.1.1 |
| 管理PC | 192.168.1.10 | 255.255.255.0 | 192.168.1.1 |
| 予備（静的割当） | 192.168.1.2-50 | 255.255.255.0 | 192.168.1.1 |

#### VLAN 10 (キッティングVLAN)
| 用途 | IPアドレス | サブネットマスク | ゲートウェイ |
|------|-----------|----------------|-------------|
| DRBLサーバー | 192.168.10.1 | 255.255.255.0 | - |
| クライアント(DHCP) | 192.168.10.100-199 | 255.255.255.0 | 192.168.10.1 |

### アドレス設計のポイント

```bash
# VLAN 1 (管理VLAN): 192.168.1.0/24
Network:   192.168.1.0
Broadcast: 192.168.1.255
Usable:    192.168.1.1 - 192.168.1.254 (254台)

# VLAN 10 (キッティングVLAN): 192.168.10.0/24
Network:   192.168.10.0
Broadcast: 192.168.10.255
Usable:    192.168.10.1 - 192.168.10.254 (254台)
DHCPスコープ: 192.168.10.100 - 192.168.10.199 (100台)
```

---

## VLAN設定

### 1. VLAN設計

```
VLAN ID 1   : 管理VLAN（デフォルト）
VLAN ID 10  : キッティングVLAN
VLAN ID 99  : 未使用ポート用（セキュリティ）
```

### 2. DRBLサーバーのネットワーク設定

#### 2つのNICを使用する場合（推奨）

```bash
# ネットワークインターフェース確認
ip addr show

# 想定:
# ens33: 管理用 (VLAN 1)
# ens34: キッティング用 (VLAN 10)
```

**Netplan設定** (`/etc/netplan/00-installer-config.yaml`):
```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    # 管理用NIC (VLAN 1)
    ens33:
      dhcp4: no
      addresses:
        - 192.168.1.100/24
      routes:
        - to: default
          via: 192.168.1.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4

    # キッティング用NIC (VLAN 10)
    ens34:
      dhcp4: no
      addresses:
        - 192.168.10.1/24
```

```bash
# 設定適用
sudo netplan apply

# 確認
ip addr show
```

#### 1つのNICでVLANタグを使用する場合

```yaml
network:
  version: 2
  renderer: networkd
  ethernets:
    ens33:
      dhcp4: no

  vlans:
    # VLAN 1 (管理)
    vlan1:
      id: 1
      link: ens33
      addresses:
        - 192.168.1.100/24
      routes:
        - to: default
          via: 192.168.1.1
      nameservers:
        addresses:
          - 8.8.8.8

    # VLAN 10 (キッティング)
    vlan10:
      id: 10
      link: ens33
      addresses:
        - 192.168.10.1/24
```

```bash
# 設定適用
sudo netplan apply

# VLAN確認
ip -d link show | grep vlan
```

---

## スイッチ設定

### 1. 対応スイッチの選定

**必須要件**:
- ギガビットイーサネット (1Gbps以上)
- VLAN対応
- IGMP Snooping対応
- マネージドスイッチ（推奨）

**推奨機種例**:
- Cisco Catalyst 1000シリーズ
- Netgear GS3xxシリーズ
- TP-Link TL-SG3xxシリーズ
- Buffalo BS-GSシリーズ

### 2. VLAN設定（Cisco Catalyst例）

```cisco
! VLANの作成
vlan 1
  name Management
vlan 10
  name Kitting
vlan 99
  name Unused

! トランクポート設定（DRBLサーバー接続ポート）
interface GigabitEthernet0/1
  description DRBL Server
  switchport mode trunk
  switchport trunk allowed vlan 1,10
  spanning-tree portfast trunk

! アクセスポート設定（クライアントPC接続ポート）
interface range GigabitEthernet0/2-24
  description Client PCs
  switchport mode access
  switchport access vlan 10
  spanning-tree portfast

! 管理ポート
interface GigabitEthernet0/25
  description Management PC
  switchport mode access
  switchport access vlan 1

! 管理IPアドレス設定
interface Vlan1
  ip address 192.168.1.2 255.255.255.0
  no shutdown

! デフォルトゲートウェイ
ip default-gateway 192.168.1.1

! 設定保存
write memory
```

### 3. VLAN設定（Netgear例）

**WebGUIでの設定手順**:

1. **VLANの作成**
   - VLAN → 802.1Q → VLAN Configuration
   - VLAN ID: 10, Name: Kitting を追加

2. **ポートVLAN設定**
   - VLAN → 802.1Q → Port PVID Configuration
   - Port 1: PVID 1 (Trunk)
   - Port 2-24: PVID 10 (Access)

3. **VLANメンバーシップ設定**
   - VLAN → 802.1Q → VLAN Membership
   - VLAN 1: Port 1 (T), Port 25 (U)
   - VLAN 10: Port 1 (T), Port 2-24 (U)
   - T=Tagged, U=Untagged

---

## マルチキャスト設定

### 1. IGMP Snooping有効化

**Cisco Catalyst**:
```cisco
! IGMP Snooping グローバル有効化
ip igmp snooping

! VLAN単位で有効化
ip igmp snooping vlan 10

! クエリア設定（オプション）
ip igmp snooping vlan 10 querier address 192.168.10.1

! 確認
show ip igmp snooping
show ip igmp snooping groups
```

**Netgear**:
```
WebGUI手順:
1. Switching → Multicast → IGMP Snooping
2. IGMP Snooping Status: Enable
3. VLAN ID: 10 → Enable
4. Apply
```

### 2. マルチキャストアドレス設定

```bash
# DRBLサーバーで使用するマルチキャストアドレス
# 239.0.0.1 - 239.255.255.255 (ローカルスコープ)

# Clonezillaのデフォルト設定確認
cat /etc/drbl/drbl.conf | grep MULTICAST
```

### 3. マルチキャスト動作確認

```bash
# DRBLサーバー側
# マルチキャストグループへの参加確認
netstat -g
ip maddr show

# マルチキャストルート確認
ip mroute show

# マルチキャスト送信テスト（iperf使用）
# サーバー側
iperf -s -u -B 239.0.0.100 -i 1

# クライアント側
iperf -c 239.0.0.100 -u -T 32 -t 30
```

### 4. スイッチのマルチキャスト統計確認

```cisco
! Cisco
show ip igmp snooping groups
show ip igmp snooping statistics

! 出力例:
! VLAN 10:
!   Group: 239.0.0.1
!   Ports: Gi0/2, Gi0/3, Gi0/4...
```

---

## DHCPスコープ設定

### 1. DHCP設定ファイル

```bash
# /etc/dhcp/dhcpd.conf の編集
sudo vim /etc/dhcp/dhcpd.conf
```

**VLAN対応DHCP設定**:
```conf
# グローバル設定
option domain-name "kitting.local";
option domain-name-servers 8.8.8.8, 8.8.4.4;

default-lease-time 600;
max-lease-time 7200;

# DHCPサーバーを権威サーバーとして設定
authoritative;

# PXEブート用設定
allow booting;
allow bootp;

# ----- VLAN 1 (管理VLAN) -----
subnet 192.168.1.0 netmask 255.255.255.0 {
    # DHCPスコープ（静的割当推奨）
    range 192.168.1.51 192.168.1.99;

    option routers 192.168.1.1;
    option subnet-mask 255.255.255.0;
    option broadcast-address 192.168.1.255;
}

# ----- VLAN 10 (キッティングVLAN) -----
subnet 192.168.10.0 netmask 255.255.255.0 {
    # DHCPスコープ（100台分）
    range 192.168.10.100 192.168.10.199;

    # ゲートウェイ（DRBLサーバー）
    option routers 192.168.10.1;
    option subnet-mask 255.255.255.0;
    option broadcast-address 192.168.10.255;

    # PXEブート設定
    next-server 192.168.10.1;
    filename "pxelinux.0";

    # リース時間（短め）
    default-lease-time 300;
    max-lease-time 600;
}

# ----- 固定IPアドレス割り当て（例） -----
host test-pc-01 {
    hardware ethernet 00:11:22:33:44:55;
    fixed-address 192.168.10.50;
    option host-name "test-pc-01";
}
```

### 2. DHCPリレー設定（VLAN間通信が必要な場合）

```bash
# dhcp-helper のインストール
sudo apt install -y dhcp-helper

# 設定ファイル編集
sudo vim /etc/default/dhcp-helper
```

**設定内容**:
```bash
DHCPHELPER_OPTS="-b /usr/sbin/dhcp-helper -s 192.168.1.100"
```

```bash
# サービス再起動
sudo systemctl restart dhcp-helper
```

### 3. DHCPインターフェース設定

```bash
# /etc/default/isc-dhcp-server の編集
sudo vim /etc/default/isc-dhcp-server
```

**複数NIC対応**:
```bash
# 両方のインターフェースでDHCPを提供
INTERFACESv4="ens33 ens34"

# または VLAN インターフェース
INTERFACESv4="vlan1 vlan10"
```

```bash
# DHCP再起動
sudo systemctl restart isc-dhcp-server
```

---

## 疎通確認

### 1. サーバー側の確認

```bash
# ネットワークインターフェース確認
ip addr show

# 期待される出力:
# ens33: 192.168.1.100/24
# ens34: 192.168.10.1/24

# ルーティングテーブル確認
ip route show

# 出力例:
# default via 192.168.1.1 dev ens33
# 192.168.1.0/24 dev ens33 proto kernel scope link src 192.168.1.100
# 192.168.10.0/24 dev ens34 proto kernel scope link src 192.168.10.1
```

### 2. VLAN間通信確認

```bash
# 管理VLAN (192.168.1.0/24) から疎通確認
ping -c 4 192.168.1.1      # ゲートウェイ
ping -c 4 192.168.1.100    # DRBLサーバー (管理IP)
ping -c 4 8.8.8.8          # インターネット

# キッティングVLAN (192.168.10.0/24) から疎通確認
ping -I ens34 -c 4 192.168.10.1   # DRBLサーバー (キッティングIP)
```

### 3. DHCPリース確認

```bash
# DHCPリース状況確認
sudo cat /var/lib/dhcp/dhcpd.leases

# 現在のリース一覧
sudo dhcp-lease-list

# または
sudo grep "DHCPACK" /var/log/syslog
```

### 4. マルチキャスト疎通確認

```bash
# マルチキャストグループへの参加
ip maddr add 239.0.0.100 dev ens34

# マルチキャスト送信テスト（iperf）
# 送信側
iperf -c 239.0.0.100 -u -T 32 -t 10 -b 100M

# 受信側（別のPC）
iperf -s -u -B 239.0.0.100 -i 1
```

### 5. 統合疎通確認スクリプト

```bash
#!/bin/bash
# ネットワーク疎通確認スクリプト

echo "=== Network Connectivity Check ==="

# 管理VLAN疎通確認
echo "1. Management VLAN (192.168.1.0/24)"
ping -c 2 192.168.1.1 > /dev/null 2>&1 && echo "  Gateway: OK" || echo "  Gateway: NG"
ping -c 2 8.8.8.8 > /dev/null 2>&1 && echo "  Internet: OK" || echo "  Internet: NG"

# キッティングVLAN疎通確認
echo "2. Kitting VLAN (192.168.10.0/24)"
ping -I ens34 -c 2 192.168.10.1 > /dev/null 2>&1 && echo "  DRBL Server: OK" || echo "  DRBL Server: NG"

# DHCP確認
echo "3. DHCP Service"
systemctl is-active isc-dhcp-server > /dev/null 2>&1 && echo "  DHCP Server: OK" || echo "  DHCP Server: NG"

# マルチキャスト確認
echo "4. Multicast Support"
ip maddr show | grep -q "239" && echo "  Multicast Groups: OK" || echo "  Multicast Groups: NG"

echo "=== Check Complete ==="
```

---

## スイッチポート設定まとめ

### ポート割り当て表（例）

| ポート番号 | 接続先 | VLAN | モード | 速度 | 備考 |
|-----------|--------|------|------|------|------|
| Gi0/1 | DRBLサーバー | 1, 10 | Trunk | 1Gbps | 管理+キッティング |
| Gi0/2-24 | クライアントPC | 10 | Access | 1Gbps | キッティング専用 |
| Gi0/25 | 管理PC | 1 | Access | 1Gbps | 管理専用 |
| Gi0/26 | ルーター | 1 | Access | 1Gbps | アップリンク |

### Cisco設定サマリー

```cisco
! 基本設定
hostname Switch-Kitting
enable secret cisco123

! VLAN作成
vlan 1
  name Management
vlan 10
  name Kitting

! トランクポート（DRBLサーバー）
interface GigabitEthernet0/1
  switchport mode trunk
  switchport trunk allowed vlan 1,10
  spanning-tree portfast trunk

! アクセスポート（クライアント）
interface range GigabitEthernet0/2-24
  switchport mode access
  switchport access vlan 10
  spanning-tree portfast

! IGMP Snooping
ip igmp snooping
ip igmp snooping vlan 10

! 設定保存
write memory
```

---

## 帯域最適化

### 1. ジャンボフレーム設定（オプション）

```bash
# DRBLサーバーでMTU変更
sudo ip link set dev ens34 mtu 9000

# 永続化（Netplan）
# /etc/netplan/00-installer-config.yaml
```

```yaml
network:
  ethernets:
    ens34:
      mtu: 9000
      addresses:
        - 192.168.10.1/24
```

**スイッチ側設定**:
```cisco
! Cisco
system mtu jumbo 9000

! または各インターフェースで
interface range GigabitEthernet0/1-24
  mtu 9000
```

### 2. フロー制御有効化

```cisco
! Cisco
interface range GigabitEthernet0/1-24
  flowcontrol receive on
  flowcontrol send on
```

### 3. QoS設定（オプション）

```cisco
! マルチキャストトラフィックに優先度を付与
class-map match-all MULTICAST
  match access-group name MULTICAST-ACL

policy-map KITTING-QOS
  class MULTICAST
    set dscp af41
    bandwidth percent 80

interface range GigabitEthernet0/2-24
  service-policy output KITTING-QOS

ip access-list extended MULTICAST-ACL
  permit ip any 239.0.0.0 0.255.255.255
```

---

## トラブルシューティング

### 問題1: VLANタグが通らない

**原因**: トランクポート設定が正しくない

**解決策**:
```cisco
! スイッチ設定確認
show interface GigabitEthernet0/1 switchport
show vlan

! トランクポートの再設定
interface GigabitEthernet0/1
  switchport trunk encapsulation dot1q
  switchport mode trunk
  switchport trunk allowed vlan 1,10
```

### 問題2: マルチキャストが届かない

**原因**: IGMP Snooping設定漏れ

**解決策**:
```cisco
! IGMP Snooping確認
show ip igmp snooping
show ip igmp snooping groups vlan 10

! 再設定
ip igmp snooping
ip igmp snooping vlan 10
```

### 問題3: DHCPリースが取得できない

**原因**: VLAN間でDHCPリクエストが届かない

**解決策**:
```bash
# DHCPリレー設定
sudo apt install -y isc-dhcp-relay

# 設定
sudo vim /etc/default/isc-dhcp-relay
# SERVERS="192.168.10.1"
# INTERFACES="ens33 ens34"

sudo systemctl restart isc-dhcp-relay
```

### 問題4: スループットが低い

**原因**: デュプレックスミスマッチ、MTU設定

**解決策**:
```bash
# リンク状態確認
ethtool ens34

# 出力:
# Speed: 1000Mb/s
# Duplex: Full

# デュプレックス強制設定
sudo ethtool -s ens34 speed 1000 duplex full autoneg off
```

---

## ネットワーク監視

### 1. 帯域使用状況監視

```bash
# iftop インストール
sudo apt install -y iftop

# リアルタイム監視
sudo iftop -i ens34

# bmon（帯域モニター）
sudo apt install -y bmon
sudo bmon -p ens34
```

### 2. パケットキャプチャ

```bash
# tcpdump でマルチキャストトラフィック確認
sudo tcpdump -i ens34 -n host 239.0.0.100

# wireshark インストール（GUI）
sudo apt install -y wireshark
```

### 3. SNMP監視（スイッチ）

```cisco
! Cisco SNMP設定
snmp-server community public RO
snmp-server location "Kitting Room"
snmp-server contact "admin@company.com"
```

```bash
# SNMP確認（Linuxから）
sudo apt install -y snmp snmp-mibs-downloader
snmpwalk -v2c -c public 192.168.1.2 system
```

---

## 参考資料

- [IEEE 802.1Q VLAN Tagging](https://www.ieee802.org/1/pages/802.1Q.html)
- [IGMP Snooping Best Practices](https://www.cisco.com/c/en/us/support/docs/ip/internet-group-management-protocol-igmp/13678-20.html)
- [Multicast Routing Configuration Guide](https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/ipmulti/configuration/15-mt/imc-15-mt-book.html)
