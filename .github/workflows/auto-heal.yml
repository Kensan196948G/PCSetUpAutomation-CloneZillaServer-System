name: Auto Error Detection & Healing System

on:
  # 30åˆ†é–“éš”ã§è‡ªå‹•å®Ÿè¡Œ
  schedule:
    - cron: '*/30 * * * *'  # 30åˆ†ã”ã¨ã«å®Ÿè¡Œ

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      max_iterations:
        description: 'æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°'
        required: false
        default: '15'

  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã‚‚å®Ÿè¡Œ
  push:
    branches:
      - main
      - develop

  # PRæ™‚ã‚‚å®Ÿè¡Œ
  pull_request:
    branches:
      - main

env:
  MAX_HEAL_ITERATIONS: 15
  PYTHON_VERSION: '3.12'

jobs:
  auto-heal:
    name: è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ 
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      # ===================================================
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—2: Pythonç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      # ===================================================
      - name: ğŸ Pythonç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—3: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ===================================================
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          python -m pip install --upgrade pip
          pip install -r flask-app/requirements.txt
          pip install -r flask-app/requirements-test.txt
          pip install flake8 pylint black pytest pytest-cov

      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—4: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆæœ€å¤§15å›ï¼‰
      # ===================================================
      - name: ğŸ”„ è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ãƒ«ãƒ¼ãƒ—ï¼ˆ15å›ã¾ã§ï¼‰
        id: auto_heal
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== è‡ªå‹•ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹ ==="
          echo "æœ€å¤§åå¾©å›æ•°: ${{ github.event.inputs.max_iterations || env.MAX_HEAL_ITERATIONS }}"

          # ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          python .github/scripts/auto_heal.py \
            --max-iterations ${{ github.event.inputs.max_iterations || env.MAX_HEAL_ITERATIONS }} \
            --github-token "${{ secrets.GITHUB_TOKEN }}" \
            --repo "${{ github.repository }}" \
            --run-id "${{ github.run_id }}" \
            --actor "${{ github.actor }}"

      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—5: ä¿®å¾©çµæœã®ã‚µãƒãƒªãƒ¼è¡¨ç¤º
      # ===================================================
      - name: ğŸ“Š ä¿®å¾©çµæœã‚µãƒãƒªãƒ¼
        if: always()
        run: |
          if [ -f auto_heal_summary.json ]; then
            echo "=== ä¿®å¾©çµæœã‚µãƒãƒªãƒ¼ ==="
            cat auto_heal_summary.json | jq '.'

            # çµæœã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
            echo "TOTAL_ERRORS=$(cat auto_heal_summary.json | jq -r '.total_errors')" >> $GITHUB_ENV
            echo "FIXED_ERRORS=$(cat auto_heal_summary.json | jq -r '.fixed_errors')" >> $GITHUB_ENV
            echo "REMAINING_ERRORS=$(cat auto_heal_summary.json | jq -r '.remaining_errors')" >> $GITHUB_ENV

            # ãƒ‡ãƒãƒƒã‚°: ç’°å¢ƒå¤‰æ•°ã‚’è¡¨ç¤º
            echo "=== ç’°å¢ƒå¤‰æ•°ç¢ºèª ==="
            echo "TOTAL_ERRORS: $(cat auto_heal_summary.json | jq -r '.total_errors')"
            echo "FIXED_ERRORS: $(cat auto_heal_summary.json | jq -r '.fixed_errors')"
            echo "REMAINING_ERRORS: $(cat auto_heal_summary.json | jq -r '.remaining_errors')"
          fi

      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—6: ä¿®å¾©ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥
      # ===================================================
      - name: ğŸ’¾ ä¿®å¾©ã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒŸãƒƒãƒˆ
        if: env.FIXED_ERRORS != '0' && env.FIXED_ERRORS != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add -A

          git commit -m "fix: è‡ªå‹•ã‚¨ãƒ©ãƒ¼ä¿®å¾© - ${{ env.FIXED_ERRORS }}å€‹ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£

          ## ğŸ”§ è‡ªå‹•ä¿®å¾©å†…å®¹

          è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€æœªä½¿ç”¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‰Šé™¤ã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆä¿®æ­£ç­‰

          ## ğŸ“Š çµ±è¨ˆ

          - æ¤œå‡ºã‚¨ãƒ©ãƒ¼: ${{ env.TOTAL_ERRORS }}å€‹
          - ä¿®å¾©æ¸ˆã¿: ${{ env.FIXED_ERRORS }}å€‹
          - æ®‹å­˜ã‚¨ãƒ©ãƒ¼: ${{ env.REMAINING_ERRORS }}å€‹

          ğŸ¤– Auto-healed by GitHub Actions

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git push

      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—7: ä¿®å¾©ã§ããªã‹ã£ãŸã‚¨ãƒ©ãƒ¼ã®Issueä½œæˆ/æ›´æ–°
      # ===================================================
      - name: ğŸ› æœªä¿®å¾©ã‚¨ãƒ©ãƒ¼ã®Issueä½œæˆ/æ›´æ–°
        if: always() && env.REMAINING_ERRORS != '' && env.REMAINING_ERRORS != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('auto_heal_summary.json', 'utf8'));

            // æ—¢å­˜ã® auto-heal Issueã‚’æ¤œç´¢
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'auto-heal,bug',
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 10
            });

            // ãƒ†ã‚¹ãƒˆç”¨Issueã‚’é™¤å¤–ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã«"TEST"ãŒå«ã¾ã‚Œãªã„ã‚‚ã®ï¼‰
            const healIssues = existingIssues.data.filter(
              issue => !issue.title.includes('[TEST]') && issue.title.includes('è‡ªå‹•ä¿®å¾©å¤±æ•—')
            );

            const timestamp = new Date().toISOString();
            const runUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            // ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’ä½œæˆï¼ˆæœ€å¤§10ä»¶ã¾ã§è¡¨ç¤ºï¼‰
            const errorDetails = summary.remaining_error_details
              .slice(0, 10)
              .map((err, idx) => `
            ### ã‚¨ãƒ©ãƒ¼ ${idx + 1}: ${err.type}
            - **ãƒ•ã‚¡ã‚¤ãƒ«**: \`${err.file}\`
            - **è¡Œ**: ${err.line}
            - **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: \`${err.message}\`
            - **ä¿®å¾©è©¦è¡Œ**: ${err.fix_attempts}å›
            `).join('\n');

            const additionalCount = summary.remaining_error_details.length > 10
              ? `\n> ...ä»– ${summary.remaining_error_details.length - 10} ä»¶ã®ã‚¨ãƒ©ãƒ¼`
              : '';

            if (healIssues.length > 0) {
              // æ—¢å­˜IssueãŒã‚ã‚‹å ´åˆ: ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
              const issueNumber = healIssues[0].number;
              console.log(`æ—¢å­˜Issue #${issueNumber} ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™`);

              const commentBody = `## ğŸ”„ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ

            **å®Ÿè¡Œæ—¥æ™‚**: ${timestamp}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: [Run #${{ github.run_id }}](${runUrl})

            ### ğŸ“Š çµ±è¨ˆ
            | é …ç›® | æ•° |
            |------|-----|
            | æ¤œå‡ºã‚¨ãƒ©ãƒ¼ | ${summary.total_errors}å€‹ |
            | ä»Šå›ä¿®å¾© | ${summary.fixed_errors}å€‹ |
            | **æ®‹å­˜ã‚¨ãƒ©ãƒ¼** | **${summary.remaining_errors}å€‹** |
            | åå¾©å›æ•° | ${summary.iterations}å› |

            ### âŒ æ®‹å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆä¸Šä½10ä»¶ï¼‰
            ${errorDetails}
            ${additionalCount}

            ---
            ğŸ¤– Auto-updated by GitHub Actions (æ¬¡å›å®Ÿè¡Œ: 30åˆ†å¾Œ)`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: commentBody
              });

              // ã‚¿ã‚¤ãƒˆãƒ«ã‚‚æ›´æ–°ï¼ˆã‚¨ãƒ©ãƒ¼æ•°ãŒå¤‰ã‚ã£ãŸå ´åˆï¼‰
              const newTitle = `ğŸš¨ è‡ªå‹•ä¿®å¾©å¤±æ•— - ${summary.remaining_errors}å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒæ®‹å­˜`;
              if (healIssues[0].title !== newTitle) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  title: newTitle
                });
              }

            } else {
              // æ—¢å­˜IssueãŒãªã„å ´åˆ: æ–°è¦ä½œæˆ
              console.log('æ–°è¦Issueã‚’ä½œæˆã—ã¾ã™');

              const issueBody = `## ğŸš¨ è‡ªå‹•ä¿®å¾©ã§ããªã‹ã£ãŸã‚¨ãƒ©ãƒ¼

            **åˆå›æ¤œå‡ºæ—¥æ™‚**: ${timestamp}
            **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ**: [Run #${{ github.run_id }}](${runUrl})

            ---

            ## ğŸ“Š çµ±è¨ˆ

            | é …ç›® | æ•° |
            |------|-----|
            | ç·ã‚¨ãƒ©ãƒ¼æ•° | ${summary.total_errors}å€‹ |
            | ä¿®å¾©æ¸ˆã¿ | ${summary.fixed_errors}å€‹ |
            | **æœªä¿®å¾©** | **${summary.remaining_errors}å€‹** |
            | åå¾©å›æ•° | ${summary.iterations}å› |

            ---

            ## âŒ æœªä¿®å¾©ã‚¨ãƒ©ãƒ¼ä¸€è¦§ï¼ˆä¸Šä½10ä»¶ï¼‰
            ${errorDetails}
            ${additionalCount}

            ---

            ## ğŸ”§ æ¨å¥¨å¯¾å¿œ

            1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã‚¨ãƒ©ãƒ¼ã‚’å†ç¾
            2. æ‰‹å‹•ã§ä¿®æ­£
            3. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            4. ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥

            ã¾ãŸã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ä¿®å¾©ã‚’è©¦è¡Œï¼š
            \`\`\`bash
            /mcp-code-quality
            /mcp-refactor
            \`\`\`

            ---

            > ğŸ“ ã“ã®Issueã¯30åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ã•ã‚Œã¾ã™ã€‚
            > å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ãŒä¿®å¾©ã•ã‚Œã‚‹ã¨è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚

            ğŸ¤– Auto-generated by GitHub Actions`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ è‡ªå‹•ä¿®å¾©å¤±æ•— - ${summary.remaining_errors}å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒæ®‹å­˜`,
                body: issueBody,
                labels: ['auto-heal', 'bug', 'automated']
              });
            }

      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—8: æˆåŠŸæ™‚ã®Issueã‚³ãƒ¡ãƒ³ãƒˆ
      # ===================================================
      - name: âœ… æˆåŠŸæ™‚ã®Issueæ›´æ–°
        if: env.REMAINING_ERRORS == '0' && env.FIXED_ERRORS != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('auto_heal_summary.json', 'utf8'));

            // æœ€æ–°ã®è‡ªå‹•ä¿®å¾©é–¢é€£Issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'auto-heal',
              state: 'open',
              sort: 'created',
              direction: 'desc',
              per_page: 5
            });

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `âœ… **è‡ªå‹•ä¿®å¾©æˆåŠŸ**

                å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ãŒä¿®å¾©ã•ã‚Œã¾ã—ãŸï¼

                - ä¿®å¾©ã‚¨ãƒ©ãƒ¼æ•°: ${summary.fixed_errors}å€‹
                - åå¾©å›æ•°: ${summary.iterations}å›
                - å®Ÿè¡Œæ™‚åˆ»: ${new Date().toISOString()}

                ã“ã®Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™ã€‚

                ğŸ¤– Auto-resolved by GitHub Actions`
              });

              // Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }

      # ===================================================
      # ã‚¹ãƒ†ãƒƒãƒ—9: ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      # ===================================================
      - name: ğŸ“¤ ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-heal-report-${{ github.run_id }}
          path: |
            auto_heal_summary.json
            auto_heal_detailed.log
            auto_heal_fixes.patch
          retention-days: 30

  # ===================================================
  # Job 2: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  # ===================================================
  health-check:
    name: ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ Pythonç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pip install -r flask-app/requirements.txt
          pip install -r flask-app/requirements-test.txt

      - name: ğŸ¥ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        run: |
          echo "=== ã‚·ã‚¹ãƒ†ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ==="

          # 1. Pythonæ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          python -m py_compile flask-app/**/*.py || true

          # 2. Lintãƒã‚§ãƒƒã‚¯
          flake8 flask-app/ --count --select=E9,F63,F7,F82 --show-source --statistics || true

          # 3. ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
          pytest tests/ --maxfail=5 --tb=short || true

          # 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          pip install bandit
          bandit -r flask-app/ -ll || true

          # 5. ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯
          pip install safety
          safety check --json || true

      - name: ğŸ“Š ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
        if: always()
        run: |
          echo "ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Œäº†" > health_report.txt
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date)" >> health_report.txt

      - name: ğŸ“¤ ãƒ˜ãƒ«ã‚¹ãƒ¬ãƒãƒ¼ãƒˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: health-report-${{ github.run_id }}
          path: health_report.txt
          retention-days: 7
