# インターフェース設計書

**文書番号**: IF-001
**バージョン**: 1.0
**作成日**: 2025-11-17
**最終更新日**: 2025-11-17

---

## 1. 概要

本書は、会社キッティング自動化フレームワークのインターフェース設計を定義します。REST API、Web画面、ファイル形式の詳細仕様を記載します。

### 1.1 インターフェース分類

| 分類 | 種類 | 用途 |
|------|------|------|
| REST API | HTTP/JSON | クライアントPC ⇔ DRBLサーバ通信 |
| Web UI | HTML/CSS/JS | 管理者 ⇔ Flask管理アプリ |
| ファイル | CSV/XML/TXT | データ交換（CSV一括登録、ODJ、unattend.xml） |

---

## 2. REST API仕様

### 2.1 API概要

**ベースURL**: `http://10.100.0.10:5000/api`

**認証方式**: HTTP Basic認証（社内LANのみ、将来的にToken認証検討）

**データ形式**: JSON

**文字エンコーディング**: UTF-8

**HTTPメソッド**:
- GET: データ取得
- POST: データ登録・更新

### 2.2 共通仕様

#### 2.2.1 リクエストヘッダー

```http
GET /api/pcinfo?serial=ABC123456 HTTP/1.1
Host: 10.100.0.10:5000
Authorization: Basic YXBpX3VzZXI6c2VjdXJlX3Bhc3N3b3Jk
Accept: application/json
User-Agent: PowerShell/7.0 (Windows 11)
```

#### 2.2.2 レスポンスヘッダー

```http
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Server: Werkzeug/3.0.0 Python/3.10.12
Date: Sat, 16 Nov 2025 05:30:22 GMT
Content-Length: 87
```

#### 2.2.3 エラーレスポンス形式

すべてのエラーは以下の統一フォーマットで返却されます。

```json
{
  "error": "エラーメッセージ",
  "error_code": "ERROR_CODE",
  "details": "詳細情報（任意）",
  "timestamp": "2025-11-16T14:30:22Z"
}
```

**HTTPステータスコード**:

| コード | 意味 | 用途 |
|--------|------|------|
| 200 | OK | 成功 |
| 201 | Created | リソース作成成功 |
| 400 | Bad Request | リクエストパラメータ不正 |
| 401 | Unauthorized | 認証失敗 |
| 404 | Not Found | リソース未発見 |
| 500 | Internal Server Error | サーバエラー |
| 503 | Service Unavailable | サービス停止中 |

---

### 2.3 GET /api/pcinfo（PC情報取得）

**用途**: Serial番号からPC名とODJファイルパスを取得

#### リクエスト

**エンドポイント**: `GET /api/pcinfo`

**クエリパラメータ**:

| パラメータ名 | 型 | 必須 | 説明 |
|--------------|-----|------|------|
| serial | string | Yes | PCのBIOS Serial番号 |

**リクエスト例**:
```http
GET /api/pcinfo?serial=ABC123456 HTTP/1.1
Host: 10.100.0.10:5000
Authorization: Basic YXBpX3VzZXI6c2VjdXJlX3Bhc3N3b3Jk
```

**PowerShellスクリプト例**:
```powershell
$serial = (Get-CimInstance Win32_BIOS).SerialNumber
$uri = "http://10.100.0.10:5000/api/pcinfo?serial=$serial"
$credential = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("api_user:secure_password"))
$headers = @{
    "Authorization" = "Basic $credential"
}

$response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
Write-Host "PC Name: $($response.pcname)"
Write-Host "ODJ Path: $($response.odj_path)"
```

#### レスポンス（成功）

**HTTPステータス**: 200 OK

**レスポンスボディ**:
```json
{
  "pcname": "20251116M",
  "odj_path": "/srv/odj/20251116M.txt"
}
```

**フィールド説明**:

| フィールド名 | 型 | 説明 |
|--------------|-----|------|
| pcname | string | PC名（YYYYMMDDM形式） |
| odj_path | string | ODJファイルの絶対パス |

#### レスポンス（PC未登録）

**HTTPステータス**: 404 Not Found

**レスポンスボディ**:
```json
{
  "error": "PC not found",
  "error_code": "PC_NOT_FOUND",
  "details": "Serial number not registered in database",
  "serial": "ABC123456",
  "timestamp": "2025-11-16T14:30:22Z"
}
```

#### レスポンス（パラメータ不正）

**HTTPステータス**: 400 Bad Request

**レスポンスボディ**:
```json
{
  "error": "Missing required parameter: serial",
  "error_code": "MISSING_PARAMETER",
  "timestamp": "2025-11-16T14:30:22Z"
}
```

#### レスポンス（サーバエラー）

**HTTPステータス**: 500 Internal Server Error

**レスポンスボディ**:
```json
{
  "error": "Database connection failed",
  "error_code": "DB_CONNECTION_ERROR",
  "details": "sqlite3.OperationalError: database is locked",
  "timestamp": "2025-11-16T14:30:22Z"
}
```

---

### 2.4 POST /api/log（セットアップログ記録）

**用途**: クライアントPCからセットアップ進捗・完了・エラーログを記録

#### リクエスト

**エンドポイント**: `POST /api/log`

**リクエストヘッダー**:
```http
POST /api/log HTTP/1.1
Host: 10.100.0.10:5000
Content-Type: application/json
Authorization: Basic YXBpX3VzZXI6c2VjdXJlX3Bhc3N3b3Jk
```

**リクエストボディ**:
```json
{
  "serial": "ABC123456",
  "pcname": "20251116M",
  "status": "completed",
  "phase": "finalization",
  "timestamp": "2025-11-16 14:30:22",
  "logs": "Setup completed successfully. Total time: 75 minutes",
  "error_message": null
}
```

**フィールド説明**:

| フィールド名 | 型 | 必須 | 説明 |
|--------------|-----|------|------|
| serial | string | Yes | PCのBIOS Serial番号 |
| pcname | string | Yes | PC名（YYYYMMDDM形式） |
| status | string | Yes | セットアップ状態（下記参照） |
| phase | string | No | セットアップフェーズ（下記参照） |
| timestamp | string | Yes | ログ記録日時（YYYY-MM-DD HH:MM:SS形式） |
| logs | string | No | 詳細ログメッセージ |
| error_message | string | No | エラー発生時のメッセージ |

**status値**:
- `started`: セットアップ開始
- `api_called`: API問い合わせ完了
- `pc_renamed`: PC名設定完了
- `odj_applied`: ODJ適用完了
- `rebooted`: 再起動完了
- `windows_update_started`: Windows Update開始
- `windows_update_completed`: Windows Update完了
- `apps_installed`: アプリインストール完了
- `completed`: すべて完了
- `failed`: セットアップ失敗
- `pending`: 保留中

**phase値**:
- `initialization`: 初期化処理
- `api_communication`: API通信処理
- `pc_configuration`: PC設定処理
- `domain_join`: ドメイン参加処理
- `windows_update`: Windows Update処理
- `application_install`: アプリインストール処理
- `finalization`: 最終処理
- `error_handling`: エラーハンドリング

**PowerShellスクリプト例**:
```powershell
$uri = "http://10.100.0.10:5000/api/log"
$credential = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes("api_user:secure_password"))
$headers = @{
    "Authorization" = "Basic $credential"
    "Content-Type" = "application/json"
}

$body = @{
    serial = (Get-CimInstance Win32_BIOS).SerialNumber
    pcname = $env:COMPUTERNAME
    status = "completed"
    phase = "finalization"
    timestamp = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
    logs = "Setup completed successfully"
} | ConvertTo-Json

$response = Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
Write-Host "Log recorded: $($response.log_id)"
```

#### レスポンス（成功）

**HTTPステータス**: 200 OK

**レスポンスボディ**:
```json
{
  "result": "ok",
  "log_id": 12345,
  "timestamp": "2025-11-16T14:30:22Z"
}
```

**フィールド説明**:

| フィールド名 | 型 | 説明 |
|--------------|-----|------|
| result | string | 処理結果（"ok"固定） |
| log_id | integer | 登録されたログID |
| timestamp | string | サーバ受信日時（ISO 8601形式） |

#### レスポンス（バリデーションエラー）

**HTTPステータス**: 400 Bad Request

**レスポンスボディ**:
```json
{
  "error": "Missing required field: serial",
  "error_code": "MISSING_FIELD",
  "required_fields": ["serial", "pcname", "status", "timestamp"],
  "timestamp": "2025-11-16T14:30:22Z"
}
```

#### レスポンス（不正なstatus値）

**HTTPステータス**: 400 Bad Request

**レスポンスボディ**:
```json
{
  "error": "Invalid status value: unknown_status",
  "error_code": "INVALID_STATUS",
  "allowed_values": ["started", "api_called", "pc_renamed", "odj_applied", "rebooted", "windows_update_started", "windows_update_completed", "apps_installed", "completed", "failed", "pending"],
  "timestamp": "2025-11-16T14:30:22Z"
}
```

---

### 2.5 GET /api/status（セットアップ状況取得）【将来拡張】

**用途**: Serial番号またはPC名からセットアップ状況を取得

#### リクエスト

**エンドポイント**: `GET /api/status`

**クエリパラメータ**:

| パラメータ名 | 型 | 必須 | 説明 |
|--------------|-----|------|------|
| serial | string | No | PCのBIOS Serial番号 |
| pcname | string | No | PC名 |

**注**: `serial`または`pcname`のいずれか1つを指定

**リクエスト例**:
```http
GET /api/status?serial=ABC123456 HTTP/1.1
Host: 10.100.0.10:5000
Authorization: Basic YXBpX3VzZXI6c2VjdXJlX3Bhc3N3b3Jk
```

#### レスポンス（成功）

**HTTPステータス**: 200 OK

**レスポンスボディ**:
```json
{
  "serial": "ABC123456",
  "pcname": "20251116M",
  "current_status": "windows_update_completed",
  "current_phase": "windows_update",
  "progress_percentage": 85,
  "start_time": "2025-11-16T12:00:00Z",
  "last_update": "2025-11-16T13:15:22Z",
  "estimated_completion": "2025-11-16T13:45:00Z",
  "logs": [
    {
      "timestamp": "2025-11-16T12:00:00Z",
      "status": "started",
      "phase": "initialization"
    },
    {
      "timestamp": "2025-11-16T12:05:22Z",
      "status": "api_called",
      "phase": "api_communication"
    },
    {
      "timestamp": "2025-11-16T13:15:22Z",
      "status": "windows_update_completed",
      "phase": "windows_update"
    }
  ]
}
```

---

## 3. Web UI（管理画面）仕様

### 3.1 画面一覧

| 画面名 | URL | 説明 |
|--------|-----|------|
| ダッシュボード | `/` | セットアップ状況サマリー |
| PC一覧 | `/pc/list` | 登録PC一覧表示 |
| PC追加 | `/pc/add` | 単一PC登録 |
| PC編集 | `/pc/edit/<id>` | PC情報編集 |
| CSV一括登録 | `/pc/import` | CSVファイル一括登録 |
| ODJアップロード | `/odj/upload` | ODJファイルアップロード |
| セットアップログ | `/log/list` | セットアップログ一覧 |
| ログ詳細 | `/log/detail/<serial>` | 特定PCのログ詳細 |
| 展開管理 | `/deploy/manage` | Clonezillaイメージ・展開設定 |

---

### 3.2 ダッシュボード（`/`）

#### 画面イメージ

```
┌─────────────────────────────────────────────────────────────┐
│ PC Setup Automation - Dashboard                             │
├─────────────────────────────────────────────────────────────┤
│  [ダッシュボード] [PC管理] [ログ] [展開管理] [設定]          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  セットアップ状況（今日）                                     │
│  ┌───────────┬───────────┬───────────┬───────────┐          │
│  │  完了     │  進行中   │  失敗     │  待機中   │          │
│  │   15台    │   5台     │   1台     │   3台     │          │
│  └───────────┴───────────┴───────────┴───────────┘          │
│                                                             │
│  進行中のセットアップ                                         │
│  ┌──────────────────────────────────────────────┐           │
│  │ PC名        Serial      状態      進捗       │           │
│  ├──────────────────────────────────────────────┤           │
│  │ 20251116M   ABC123456   Windows Update  75%  │           │
│  │ 20251116M   DEF789012   アプリ導入      90%  │           │
│  │ 20251117M   GHI345678   ODJ適用         30%  │           │
│  └──────────────────────────────────────────────┘           │
│                                                             │
│  最近のエラー                                                │
│  ┌──────────────────────────────────────────────┐           │
│  │ PC名        Serial      エラー内容            │           │
│  ├──────────────────────────────────────────────┤           │
│  │ 20251116M   JKL901234   ODJファイル未発見     │           │
│  └──────────────────────────────────────────────┘           │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 表示項目

1. **セットアップ状況カード**（当日分）
   - 完了台数（status = 'completed'）
   - 進行中台数（status ≠ 'completed', 'failed'）
   - 失敗台数（status = 'failed'）
   - 待機中台数（pc_masterに登録済み、setup_logsに未登録）

2. **進行中セットアップ一覧**
   - PC名、Serial、現在状態、進捗率
   - 自動更新（10秒毎、WebSocket or Ajax）

3. **最近のエラー一覧**（直近10件）
   - PC名、Serial、エラー内容、発生日時

#### 実装技術

- **フレームワーク**: Flask + Jinja2
- **UI**: Bootstrap 5
- **リアルタイム更新**: AJAX（`$.ajax()` or `fetch()`）
- **グラフ**: Chart.js（進捗率可視化）

---

### 3.3 PC一覧（`/pc/list`）

#### 画面イメージ

```
┌─────────────────────────────────────────────────────────────┐
│ PC一覧                                        [CSV登録] [追加]│
├─────────────────────────────────────────────────────────────┤
│  検索: [Serial/PC名___________] [検索]  [絞込: 全て ▼]      │
├─────────────────────────────────────────────────────────────┤
│ ID  Serial       PC名        ODJパス              登録日     │
├─────────────────────────────────────────────────────────────┤
│ 1   ABC123456    20251116M   /srv/odj/20251116M  2025-11-16 │
│ 2   DEF789012    20251116M   /srv/odj/20251116M  2025-11-16 │
│ 3   GHI345678    20251117M   /srv/odj/20251117M  2025-11-17 │
│                                            [編集] [削除] [ログ] │
└─────────────────────────────────────────────────────────────┘
│ ページネーション: < 1 2 3 ... 10 >                           │
└─────────────────────────────────────────────────────────────┘
```

#### 機能

- **検索**: Serial番号またはPC名による部分一致検索
- **絞込**: 登録日、ODJ有無でフィルタリング
- **ソート**: 各カラムクリックで昇順・降順切替
- **ページネーション**: 1ページ50件表示
- **操作ボタン**:
  - **編集**: PC情報編集画面へ遷移
  - **削除**: 削除確認ダイアログ表示後削除
  - **ログ**: 該当PCのセットアップログ詳細表示

---

### 3.4 PC追加（`/pc/add`）

#### 画面イメージ

```
┌─────────────────────────────────────────────────────────────┐
│ PC追加                                                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Serial番号 *                                                │
│  [___________________________]                              │
│                                                             │
│  PC名 *                                                     │
│  [___________________________]                              │
│  ※YYYYMMDDM形式（例: 20251116M）                            │
│                                                             │
│  ODJファイルパス                                             │
│  [___________________________] [参照]                       │
│                                                             │
│  [キャンセル]  [登録]                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### バリデーション

| 項目 | ルール |
|------|--------|
| Serial番号 | 必須、一意性チェック |
| PC名 | 必須、YYYYMMDDM形式チェック（正規表現: `^\d{8}M$`） |
| ODJファイルパス | 任意、ファイル存在チェック |

#### エラー表示例

```
┌─────────────────────────────────────────────────────────────┐
│ ❌ エラー: Serial番号は既に登録されています（ABC123456）     │
└─────────────────────────────────────────────────────────────┘
```

---

### 3.5 CSV一括登録（`/pc/import`）

#### 画面イメージ

```
┌─────────────────────────────────────────────────────────────┐
│ CSV一括登録                                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  CSVファイル選択 *                                           │
│  [ファイルを選択] pc_master.csv                              │
│                                                             │
│  CSVフォーマット例:                                          │
│  ┌───────────────────────────────────────┐                  │
│  │ serial,pcname,odj_path                │                  │
│  │ ABC123456,20251116M,/srv/odj/20251116M│                  │
│  │ DEF789012,20251116M,/srv/odj/20251116M│                  │
│  └───────────────────────────────────────┘                  │
│                                                             │
│  ☑ 重複Serialをスキップ（チェック推奨）                      │
│                                                             │
│  [アップロード]                                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 処理フロー

1. CSVファイルアップロード
2. バリデーション（フォーマット、必須項目、一意性）
3. プレビュー表示（登録予定データ）
4. 確認後、一括INSERT
5. 結果表示（成功件数、スキップ件数、エラー詳細）

#### 結果表示例

```
┌─────────────────────────────────────────────────────────────┐
│ ✅ 一括登録完了                                              │
├─────────────────────────────────────────────────────────────┤
│  登録成功: 95件                                              │
│  スキップ: 5件（重複Serial）                                 │
│                                                             │
│  スキップされたSerial:                                       │
│  - ABC123456 (既存登録: 20251115M)                          │
│  - DEF789012 (既存登録: 20251115M)                          │
│  ...                                                        │
│                                                             │
│  [PC一覧へ]                                                  │
└─────────────────────────────────────────────────────────────┘
```

---

### 3.6 ODJアップロード（`/odj/upload`）

#### 画面イメージ

```
┌─────────────────────────────────────────────────────────────┐
│ ODJファイルアップロード                                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  PC名選択 *                                                  │
│  [20251116M ▼]                                              │
│                                                             │
│  ODJファイル選択 *                                           │
│  [ファイルを選択] 20251116M.txt                              │
│                                                             │
│  アップロード先: /srv/odj/{pcname}.txt                       │
│                                                             │
│  [アップロード]                                              │
│                                                             │
│  既存ODJファイル一覧:                                         │
│  ┌───────────────────────────────────────┐                  │
│  │ PC名        ファイルパス      サイズ  │                  │
│  ├───────────────────────────────────────┤                  │
│  │ 20251116M   /srv/odj/20251116M 12KB   │ [削除] [DL]      │
│  │ 20251117M   /srv/odj/20251117M 11KB   │ [削除] [DL]      │
│  └───────────────────────────────────────┘                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### 処理フロー

1. PC名選択（ドロップダウン、pc_masterから取得）
2. ODJファイルアップロード
3. ファイル検証（.txt拡張子、サイズ10MB以下、Base64エンコード確認）
4. 保存先: `/srv/odj/{pcname}.txt`
5. pc_masterテーブルのodj_path更新

---

### 3.7 セットアップログ（`/log/list`）

#### 画面イメージ

```
┌─────────────────────────────────────────────────────────────┐
│ セットアップログ                                              │
├─────────────────────────────────────────────────────────────┤
│  検索: [Serial/PC名___________] [期間: 今日 ▼] [検索]       │
│  ステータス: [全て ▼] [完了] [失敗] [進行中]                 │
├─────────────────────────────────────────────────────────────┤
│ Serial      PC名       ステータス  フェーズ       日時        │
├─────────────────────────────────────────────────────────────┤
│ ABC123456   20251116M  completed  finalization  2025-11-16  │
│ DEF789012   20251116M  failed     domain_join   2025-11-16  │
│ GHI345678   20251117M  in_progress windows_upd  2025-11-17  │
│                                           [詳細] [エクスポート]│
└─────────────────────────────────────────────────────────────┘
│ ページネーション: < 1 2 3 ... 20 >                           │
└─────────────────────────────────────────────────────────────┘
```

#### 機能

- **検索**: Serial、PC名、期間（今日、今週、今月、全期間）
- **フィルタ**: ステータス別、フェーズ別
- **ソート**: 日時降順（最新優先）
- **詳細**: モーダルで全ログ表示
- **エクスポート**: CSV形式でダウンロード

---

### 3.8 ログ詳細（`/log/detail/<serial>`）

#### 画面イメージ

```
┌─────────────────────────────────────────────────────────────┐
│ ログ詳細 - Serial: ABC123456                                 │
├─────────────────────────────────────────────────────────────┤
│  PC名: 20251116M                                             │
│  現在ステータス: completed                                   │
│  開始時刻: 2025-11-16 12:00:00                               │
│  完了時刻: 2025-11-16 13:15:22                               │
│  所要時間: 75分                                              │
├─────────────────────────────────────────────────────────────┤
│  タイムライン:                                               │
│  ┌───────────────────────────────────────┐                  │
│  │ 12:00:00  started        初期化処理   │                  │
│  │ 12:05:22  api_called     API通信OK    │                  │
│  │ 12:10:10  pc_renamed     PC名設定完了 │                  │
│  │ 12:15:30  odj_applied    ドメイン参加 │                  │
│  │ 12:20:45  rebooted       再起動完了   │                  │
│  │ 12:25:00  windows_update_started      │                  │
│  │ 13:00:15  windows_update_completed    │                  │
│  │ 13:10:30  apps_installed アプリ導入   │                  │
│  │ 13:15:22  completed      完了         │                  │
│  └───────────────────────────────────────┘                  │
│                                                             │
│  詳細ログ:                                                   │
│  ┌───────────────────────────────────────┐                  │
│  │ Setup completed successfully.         │                  │
│  │ Total updates installed: 25           │                  │
│  │ Total apps installed: 7               │                  │
│  │ Total time: 75 minutes                │                  │
│  └───────────────────────────────────────┘                  │
│                                                             │
│  [閉じる] [エクスポート]                                      │
└─────────────────────────────────────────────────────────────┘
```

---

### 3.9 展開管理（`/deploy/manage`）【将来拡張】

#### 画面イメージ

```
┌─────────────────────────────────────────────────────────────┐
│ 展開管理                                                     │
├─────────────────────────────────────────────────────────────┤
│  マスターイメージ一覧:                                        │
│  ┌───────────────────────────────────────┐                  │
│  │ イメージ名            サイズ   更新日 │                  │
│  ├───────────────────────────────────────┤                  │
│  │ win11-master-2025Q4   120GB   2025-10 │ [選択] [削除]    │
│  │ win11-master-2025Q3   115GB   2025-07 │ [選択] [削除]    │
│  └───────────────────────────────────────┘                  │
│                                                             │
│  展開設定:                                                   │
│  ┌───────────────────────────────────────┐                  │
│  │ 配信方式: [マルチキャスト ▼]          │                  │
│  │ 圧縮形式: [zstd ▼]                    │                  │
│  │ 最大同時台数: [20_______]             │                  │
│  │ 帯域制限: [500 Mbps_]                 │                  │
│  └───────────────────────────────────────┘                  │
│                                                             │
│  現在の展開状況:                                             │
│  進捗: ████████████░░░░░░░░ 60% (12/20台)                   │
│  残り時間: 約5分                                             │
│                                                             │
│  [展開開始] [展開停止]                                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. ファイルインターフェース

### 4.1 CSVフォーマット（PC一括登録）

#### ファイル名

`pc_master.csv`（任意）

#### 文字エンコーディング

UTF-8（BOM付き推奨、Excel互換性）

#### フォーマット

```csv
serial,pcname,odj_path
ABC123456,20251116M,/srv/odj/20251116M.txt
DEF789012,20251116M,/srv/odj/20251116M.txt
GHI345678,20251117M,/srv/odj/20251117M.txt
```

#### カラム定義

| カラム名 | 必須 | データ型 | 説明 | 例 |
|----------|------|----------|------|-----|
| serial | Yes | string | PCのBIOS Serial番号 | ABC123456 |
| pcname | Yes | string | PC名（YYYYMMDDM形式） | 20251116M |
| odj_path | No | string | ODJファイル絶対パス | /srv/odj/20251116M.txt |

#### バリデーションルール

1. **ヘッダー必須**: 1行目は `serial,pcname,odj_path`
2. **Serial重複チェック**: 既存データとの重複は登録スキップ
3. **PC名フォーマット**: `^\d{8}M$`（8桁数字 + M）
4. **ODJパス存在チェック**: ファイルが存在しない場合は警告（登録は続行）

#### エラー処理

- **形式不正**: エラーメッセージ表示 + 登録中断
- **Serial重複**: スキップしてログ記録
- **PC名不正**: エラーメッセージ表示 + 該当行スキップ

---

### 4.2 ODJファイル形式

#### ファイル名

`{pcname}.txt`（例: `20251116M.txt`）

#### 内容

Offline Domain Join用のBase64エンコードされたバイナリデータ（Microsoftフォーマット）

#### 生成方法（Active Directory側）

```powershell
# Active Directoryサーバで実行
djoin.exe /provision /domain company.local /machine 20251116M /savefile C:\ODJ\20251116M.txt

# 生成されたファイル例
# MIAGCSqGSIb3DQEHAqCAMIACAQExDzANBglghkgBZQMEAgEFADCABgkqhkiG9w0BBwGggCSABIID6DCCCOwwggMWoIIC9zCC...
```

#### ファイルサイズ

約10〜15KB（PC名、ドメイン情報により変動）

#### 適用方法（クライアントPC側）

```powershell
# PowerShellスクリプト内で実行
$odjPath = "C:\Temp\20251116M.txt"
djoin.exe /requestODJ /loadfile $odjPath /windowspath %SystemRoot% /localos

# 再起動後、ドメイン参加完了
Restart-Computer -Force
```

---

### 4.3 unattend.xml構造

#### ファイル配置

`C:\Windows\Panther\unattend.xml`（Sysprep時に指定）

#### 主要セクション

```xml
<?xml version="1.0" encoding="utf-8"?>
<unattend xmlns="urn:schemas-microsoft-com:unattend">
    <!-- Windows PE設定 -->
    <settings pass="windowsPE">
        <component name="Microsoft-Windows-Setup">
            <UserData>
                <AcceptEula>true</AcceptEula>
            </UserData>
        </component>
    </settings>

    <!-- OOBE設定 -->
    <settings pass="oobeSystem">
        <!-- 自動ログオン設定 -->
        <component name="Microsoft-Windows-Shell-Setup">
            <AutoLogon>
                <Username>Administrator</Username>
                <Password>
                    <Value>VGVtcFBhc3N3b3JkMTIz</Value> <!-- Base64: TempPassword123 -->
                    <PlainText>false</PlainText>
                </Password>
                <Enabled>true</Enabled>
                <LogonCount>3</LogonCount>
            </AutoLogon>

            <!-- 初回ログオンコマンド -->
            <FirstLogonCommands>
                <SynchronousCommand wcm:action="add">
                    <CommandLine>powershell.exe -ExecutionPolicy Bypass -File C:\ProgramData\CompanySetup\setup.ps1</CommandLine>
                    <Description>Run Setup Script</Description>
                    <Order>1</Order>
                </SynchronousCommand>
            </FirstLogonCommands>

            <!-- OOBE設定 -->
            <OOBE>
                <HideEULAPage>true</HideEULAPage>
                <HideWirelessSetupInOOBE>true</HideWirelessSetupInOOBE>
                <NetworkLocation>Work</NetworkLocation>
                <ProtectYourPC>1</ProtectYourPC>
                <SkipUserOOBE>true</SkipUserOOBE>
                <SkipMachineOOBE>true</SkipMachineOOBE>
            </OOBE>
        </component>
    </settings>

    <!-- Specialize設定 -->
    <settings pass="specialize">
        <component name="Microsoft-Windows-Shell-Setup">
            <ComputerName>*</ComputerName> <!-- ランダム生成、後でリネーム -->
            <TimeZone>Tokyo Standard Time</TimeZone>
        </component>
    </settings>
</unattend>
```

#### 重要設定項目

| セクション | 項目 | 設定値 | 説明 |
|------------|------|--------|------|
| AutoLogon | Username | Administrator | 自動ログオンユーザー |
| AutoLogon | Password | TempPassword123（Base64） | 一時パスワード |
| AutoLogon | LogonCount | 3 | 自動ログオン回数 |
| FirstLogonCommands | CommandLine | setup.ps1実行 | セットアップスクリプト起動 |
| OOBE | SkipUserOOBE | true | ユーザーOOBEスキップ |
| OOBE | SkipMachineOOBE | true | マシンOOBEスキップ |

---

## 5. 関連ドキュメント

| ドキュメント名 | パス | 説明 |
|----------------|------|------|
| システムアーキテクチャ設計書 | `/docs/02_設計/システムアーキテクチャ設計書.md` | 全体構成 |
| データベース設計書 | `/docs/02_設計/データベース設計書.md` | テーブル定義 |
| ネットワーク設計書 | `/docs/02_設計/ネットワーク設計書.md` | PXEブート、API通信 |
| 実装ガイド | `/docs/03_実装/` | Flask・PowerShell実装 |

---

## 6. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|------------|------|----------|--------|
| 1.0 | 2025-11-17 | 初版作成 | Interface Designer |

---

**承認欄**

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| インターフェース設計者 | | | |
| システムアーキテクト | | | |
| 技術責任者 | | | |
