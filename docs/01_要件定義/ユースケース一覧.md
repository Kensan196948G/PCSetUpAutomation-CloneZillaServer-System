# ユースケース一覧

**プロジェクト名**: 会社キッティング自動化フレームワーク
**作成日**: 2025年11月17日
**バージョン**: 1.0

---

## 1. 概要

本ドキュメントは、会社キッティング自動化フレームワークの主要ユースケースを定義します。アクター、事前条件、基本フロー、代替フロー、事後条件を明確にし、システムの振る舞いを詳細化します。

---

## 2. アクター定義

| アクター | 説明 | 役割 |
|---------|------|------|
| **IT管理者** | システム管理者 | PC情報登録、ODJアップロード、設定変更 |
| **キッティング担当者** | PC展開実施者 | PXEブート実施、展開モニタリング |
| **セットアップスクリプト** | PowerShellスクリプト | Serial番号取得、API呼び出し、自動セットアップ |
| **DRBL/Clonezillaサーバ** | PXEブートサーバ | イメージ配信、DHCP/TFTP提供 |
| **管理WebアプリAPI** | REST API | PC情報提供、ログ記録 |

---

## 3. ユースケース一覧

| UC-ID | ユースケース名 | アクター | 優先度 |
|-------|---------------|---------|--------|
| UC-001 | 新規PC一括登録（CSV） | IT管理者 | 高 |
| UC-002 | 個別PC情報登録 | IT管理者 | 中 |
| UC-003 | ODJファイル一括アップロード | IT管理者 | 高 |
| UC-004 | PXEブート展開実施 | キッティング担当者 | 高 |
| UC-005 | セットアップ状況モニタリング | キッティング担当者 | 中 |
| UC-006 | PC名・ODJ情報取得（API） | セットアップスクリプト | 高 |
| UC-007 | セットアップログ送信（API） | セットアップスクリプト | 高 |
| UC-008 | マスターイメージ更新 | IT管理者 | 中 |
| UC-009 | エラーログ確認 | IT管理者 | 中 |
| UC-010 | PC情報検索 | IT管理者 | 低 |

---

## 4. ユースケース詳細

### UC-001: 新規PC一括登録（CSV）

#### ユースケース図（テキスト）
```
┌──────────┐                    ┌─────────────────┐
│IT管理者   │                    │ 管理Webアプリ   │
└─────┬────┘                    └────────┬────────┘
      │                                  │
      │ 1. CSVファイルアップロード          │
      │──────────────────────────────────>│
      │                                  │
      │                              2. CSV解析
      │                              3. データ検証
      │                              4. DB一括登録
      │                                  │
      │ 5. インポート結果表示              │
      │<──────────────────────────────────│
```

#### 基本情報
- **主アクター**: IT管理者
- **関連アクター**: 管理Webアプリ、データベース
- **優先度**: 高
- **頻度**: 月1〜2回（大量導入時）

#### 事前条件
- IT管理者が管理GUIにログイン済み
- CSVファイルが正しい形式で作成済み（pcname, serial）
- ODJファイルが事前に生成済み

#### 基本フロー
1. IT管理者が「PC一括登録」メニューを選択
2. システムがCSVアップロード画面を表示
3. IT管理者がCSVファイルを選択してアップロード
4. システムがCSVファイルを解析
5. システムがデータを検証（重複チェック、形式チェック）
6. システムが検証OKの場合、pc_masterテーブルに一括登録
7. システムがインポート結果を表示（成功件数、失敗件数）
8. IT管理者が結果を確認

#### 代替フロー 1: CSV形式エラー
- **5a.** CSVの形式が不正な場合
  - 5a-1. システムがエラーメッセージを表示
  - 5a-2. IT管理者がCSVを修正して再アップロード
  - 5a-3. 基本フローの4に戻る

#### 代替フロー 2: 重複Serial番号
- **6a.** 既に登録されているSerial番号がある場合
  - 6a-1. システムが重複エラーを表示
  - 6a-2. IT管理者が重複データを確認
  - 6a-3. 選択: 上書き or スキップ
  - 6a-4. 基本フローの7に進む

#### 事後条件
- pc_masterテーブルに新規PCレコードが登録される
- インポート履歴がログに記録される

---

### UC-002: 個別PC情報登録

#### 基本情報
- **主アクター**: IT管理者
- **優先度**: 中
- **頻度**: 随時（1〜2台単位の導入時）

#### 事前条件
- IT管理者が管理GUIにログイン済み
- PC名が決定済み（YYYYMMDDM形式）
- Serial番号が判明済み

#### 基本フロー
1. IT管理者が「PC追加」メニューを選択
2. システムがPC情報入力フォームを表示
3. IT管理者がPC名、Serial番号、ODJパス（任意）を入力
4. システムが入力内容を検証
5. システムがpc_masterテーブルに登録
6. システムが登録完了メッセージを表示

#### 代替フロー: Serial番号重複
- **5a.** 既に登録済みのSerial番号の場合
  - 5a-1. システムが重複エラーを表示
  - 5a-2. IT管理者が確認し、編集または新規Serial入力
  - 5a-3. 基本フローの4に戻る

#### 事後条件
- pc_masterテーブルに1レコード追加
- 追加ログが記録される

---

### UC-003: ODJファイル一括アップロード

#### 基本情報
- **主アクター**: IT管理者
- **優先度**: 高
- **頻度**: 月1〜2回（大量導入時）

#### 事前条件
- IT管理者が管理GUIにログイン済み
- Active DirectoryでODJファイルが生成済み
- PC名とODJファイルが事前に紐付け済み

#### 基本フロー
1. IT管理者が「ODJ一括アップロード」メニューを選択
2. システムがファイル選択ダイアログを表示
3. IT管理者が複数のODJファイルを選択（100件まで）
4. システムが各ファイルを`/srv/odj/`に保存
5. システムがファイル名からPC名を抽出（例: `20251116M.txt` → `20251116M`）
6. システムがpc_masterテーブルのodj_pathカラムを更新
7. システムがアップロード結果を表示

#### 代替フロー: ファイル名不正
- **5a.** ODJファイル名がPC名と一致しない場合
  - 5a-1. システムが警告メッセージを表示
  - 5a-2. IT管理者がファイル名を修正または手動紐付け
  - 5a-3. 基本フローの5に戻る

#### 事後条件
- ODJファイルが`/srv/odj/`に保存される
- pc_masterのodj_pathが更新される
- アップロードログが記録される

---

### UC-004: PXEブート展開実施

#### ユースケース図（テキスト）
```
┌─────────────┐                  ┌──────────────┐
│キッティング │                  │ DRBL/        │
│担当者       │                  │ Clonezilla   │
└──────┬──────┘                  └──────┬───────┘
       │                                │
       │ 1. PC電源ON（PXEブート）          │
       │──────────────────────────────────>│
       │                                │
       │                            2. DHCP応答
       │                            3. TFTP配信
       │                            4. イメージ展開
       │                                │
       │ 5. 展開進捗モニタリング            │
       │<──────────────────────────────────│
       │                                │
       │ 6. 展開完了確認                  │
       │<──────────────────────────────────│
```

#### 基本情報
- **主アクター**: キッティング担当者
- **関連アクター**: DRBL/Clonezillaサーバ、新規PC
- **優先度**: 高
- **頻度**: 毎週1〜2回

#### 事前条件
- pc_masterテーブルにPC情報が登録済み
- ODJファイルがアップロード済み
- DRBLサーバが正常稼働中
- 新規PCがLANに接続されている

#### 基本フロー
1. キッティング担当者が新規PCをLANに接続
2. キッティング担当者がPC電源をON
3. PCがPXEブートを開始
4. DRBLサーバがDHCPでIPアドレスを割り当て
5. DRBLサーバがTFTPでブートローダーを配信
6. Clonezillaが起動し、マスターイメージを自動展開
7. キッティング担当者が展開進捗をモニタリング
8. イメージ展開が完了し、PCが自動再起動
9. Windows初回起動（OOBE）
10. PowerShellスクリプトが自動実行
11. セットアップが完了し、ログが管理GUIに送信

#### 代替フロー 1: PXEブート失敗
- **4a.** DHCPサーバが応答しない場合
  - 4a-1. キッティング担当者がDRBLサーバの稼働を確認
  - 4a-2. ネットワーク接続を確認
  - 4a-3. PC再起動
  - 4a-4. 基本フローの3に戻る

#### 代替フロー 2: イメージ展開エラー
- **6a.** ディスクエラーでイメージ展開失敗
  - 6a-1. Clonezillaがエラーメッセージを表示
  - 6a-2. キッティング担当者がエラーログを確認
  - 6a-3. ディスク交換（ハードウェア不良の場合）
  - 6a-4. 基本フローの3に戻る

#### 事後条件
- 新規PCにマスターイメージが展開される
- Windowsが正常起動する
- セットアップログが記録される

---

### UC-005: セットアップ状況モニタリング

#### 基本情報
- **主アクター**: キッティング担当者
- **優先度**: 中
- **頻度**: 展開実施時（常時）

#### 事前条件
- PC展開が開始されている
- 管理GUIにアクセス可能

#### 基本フロー
1. キッティング担当者が管理GUIの「セットアップログ」画面を開く
2. システムがsetup_logsテーブルからログを取得
3. システムがリアルタイムでログを表示（10秒自動更新）
4. キッティング担当者がステータスを確認
   - `in_progress`: セットアップ中
   - `completed`: 完了
   - `failed`: エラー
5. エラーがある場合、詳細ログを確認
6. 必要に応じて対応実施

#### 事後条件
- なし（参照のみ）

---

### UC-006: PC名・ODJ情報取得（API）

#### ユースケース図（テキスト）
```
┌──────────────┐              ┌──────────────┐
│PowerShell    │              │ 管理WebアプリAPI│
│スクリプト    │              │               │
└──────┬───────┘              └──────┬───────┘
       │                            │
       │ 1. GET /api/pcinfo?serial=XXX │
       │────────────────────────────────>│
       │                            │
       │                        2. DB検索
       │                        3. PC名・ODJパス取得
       │                            │
       │ 4. JSON レスポンス           │
       │<────────────────────────────────│
```

#### 基本情報
- **主アクター**: セットアップスクリプト（PowerShell）
- **関連アクター**: 管理WebアプリAPI、データベース
- **優先度**: 高
- **頻度**: 展開時（1台あたり1回）

#### 事前条件
- PC展開が開始され、Windowsが初回起動している
- PowerShellスクリプトが実行中
- Serial番号が取得済み

#### 基本フロー
1. PowerShellスクリプトがSerial番号を取得
2. スクリプトが`GET /api/pcinfo?serial=XXX`を呼び出し
3. APIがpc_masterテーブルからSerial番号で検索
4. APIがPC名とODJパスを含むJSONを返却
5. PowerShellスクリプトがレスポンスを解析
6. PC名とODJパスを変数に格納

#### 代替フロー: Serial番号未登録
- **3a.** データベースにSerial番号が存在しない場合
  - 3a-1. APIが`{"error": "Serial number not found"}`を返却
  - 3a-2. PowerShellスクリプトがエラーログを記録
  - 3a-3. 管理GUIにエラー通知（`POST /api/log`）
  - 3a-4. セットアップ中断（手動介入待ち）

#### 事後条件
- PowerShellスクリプトがPC名とODJパスを取得
- API呼び出しログが記録される

---

### UC-007: セットアップログ送信（API）

#### 基本情報
- **主アクター**: セットアップスクリプト（PowerShell）
- **優先度**: 高
- **頻度**: セットアップ完了時（1台あたり1回）

#### 事前条件
- セットアップが完了（成功または失敗）
- PowerShellスクリプトが実行中

#### 基本フロー
1. PowerShellスクリプトがセットアップステータスを判定
2. スクリプトがログデータを準備（JSON形式）
3. スクリプトが`POST /api/log`を呼び出し
4. APIがJSONボディを解析
5. APIがsetup_logsテーブルに挿入
6. APIが`{"result": "ok"}`を返却
7. PowerShellスクリプトが正常終了

#### 代替フロー: API接続失敗
- **4a.** APIサーバに接続できない場合
  - 4a-1. PowerShellスクリプトが3回リトライ（5秒間隔）
  - 4a-2. リトライ後も失敗の場合、ローカルログに記録
  - 4a-3. セットアップ継続（ログ送信は手動対応）

#### 事後条件
- setup_logsテーブルに1レコード追加
- セットアップステータスが記録される

---

### UC-008: マスターイメージ更新

#### 基本情報
- **主アクター**: IT管理者
- **優先度**: 中
- **頻度**: 年数回（Windows大型更新時）

#### 事前条件
- 現行マスターイメージのバックアップ済み
- 新規マスターPCが構築済み
- Sysprep実行準備完了

#### 基本フロー
1. IT管理者が新規マスターPCを構築
2. IT管理者がWindows Update適用
3. IT管理者が会社標準アプリケーションインストール
4. IT管理者がAppX除外処理を実施
5. IT管理者がSysprepを実行
6. Sysprep完了後、PCが自動シャットダウン
7. IT管理者がClonezilla LiveでPCを起動
8. Clonezillaでイメージを作成し、DRBLサーバに保存
9. IT管理者がテストPCでイメージ展開検証
10. 検証OKの場合、デフォルトイメージに設定

#### 代替フロー: Sysprep失敗
- **6a.** Sysprepがエラーで失敗する場合
  - 6a-1. IT管理者がSysprepログを確認
  - 6a-2. AppX除外漏れがあれば再実施
  - 6a-3. 基本フローの5に戻る

#### 事後条件
- 新しいマスターイメージがDRBLサーバに保存される
- 旧マスターイメージがバックアップされる

---

### UC-009: エラーログ確認

#### 基本情報
- **主アクター**: IT管理者
- **優先度**: 中
- **頻度**: 日次

#### 事前条件
- 管理GUIにログイン済み

#### 基本フロー
1. IT管理者が「セットアップログ」メニューを選択
2. システムがログ一覧を表示
3. IT管理者がフィルター「status = failed」を選択
4. システムがエラーログのみを表示
5. IT管理者が各エラーログの詳細を確認
6. IT管理者が対応要否を判断
7. 必要に応じてトラブルシューティング実施

#### 事後条件
- エラー対応が記録される（任意）

---

### UC-010: PC情報検索

#### 基本情報
- **主アクター**: IT管理者
- **優先度**: 低
- **頻度**: 随時

#### 事前条件
- 管理GUIにログイン済み

#### 基本フロー
1. IT管理者が「PC一覧」画面を開く
2. IT管理者が検索ボックスにSerial番号またはPC名を入力
3. システムがpc_masterテーブルから検索
4. システムが検索結果を表示
5. IT管理者が結果を確認

#### 事後条件
- なし（参照のみ）

---

## 5. ユースケースマトリクス

| UC-ID | ユースケース名 | IT管理者 | キッティング担当者 | スクリプト | DRBL | API |
|-------|---------------|----------|-------------------|----------|------|-----|
| UC-001 | 新規PC一括登録（CSV） | ● | - | - | - | ○ |
| UC-002 | 個別PC情報登録 | ● | - | - | - | ○ |
| UC-003 | ODJファイル一括アップロード | ● | - | - | - | ○ |
| UC-004 | PXEブート展開実施 | - | ● | - | ● | - |
| UC-005 | セットアップ状況モニタリング | - | ● | - | - | ○ |
| UC-006 | PC名・ODJ情報取得（API） | - | - | ● | - | ● |
| UC-007 | セットアップログ送信（API） | - | - | ● | - | ● |
| UC-008 | マスターイメージ更新 | ● | - | - | ● | - |
| UC-009 | エラーログ確認 | ● | - | - | - | ○ |
| UC-010 | PC情報検索 | ● | - | - | - | ○ |

**凡例**: ●=主アクター、○=関連アクター

---

## 6. ユースケース実現マッピング

| UC-ID | 実現レイヤー | 実現コンポーネント |
|-------|------------|------------------|
| UC-001 | インフラレイヤー | Flask管理GUI（CSVインポート機能） |
| UC-002 | インフラレイヤー | Flask管理GUI（PC情報管理機能） |
| UC-003 | インフラレイヤー | Flask管理GUI（ODJ管理機能） |
| UC-004 | 実行レイヤー | DRBL/Clonezillaサーバ、PXEブート環境 |
| UC-005 | インフラレイヤー | Flask管理GUI（ログ閲覧機能） |
| UC-006 | インフラレイヤー | Flask REST API（GET /api/pcinfo） |
| UC-007 | インフラレイヤー | Flask REST API（POST /api/log） |
| UC-008 | マスターPC構築レイヤー | Sysprep、Clonezilla |
| UC-009 | インフラレイヤー | Flask管理GUI（ログ検索機能） |
| UC-010 | インフラレイヤー | Flask管理GUI（PC検索機能） |

---

## 7. 非機能要件とのマッピング

| UC-ID | パフォーマンス要件 | セキュリティ要件 |
|-------|------------------|----------------|
| UC-001 | 100件CSV登録が10秒以内 | ログイン認証必須 |
| UC-004 | 1台あたり展開時間60〜90分 | 専用VLANで分離 |
| UC-006 | API応答時間200ms以下 | Bearer Token認証 |
| UC-007 | API応答時間200ms以下 | Bearer Token認証 |

---

## 8. 関連ドキュメント

- [機能要件一覧.md](./機能要件一覧.md)
- [非機能要件一覧.md](./非機能要件一覧.md)
- [制約事項.md](./制約事項.md)
- [システムアーキテクチャ設計書.md](../02_設計/システムアーキテクチャ設計書.md)

---

**文書管理情報**
- 作成者: プロジェクトマネージャー
- 承認者: IT運用マネージャー
- 最終更新日: 2025年11月17日
- バージョン: 1.0
- 次回レビュー予定: 設計フェーズ開始時
