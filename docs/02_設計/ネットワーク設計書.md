# ネットワーク設計書

**文書番号**: NET-001
**バージョン**: 1.0
**作成日**: 2025-11-17
**最終更新日**: 2025-11-17

---

## 1. 概要

本書は、会社キッティング自動化フレームワークのネットワーク構成を定義します。PXEブート、マルチキャスト配信、REST API通信を実現する社内LAN環境を設計します。

### 1.1 設計方針

- **専用セグメント**: キッティング専用VLANを設定（本番ネットワークと分離）
- **高速配信**: Gigabit Ethernet + マルチキャスト（10〜20台同時展開）
- **セキュリティ**: 社内LANのみ、外部公開なし
- **単純性**: DHCPスコープ固定、静的IP管理

---

## 2. ネットワークトポロジー

### 2.1 物理構成図（ASCII Art）

```
                        [インターネット]
                              |
                    ┌─────────┴──────────┐
                    │  ファイアウォール   │
                    │   (外部接続制限)    │
                    └─────────┬──────────┘
                              |
        ┌─────────────────────┴────────────────────┐
        │         L3スイッチ (Core Switch)         │
        │   - VLAN間ルーティング                    │
        │   - IGMP Snooping有効                     │
        └──┬─────────┬─────────┬──────────────┬────┘
           |         |         |              |
   ┌───────┴───┐ ┌──┴────┐ ┌──┴────────┐ ┌──┴───────────┐
   │VLAN 10    │ │VLAN 20│ │VLAN 100   │ │VLAN 200      │
   │本番業務   │ │サーバ │ │キッティング│ │管理          │
   │192.168.10.│ │192.168│ │10.100.0.0 │ │192.168.200.0 │
   │0/24       │ │.20.0  │ │/16        │ │/24           │
   └───────────┘ └───────┘ └──┬────────┘ └──────────────┘
                               |
                               | VLAN 100 (キッティング専用)
                               |
                    ┌──────────┴────────────┐
                    │ L2スイッチ (48ポート) │
                    │ - Gigabit Ethernet    │
                    │ - IGMP Snooping有効   │
                    │ - ポート1-24: Client  │
                    │ - ポート25: DRBL      │
                    │ - ポート26: AD        │
                    └──┬──┬──┬───────┬──┬──┘
                       |  |  |       |  |
              ┌────────┘  |  |       |  └────────┐
              |            |  |       |           |
        ┌─────┴────┐  ┌───┴──┴───┐  └───┐  ┌────┴─────┐
        │ DRBLサーバ│  │クライアント│      │  │ADサーバ  │
        │ 10.100.  │  │PC (PXE)   │      │  │10.100.   │
        │ 0.10     │  │10.100.1.  │      │  │0.100     │
        │          │  │100-120    │      │  │          │
        │ - DHCP   │  │(DHCP割当) │      │  │- ドメイン│
        │ - TFTP   │  │           │      │  │  コントロ│
        │ - Flask  │  └───────────┘      │  │  ーラー  │
        │ - NFS    │                     │  │          │
        └──────────┘              ┌──────┴──┴──────────┐
                                  │ 同時20台展開可能    │
                                  │ (マルチキャスト)    │
                                  └─────────────────────┘
```

### 2.2 論理構成図

```
┌─────────────────────────────────────────────────────────────┐
│ VLAN 100: キッティング専用セグメント (10.100.0.0/16)         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [DRBLサーバ: 10.100.0.10]                                  │
│    ├─ DHCP Server (10.100.1.100 - 10.100.1.200)            │
│    ├─ TFTP Server (UDP 69) - PXEブートファイル配信          │
│    ├─ NFS Server (UDP 2049) - Clonezillaイメージ配信        │
│    ├─ Flask Web (TCP 5000) - 管理GUI                        │
│    └─ REST API (TCP 5000) - /api/pcinfo, /api/log          │
│                                                             │
│  [ADサーバ: 10.100.0.100]                                   │
│    ├─ DNS (UDP/TCP 53)                                      │
│    ├─ Kerberos (UDP/TCP 88)                                 │
│    ├─ LDAP (TCP 389/636)                                    │
│    └─ ODJファイル発行                                       │
│                                                             │
│  [クライアントPC群: 10.100.1.100-120] (DHCP動的割当)        │
│    └─ PXEブート → Clonezilla → Windows自動セットアップ     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. コンポーネント詳細

### 3.1 DRBLサーバ

| 項目 | 設定値 |
|------|--------|
| ホスト名 | drbl-server.company.local |
| IPアドレス | 10.100.0.10/16 |
| デフォルトゲートウェイ | 10.100.0.1 |
| DNSサーバ | 10.100.0.100 (ADサーバ) |
| NIC | eth0: 管理用<br>eth1: PXE配信用（Optional） |

**サービス・ポート一覧**:

| サービス | プロトコル | ポート | 用途 |
|----------|------------|--------|------|
| DHCP | UDP | 67, 68 | PXEブート時IP割当 |
| TFTP | UDP | 69 | PXEブートファイル配信 |
| NFS | TCP/UDP | 111, 2049 | Clonezillaイメージ配信 |
| Flask Web | TCP | 5000 | 管理GUI・REST API |
| SSH | TCP | 22 | サーバ管理 |
| Multicast | UDP | 2232 (デフォルト) | Clonezilla同時配信 |

### 3.2 Flask管理Webアプリケーション

| 項目 | 設定値 |
|------|--------|
| URL | http://10.100.0.10:5000 |
| APIエンドポイント | http://10.100.0.10:5000/api/ |
| 認証 | Basic認証（社内限定） |

**APIエンドポイント詳細**:

| エンドポイント | メソッド | ポート | 説明 |
|----------------|----------|--------|------|
| /api/pcinfo | GET | 5000 | Serial番号からPC名・ODJパス取得 |
| /api/log | POST | 5000 | セットアップログ記録 |
| /api/status | GET | 5000 | セットアップ状況取得（将来拡張） |

### 3.3 Active Directoryサーバ

| 項目 | 設定値 |
|------|--------|
| ホスト名 | ad-server.company.local |
| IPアドレス | 10.100.0.100/16 |
| ドメイン名 | company.local |
| 役割 | ドメインコントローラ、DNS、DHCP（補助） |

**サービス・ポート一覧**:

| サービス | プロトコル | ポート | 用途 |
|----------|------------|--------|------|
| DNS | UDP/TCP | 53 | 名前解決 |
| Kerberos | UDP/TCP | 88 | 認証 |
| LDAP | TCP | 389 | ディレクトリサービス |
| LDAPS | TCP | 636 | LDAP over SSL |
| Global Catalog | TCP | 3268 | グローバルカタログ |

### 3.4 クライアントPC

| 項目 | 設定値 |
|------|--------|
| IPレンジ | 10.100.1.100 - 10.100.1.200 (DHCP) |
| サブネットマスク | 255.255.0.0 (/16) |
| デフォルトゲートウェイ | 10.100.0.1 |
| DNSサーバ | 10.100.0.100 (ADサーバ) |
| PXEブート | 有効（BIOS/UEFI設定） |

---

## 4. PXEブートシーケンス

### 4.1 シーケンス図

```
クライアントPC    L2スイッチ    DRBLサーバ(DHCP/TFTP)    Clonezilla
    |               |              |                      |
    |--①DHCP Discover(Broadcast)-->|                      |
    |               |              |                      |
    |<--②DHCP Offer(PXE情報付)-----|                      |
    |   (IP: 10.100.1.100)         |                      |
    |   (Next-server: 10.100.0.10) |                      |
    |   (Filename: pxelinux.0)     |                      |
    |               |              |                      |
    |--③DHCP Request-------------->|                      |
    |<--④DHCP ACK------------------|                      |
    |               |              |                      |
    |--⑤TFTP RRQ(pxelinux.0)------>|                      |
    |<--⑥pxelinux.0----------------|                      |
    |               |              |                      |
    |--⑦TFTP RRQ(pxelinux.cfg)---->|                      |
    |<--⑧pxelinux.cfg--------------|                      |
    |               |              |                      |
    |--⑨TFTP RRQ(vmlinuz/initrd)-->|                      |
    |<--⑩vmlinuz/initrd------------|                      |
    |               |              |                      |
    |==⑪Clonezilla Live起動========|                      |
    |               |              |                      |
    |--⑫NFS Mount(/home/partimag)------------------------>|
    |<--⑬マスターイメージ(マルチキャスト)<-----------------|
    |   (udpcast: 224.0.0.1:2232)  |                      |
    |               |              |                      |
    |==⑭イメージ展開完了============|                      |
    |               |              |                      |
    |==⑮再起動(Windows)============|                      |
```

### 4.2 PXEブート詳細フロー

1. **DHCP Discovery**: クライアントPCがLANに接続し電源ON → DHCP Discover送信（Broadcast）
2. **DHCP Offer**: DRBLサーバがIP + PXE情報を返却
   - `next-server`: 10.100.0.10（TFTPサーバ）
   - `filename`: pxelinux.0（PXEブートローダー）
3. **TFTP転送**: クライアントPCがTFTP経由でpxelinux.0取得
4. **PXEメニュー表示**: pxelinux.cfg/default読み込み → Clonezillaメニュー表示
5. **Clonezilla起動**: vmlinuz + initrd.img ロード → Clonezilla Live起動
6. **NFS/マルチキャスト**: マスターイメージを10〜20台同時配信
7. **イメージ展開**: ディスクへ書き込み完了 → 再起動

---

## 5. マルチキャスト配信の仕組み

### 5.1 マルチキャスト概要

**目的**: 同一マスターイメージを複数台へ同時配信（ネットワーク負荷削減）

**技術**: udpcast（UDPマルチキャスト）

**マルチキャストアドレス**: 224.0.0.1〜239.255.255.255（IPv4）

### 5.2 マルチキャスト設定

**DRBLサーバ側（Clonezilla Server）**:
```bash
# /etc/drbl/drbl.conf
MULTICAST_ADDR="224.0.0.1"
MULTICAST_PORT="2232"
MAX_CLIENTS="20"
```

**ネットワークスイッチ側**:
- **IGMP Snooping有効化**: マルチキャストトラフィックを必要なポートのみに配信
- **IGMP Querier有効**: マルチキャストグループ管理

### 5.3 帯域幅計算

**想定条件**:
- マスターイメージサイズ: 100GB
- 圧縮率: 50%（zstd圧縮） → 50GB転送
- 配信速度: 500Mbps（ギガビットの半分、安全マージン）

**配信時間**:
```
50GB × 8 bits / 500Mbps = 800秒 = 約13分
```

**同時20台配信の場合**:
- ユニキャストの場合: 13分 × 20台 = 260分（4時間20分）
- マルチキャストの場合: 13分（全台同時）
- **効果**: 約95%の時間短縮

---

## 6. ネットワークスイッチ要件

### 6.1 L2スイッチ（キッティング専用）

| 項目 | 要件 |
|------|------|
| ポート数 | 48ポート（クライアント24 + サーバ2 + 予備22） |
| 速度 | Gigabit Ethernet (1000Mbps) |
| IGMP Snooping | 必須（v2以上） |
| VLAN | 802.1Q対応 |
| ジャンボフレーム | 9000バイト対応（推奨） |
| PoE | 不要（PC電源は個別） |

**推奨機種例**:
- Cisco Catalyst 2960-X
- HP Aruba 2530
- NETGEAR GS728TP

### 6.2 IGMP Snooping設定例（Cisco）

```cisco
Switch(config)# ip igmp snooping
Switch(config)# ip igmp snooping vlan 100
Switch(config)# ip igmp snooping vlan 100 mrouter interface gigabitEthernet 1/0/25
```

### 6.3 VLAN設定例（Cisco）

```cisco
Switch(config)# vlan 100
Switch(config-vlan)# name Kitting
Switch(config-vlan)# exit

Switch(config)# interface range gigabitEthernet 1/0/1-24
Switch(config-if-range)# switchport mode access
Switch(config-if-range)# switchport access vlan 100

Switch(config)# interface gigabitEthernet 1/0/25
Switch(config-if)# description DRBL-Server
Switch(config-if)# switchport mode access
Switch(config-if)# switchport access vlan 100
```

---

## 7. APIエンドポイント詳細

### 7.1 GET /api/pcinfo

**用途**: Serial番号からPC名・ODJパス取得

**リクエスト**:
```http
GET /api/pcinfo?serial=ABC123456 HTTP/1.1
Host: 10.100.0.10:5000
```

**レスポンス（成功）**:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "pcname": "20251116M",
  "odj_path": "/srv/odj/20251116M.txt"
}
```

**レスポンス（PC未登録）**:
```http
HTTP/1.1 404 Not Found
Content-Type: application/json

{
  "error": "PC not found",
  "serial": "ABC123456"
}
```

**レスポンス（サーバエラー）**:
```http
HTTP/1.1 500 Internal Server Error
Content-Type: application/json

{
  "error": "Database connection failed"
}
```

### 7.2 POST /api/log

**用途**: セットアップログ記録

**リクエスト**:
```http
POST /api/log HTTP/1.1
Host: 10.100.0.10:5000
Content-Type: application/json

{
  "serial": "ABC123456",
  "pcname": "20251116M",
  "status": "completed",
  "phase": "finalization",
  "timestamp": "2025-11-16 14:30:22",
  "logs": "Setup completed successfully"
}
```

**レスポンス（成功）**:
```http
HTTP/1.1 200 OK
Content-Type: application/json

{
  "result": "ok",
  "log_id": 12345
}
```

**レスポンス（バリデーションエラー）**:
```http
HTTP/1.1 400 Bad Request
Content-Type: application/json

{
  "error": "Missing required field: serial"
}
```

---

## 8. セキュリティ考慮

### 8.1 VLAN分離

**VLAN構成**:
- **VLAN 10（本番業務）**: 通常業務PC
- **VLAN 20（サーバ）**: 本番サーバ群
- **VLAN 100（キッティング）**: 専用セグメント（外部遮断）
- **VLAN 200（管理）**: ネットワーク管理用

**VLAN間ルーティング**:
- VLAN 100 → VLAN 20（ADサーバ）: 許可（ODJ取得のため）
- VLAN 100 → インターネット: 拒否（初期セットアップ時は遮断）
- その他VLAN → VLAN 100: 拒否

### 8.2 ファイアウォールルール

**DRBLサーバ（iptables）**:
```bash
# デフォルト拒否
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT

# ローカルループバック許可
iptables -A INPUT -i lo -j ACCEPT

# 確立済み接続許可
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# VLAN 100からのDHCP/TFTP/NFS/Flask許可
iptables -A INPUT -p udp --dport 67:68 -s 10.100.0.0/16 -j ACCEPT
iptables -A INPUT -p udp --dport 69 -s 10.100.0.0/16 -j ACCEPT
iptables -A INPUT -p tcp --dport 2049 -s 10.100.0.0/16 -j ACCEPT
iptables -A INPUT -p udp --dport 2049 -s 10.100.0.0/16 -j ACCEPT
iptables -A INPUT -p tcp --dport 5000 -s 10.100.0.0/16 -j ACCEPT

# SSH（管理用）許可
iptables -A INPUT -p tcp --dport 22 -s 192.168.200.0/24 -j ACCEPT

# ログ記録
iptables -A INPUT -j LOG --log-prefix "DRBL-DROP: "
```

### 8.3 API認証（Basic認証）

**Flask実装例**:
```python
from flask import request, Response
from functools import wraps

def check_auth(username, password):
    return username == 'api_user' and password == 'secure_password'

def authenticate():
    return Response('Authentication required', 401,
                    {'WWW-Authenticate': 'Basic realm="Login Required"'})

def requires_auth(f):
    @wraps(f)
    def decorated(*args, **kwargs):
        auth = request.authorization
        if not auth or not check_auth(auth.username, auth.password):
            return authenticate()
        return f(*args, **kwargs)
    return decorated

@app.route('/api/pcinfo')
@requires_auth
def api_pcinfo():
    # 処理
    pass
```

---

## 9. ネットワークパフォーマンス

### 9.1 帯域幅要件

**シナリオ1: 10台同時展開**
- マスターイメージ: 50GB（圧縮後）
- マルチキャスト配信: 500Mbps
- 配信時間: 13分
- スイッチ負荷: 500Mbps（1ポート） + 500Mbps × 10ポート（受信側） ≈ 5.5Gbps
- **結論**: Gigabitスイッチで問題なし（集約リンクでアップリンク強化推奨）

**シナリオ2: 20台同時展開**
- マスターイメージ: 50GB（圧縮後）
- マルチキャスト配信: 500Mbps
- 配信時間: 13分
- スイッチ負荷: 500Mbps + 500Mbps × 20ポート ≈ 10.5Gbps
- **結論**: 10Gbpsアップリンク推奨（または2台のGigabitスイッチに分割）

### 9.2 レイテンシ要件

| 通信 | 許容レイテンシ | 実測値（LAN） |
|------|----------------|---------------|
| PXEブート（DHCP/TFTP） | <100ms | 5〜10ms |
| API通信（GET /api/pcinfo） | <200ms | 10〜20ms |
| NFS読み込み | <50ms | 5〜10ms |
| マルチキャスト配信 | <10ms（パケット間） | 1〜5ms |

### 9.3 パフォーマンス監視

**監視項目**:
- DRBLサーバNIC帯域使用率（`ifconfig`、`iftop`）
- マルチキャストパケットロス率（`udpcast`ログ）
- API応答時間（Flaskログ）
- スイッチポート帯域使用率（SNMP監視）

**監視コマンド例**:
```bash
# NIC帯域リアルタイム監視
iftop -i eth0

# マルチキャスト統計
netstat -g

# API応答時間測定
time curl http://10.100.0.10:5000/api/pcinfo?serial=ABC123456
```

---

## 10. トラブルシューティング

### 10.1 PXEブート失敗

**症状**: クライアントPCがPXEブートしない

**原因と対処**:

| 原因 | 確認方法 | 対処 |
|------|----------|------|
| DHCP応答なし | `tcpdump -i eth0 port 67` | DHCPサービス起動確認 |
| TFTP応答なし | `tftp 10.100.0.10 -c get pxelinux.0` | TFTPサービス起動確認 |
| BIOS/UEFI設定 | BIOS画面でPXEブート優先度確認 | Boot OrderでPXE最優先に設定 |
| ネットワークケーブル | `ethtool eth0` でリンク確認 | ケーブル交換 |

**診断コマンド**:
```bash
# DRBLサーバ側
systemctl status isc-dhcp-server
systemctl status tftpd-hpa
tcpdump -i eth0 port 67 or port 69

# DHCP応答確認
nmap --script broadcast-dhcp-discover
```

### 10.2 マルチキャスト配信失敗

**症状**: Clonezillaイメージ配信が途中で止まる

**原因と対処**:

| 原因 | 確認方法 | 対処 |
|------|----------|------|
| IGMP Snooping無効 | スイッチ設定確認 | `ip igmp snooping vlan 100` 有効化 |
| マルチキャストルーティング | `ip mroute` 確認 | mrouter設定 |
| パケットロス | `udpcast`ログ確認 | 帯域制限（--max-bitrate） |
| ファイアウォール | `iptables -L -n` | マルチキャスト許可ルール追加 |

**診断コマンド**:
```bash
# マルチキャストグループ確認
netstat -g

# マルチキャスト送信テスト
iperf3 -c 224.0.0.1 -u -b 500M -t 10

# udpcastログ確認
tail -f /var/log/syslog | grep udpcast
```

### 10.3 API接続失敗

**症状**: PowerShellスクリプトがAPI呼び出しに失敗

**原因と対処**:

| 原因 | 確認方法 | 対処 |
|------|----------|------|
| Flask未起動 | `systemctl status flask-app` | Flaskサービス再起動 |
| ファイアウォール | `telnet 10.100.0.10 5000` | ポート5000許可 |
| DNS解決失敗 | `nslookup drbl-server.company.local` | /etc/hostsにエントリ追加 |
| 認証エラー | curlでBasic認証テスト | 認証情報確認 |

**診断コマンド**:
```bash
# DRBLサーバ側
systemctl status flask-app
netstat -tuln | grep 5000

# クライアントPC側（PowerShell）
Test-NetConnection -ComputerName 10.100.0.10 -Port 5000
Invoke-RestMethod -Uri "http://10.100.0.10:5000/api/pcinfo?serial=ABC123456"
```

### 10.4 ネットワーク帯域不足

**症状**: 20台同時展開時に配信速度が極端に低下

**原因と対処**:

| 原因 | 確認方法 | 対処 |
|------|----------|------|
| スイッチ帯域飽和 | SNMP監視、ポート統計 | 10Gbpsアップリンク導入 |
| マルチキャストストーム | `iftop` | IGMP Snooping再設定 |
| NIC速度ネゴシエーション | `ethtool eth0` | 1000Mbps Full固定設定 |

**対処例**:
```bash
# NIC速度固定（1000Mbps Full Duplex）
ethtool -s eth0 speed 1000 duplex full autoneg off

# マルチキャスト配信速度制限（udpcast）
udp-sender --max-bitrate 400M
```

---

## 11. ネットワーク設定ファイル例

### 11.1 DRBLサーバ /etc/network/interfaces（Ubuntu）

```bash
# ループバック
auto lo
iface lo inet loopback

# 管理用NIC
auto eth0
iface eth0 inet static
    address 10.100.0.10
    netmask 255.255.0.0
    gateway 10.100.0.1
    dns-nameservers 10.100.0.100
    dns-search company.local

# PXE配信専用NIC（Optional、1NIC構成なら不要）
# auto eth1
# iface eth1 inet static
#     address 10.100.0.11
#     netmask 255.255.0.0
```

### 11.2 DHCPサーバ設定 /etc/dhcp/dhcpd.conf

```bash
# Global設定
option domain-name "company.local";
option domain-name-servers 10.100.0.100;
default-lease-time 600;
max-lease-time 7200;
authoritative;

# PXEブート設定
allow booting;
allow bootp;
next-server 10.100.0.10;
filename "pxelinux.0";

# キッティング用サブネット
subnet 10.100.0.0 netmask 255.255.0.0 {
    range 10.100.1.100 10.100.1.200;
    option routers 10.100.0.1;
    option broadcast-address 10.100.255.255;

    # PXEブート設定（BIOS）
    if exists user-class and option user-class = "iPXE" {
        filename "http://10.100.0.10/boot.ipxe";
    } elsif option arch = 00:00 {
        filename "pxelinux.0";
    }
    # UEFI
    elsif option arch = 00:07 {
        filename "bootx64.efi";
    }
}
```

### 11.3 TFTP設定 /etc/default/tftpd-hpa

```bash
TFTP_USERNAME="tftp"
TFTP_DIRECTORY="/tftpboot"
TFTP_ADDRESS="10.100.0.10:69"
TFTP_OPTIONS="--secure --verbose"
```

---

## 12. 将来の拡張性

### 12.1 スケールアップシナリオ

**現状（Phase 1）**:
- 同時展開: 10〜20台
- VLAN: 1セグメント
- DRBLサーバ: 1台

**拡張1（Phase 2: 50台同時展開）**:
- DRBLサーバ: 2台（負荷分散）
- VLAN: 2セグメント（VLAN 100, 101）
- 10Gbpsアップリンク導入

**拡張2（Phase 3: 複数拠点対応）**:
- 各拠点にDRBLサーバ配置
- 中央管理サーバ（Flask）: データベース集約
- VPN接続: 拠点間ログ統合

### 12.2 IPv6対応

**将来要件**:
- PXE over IPv6（DHCPv6）
- マルチキャスト: ff02::1〜ff0e::（IPv6）

---

## 13. 関連ドキュメント

| ドキュメント名 | パス | 説明 |
|----------------|------|------|
| システムアーキテクチャ設計書 | `/docs/02_設計/システムアーキテクチャ設計書.md` | 全体構成 |
| データベース設計書 | `/docs/02_設計/データベース設計書.md` | テーブル定義 |
| インターフェース設計書 | `/docs/02_設計/インターフェース設計書.md` | REST API詳細 |

---

## 14. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|------------|------|----------|--------|
| 1.0 | 2025-11-17 | 初版作成 | Network Architect |

---

**承認欄**

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| ネットワーク設計者 | | | |
| システムアーキテクト | | | |
| 技術責任者 | | | |
