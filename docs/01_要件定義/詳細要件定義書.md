# 📘 詳細要件定義書（完全版：会社キッティング自動化フレームワーク準拠）

本ドキュメントは、**マスターPC作成 → Sysprep → Clonezilla展開 → PC名自動設定（導入年月日＋M） → ODJ → ドメイン参加 → Windows Update → 完了** までを一気通貫で自動化する総合システムの要件定義である。

対象システムは以下を含む：
- Clonezilla Server Edition（DRBL）
- キッティング管理Webシステム（Flask想定）
- PC名自動設定／ODJ自動適用スクリプト（PowerShell）
- 展開後後処理自動化（Windows Update ＋ アプリ導入）

---

# 1. システム目的
- 年間100台規模の Windows PC を **完全自動キッティング** する。
- 展開担当者の作業を **「LANに挿して電源を入れるだけ」** にまで削減する。
- ドメイン参加・PC名命名規則・アプリ導入・更新処理・完了ログの全てを自動化。
- 人為的ミス（PC名入力ミス・ドメイン参加漏れ・更新漏れ）をゼロにする。

---

# 2. 全体構成（4レイヤー構造）

1. **マスターPC構築レイヤー**（Windows）
2. **前処理レイヤー（箱OCR）**（スマホ＋ChatGPT）
3. **インフラレイヤー（DRBL/Clonezilla＋管理GUI）**（Ubuntu）
4. **実行レイヤー（PXE展開〜後処理自動化）**（Windows）

---

# 3. 詳細要件

## 3.1 マスターPC構築レイヤー（Windows）
### 機能要件
- Windows 11 最新版をインストールしたマスターPCを構築する。
- 以下の会社標準構成を実装：
  - Microsoft 365 Apps
  - ブラウザ設定（Edge）
  - セキュリティソフト（Apex One 等）
  - KFM（Known Folder Move）設定
  - ローカル管理者の初期設定
- Sysprep を成功させるための前処理（削除／最適化）を実施。

### 非機能要件
- Sysprep成功率：100％（失敗しやすいAppX除外などの処理含む）
- マスター更新作業時間：2時間以内
- 1年に数回更新が可能な設計

---

## 3.2 前処理レイヤー（箱OCR）
### 機能要件
- PCが納品されたら、**箱の側面にあるSerial番号をスマホで撮影**する。
- ChatGPT（画像解析）でSerial番号を抽出する。
- 導入日ベースでPC名を自動生成する。
  - 命名規則：**YYYYMMDDM**（例：20251116M）
- 以下の形式でCSVを生成する：
  - PC名, Serial

### 非機能要件
- OCR精度：99％以上
- 人手入力ゼロ（コピーミス防止）
- 梱包を開ける必要がない

---

## 3.3 インフラレイヤー（DRBL/Clonezilla + 管理GUI）
### 機能要件
#### DRBL/Clonezilla サーバ
- PXEブート環境を提供する。
- Clonezilla Server Editionにより、
  - マスターイメージ（/home/partimag）を保持
  - 10〜20台同時展開（マルチキャスト）を行う

#### 管理データベース（Flask GUI）
- Serial番号とPC名（YYYYMMDDM）の管理
- ODJファイルのアップロードおよび紐付け
- CSVインポートにより100台以上の登録が可能

#### API 機能
Windowsクライアントから以下の形式で問い合わせ可能：
```
GET /api/pcinfo?serial=ABC123456
→ { pcname: "20251116M", odj: "/odj/20251116M.txt" }
```

### 非機能要件
- Ubuntu 22.04 で動作
- API応答時間：200ms以下（LAN環境）
- データ保全：SQLite or PostgreSQL
- 障害復旧：DBバックアップが容易であること

---

## 3.4 実行レイヤー（PXE → 完全自動化）
### 機能要件
1. PCをLANに接続して電源ONすると、以下が自動で進む：
   - PXE → Clonezilla起動
   - マスターイメージ展開
   - Windows起動

2. Windows初回起動後、自動ログオンし以下を実行：
   - Serial番号取得
   - DRBL API へ問い合わせ
   - PC名の自動設定（Rename-Computer）
   - 対応するODJファイルを取得
   - ODJ適用（djoin）
   - 再起動（1回）

3. ドメイン参加後、自動後処理：
   - Windows Update（複数回ループ対応）
   - 会社標準アプリインストール（PowerShell）
   - OneDrive KFM 有効化
   - セキュリティソフト稼働確認
   - 完了ログのDRBL管理GUIへの送信

### 非機能要件
- 10〜20台同時展開で性能劣化が1台当たり20％以内
- 展開開始 → 完了まで 60〜90分以内
- 展開失敗率：1％未満
- すべての操作は「無人」で完了できること

---

# 4. セキュリティ要件
- ChatGPT に送信するのは **シリアル番号のみ**（機微情報なし）
- API通信は社内LANのみ
- ODJファイルは権限付きフォルダに保存
- 展開後スクリプトは署名 or ハッシュ検証を行う

---

# 5. 運用要件
- 年間100台以上の展開を想定
- 新入社員PCの初期セットアップが数分で開始可能
- マスターイメージ更新手順を標準化
- 展開ログの長期保管（CSV/DB）

---

# 6. 拡張性要件
- 将来的に以下を追加できる構成：
  - 展開ステータスダッシュボード
  - 自動メール通知
  - Intune対応（将来）
  - PXEメニュー管理UI

---

# 7. 異常系要件
- DRBL API 不応答時 → 3回リトライ
- PC名取得不可 → 管理GUIへエラー送信
- ODJ適用失敗 → Windowsイベントログ送信

---

# 8. 成果物一覧
- マスターPC
- Sysprep用unattend.xml
- Clonezillaイメージ（MASTER_YYYY_vX）
- 管理GUI（Flask）
- 管理DB（PC名・Serial・ODJ）
- PowerShell自動設定スクリプト
- ODJファイル群
- 展開ログ

---

必要であれば、この要件定義をもとに
- **詳細設計書**
- **API仕様書**
- **データベース定義書**
- **PowerShellスクリプト設計書**
- **キッティング運用マニュアル**

などへそのまま展開できます。

