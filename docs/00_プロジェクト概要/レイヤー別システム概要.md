# 🏗 完全版：会社キッティング自動化フレームワーク（レイヤー別 再整理）

以下は、PCの **PXEブート → Clonezilla展開 → 自動PC名設定（導入年月日＋M） → ODJ → ドメイン参加 → 後処理 → 完了** に至る全工程を、レイヤーモデルで明確にしたフレームワークです。

---
# 1️⃣ マスターイメージレイヤー（Master Image Layer）

## ■ 目的
基準となる「会社仕様 Windows 11」を1台構築し、全PCに共通配布するための黄金イメージを作成するレイヤー。

## ■ 構成要素
- Windows 11 最新版
- 標準アプリ・ドライバ・セキュリティ設定
- 最適化・不要アプリ削除
- グループポリシー反映
- 自動セットアップ PowerShell の準備

## ■ 手順
1. 会社仕様で Windows 11 をセットアップ
2. unattend.xml 配置（Sysprep用）
3. Sysprep 実行
   ```bash
   sysprep /generalize /oobe /shutdown /unattend:unattend.xml
   ```
4. Clonezilla Live で起動
5. DRBLサーバ側の格納場所（/home/partimag）へイメージ取り込み

---
# 2️⃣ 納品・台帳レイヤー（Inventory / Mapping Layer）

## ■ 目的
梱包状態のPCを開封せずに **箱のSerial→PC名** を紐付けて管理台帳を作るレイヤー。

## ■ 手順
1. PCの箱の側面にある Serial をスマホで撮影
2. ChatGPT で OCR 抽出（自動テキスト化）
3. PC名を命名規則で生成
   - **導入年月日＋M**
   - 例：2025/11/16 → `20251116M`
4. PC名とSerialを CSV にまとめる
5. DRBL管理GUIへ CSV をインポート

---
# 3️⃣ DRBL / Clonezilla サーバレイヤー（Imaging Infrastructure Layer）

## ■ 目的
PXE で大量展開を制御し、各PCに適切なイメージを配布するレイヤー。

## ■ 主な要素
- DRBL Server
- Clonezilla Server Edition
- PXE / TFTP / DHCP 設定
- マルチキャスト展開
- イメージ配布の自動化設定

## ■ 管理DBの構成
- serial
- pcname
- odj_path
- 使用するイメージ名（固定指定）

---
# 4️⃣ ODJ（オフラインドメイン参加）レイヤー（ODJ Provisioning Layer）

## ■ 目的
PC名ごとに **事前にドメイン参加権限を付与した ODJファイル** を生成し、自動ドメイン参加を可能にする。

## ■ 手順
1. DCで ODJ ファイル作成
   ```cmd
   djoin /provision /domain corp.local /machine 20251116M /savefile 20251116M.txt /reuse
   ```
2. 生成した ODJ ファイルを DRBL サーバに格納
3. DBの各PCエントリと紐付ける

---
# 5️⃣ PXEブート / 自動展開レイヤー（Deployment Execution Layer）

## ■ 目的
PCをLANに繋いで電源を入れるだけで **無人イメージ展開** を実現する。

## ■ 流れ
1. PCをLANに接続して電源ON
2. PXEブートで DRBL に接続
3. 自動展開モード（固定イメージ）で Clonezilla が開始
4. OSイメージを展開
5. 展開終了 → Windows自動起動へ

---
# 6️⃣ Windows 初期設定レイヤー（Windows Auto-Setup Layer）

## ■ 目的
Windows 初回起動後のセットアップを完全自動化してドメイン参加まで進める。

## ■ 自動化される処理
### 🔹 Step1：Serial 取得
```powershell
(Get-CimInstance Win32_BIOS).SerialNumber
```

### 🔹 Step2：DRBL APIへ問い合わせ → PC名取得
- serial → pcname
- odj_path を取得

### 🔹 Step3：PC名を自動設定
```powershell
Rename-Computer -NewName "20251116M" -Force
```

### 🔹 Step4：ODJファイル自動適用
```powershell
djoin /requestODJ /loadfile C:\ODJ\20251116M.txt /localos
```

### 🔹 Step5：再起動
- 再起動後は **ドメイン参加済み**

---
# 7️⃣ Windows 後処理レイヤー（Post-Setup Automation Layer）

## ■ 目的
ユーザーが使う前に必要な全ての初期設定を自動実行。

## ■ 自動化処理
- Windows Update
- 標準アプリ自動インストール
- OneDrive KFM 有効化
- Teams / OneDrive 初期キャッシュ作成
- FortiClient VPN プロファイル配置（ユーザー名のみ）
- SMB1.0 有効化
- 共有フォルダ事前作成
- 完了ログをAPIへ送信

---
# 8️⃣ 利用者ログオンレイヤー（User Login Layer）

## ■ 目的
ユーザー自身がADアカウントで初回ログオンし、業務開始できる状態にする。

## ■ ポイント
- ドメイン参加済み → PC名設定済み
- 初回ログオンは **ユーザー本人が手入力**（パスワード必須）
- ログオン後は追加セットアップ不要

---
# 9️⃣ 運用モニタリングレイヤー（Operations & Monitoring Layer）

## ■ 自動収集する情報
- 展開完了ログ
- ドメイン参加ログ
- Windows Update 結果
- アプリインストール結果

## ■ 管理GUIで可視化
- Serial
- PC名
- 状態（waiting / deploying / odj / completed）
- 失敗時のログ閲覧

---
# 🎉 最終まとめ：ワンストップ自動化の全体像

```
[マスターPC作成]
     ↓
[Sysprep]
     ↓
[Clonezilla イメージ化]
     ↓
[Serial → PC名自動生成]
     ↓
[DRBL管理DB登録]
     ↓
[ODJファイル生成]
     ↓
[PXEで自動展開]
     ↓
[Windowsが自分のPC名を設定]
     ↓
[ODJでドメイン参加]
     ↓
[後処理自動化]
     ↓
[ユーザー初回ログイン]
     ↓
🎉 運用可能状態！
```

---
必要であれば、各レイヤーの **UML図 / BPMN / シーケンス図 / GUIモック** も追加できます。

