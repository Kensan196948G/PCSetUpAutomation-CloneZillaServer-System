# 🚀 デプロイメントガイド

PC Setup Automation システムの本番環境デプロイ手順書

---

## システム情報

- **プロジェクト名**: PC Setup Automation
- **バージョン**: 1.0.0
- **デプロイ日**: 2025-11-17
- **OS**: Ubuntu 24.04.3 LTS (Noble)
- **Python**: 3.12.3

---

## 🎯 デプロイ完了状況

### ✅ 完了項目

| 項目 | 状態 | 詳細 |
|------|------|------|
| Python仮想環境 | ✅ 完了 | venv作成、依存パッケージインストール完了 |
| データベース初期化 | ✅ 完了 | SQLite (pc_setup.db) 作成、テーブル・インデックス作成完了 |
| テストデータ投入 | ✅ 完了 | 3台のPC、3件のログ登録 |
| Flaskアプリケーション起動 | ✅ 完了 | http://localhost:5000 で稼働中 |
| WebUI動作確認 | ✅ 完了 | ダッシュボード、API動作確認済み |
| ビュー実装 | ✅ 完了 | PC管理、ログ表示、統計情報表示 |

### ⏳ 未実装項目

| 項目 | 優先度 | 推定時間 |
|------|--------|---------|
| DRBL/Clonezillaインストール | 高 | 1時間 |
| Nginx リバースプロキシ設定 | 中 | 30分 |
| Gunicorn プロダクションWSGI | 中 | 30分 |
| systemd サービス登録 | 中 | 15分 |
| PostgreSQL移行（オプション） | 低 | 1時間 |
| SSL証明書設定（オプション） | 低 | 30分 |

---

## 📍 現在のアクセスURL

### ローカルアクセス
- **URL**: http://127.0.0.1:5000
- **用途**: サーバー内部からのアクセス

### ネットワークアクセス
- **URL**: http://192.168.3.135:5000
- **用途**: 社内LANからのアクセス

### APIエンドポイント
| エンドポイント | メソッド | 説明 |
|--------------|---------|------|
| `/` | GET | ダッシュボード |
| `/health` | GET | ヘルスチェック |
| `/api/pcinfo?serial=XXX` | GET | PC情報取得 |
| `/api/log` | POST | セットアップログ登録 |
| `/api/pcs` | GET | PC一覧取得 |
| `/api/pcs` | POST | PC登録 |
| `/api/pcs/<id>` | PUT | PC更新 |
| `/api/pcs/<id>` | DELETE | PC削除 |
| `/pcs` | GET | PC管理画面 |
| `/pcs/add` | GET/POST | PC登録フォーム |
| `/logs` | GET | セットアップログ画面 |

---

## 🔧 起動・停止コマンド

### Flaskアプリケーション

#### 起動
```bash
cd /mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project
source venv/bin/activate
cd flask-app
nohup python3 app.py > ../logs/flask.log 2>&1 &
echo $! > ../logs/flask.pid
```

#### 停止
```bash
kill $(cat /mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/logs/flask.pid)
```

#### ログ確認
```bash
tail -f /mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/logs/flask.log
```

### ステータス確認
```bash
# ヘルスチェック
curl http://localhost:5000/health

# プロセス確認
ps aux | grep "python3 app.py"
```

---

## 📦 データベース情報

### 接続情報
- **タイプ**: SQLite
- **ファイル**: `/mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/pc_setup.db`
- **サイズ**: ~20KB（テストデータ含む）

### テーブル構造

#### pc_master テーブル
| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | INTEGER | PRIMARY KEY | 自動採番ID |
| serial | VARCHAR(100) | UNIQUE, NOT NULL | PCシリアル番号 |
| pcname | VARCHAR(50) | NOT NULL | PC名（YYYYMMDDM形式） |
| odj_path | VARCHAR(255) | NULL | ODJファイルパス |
| created_at | DATETIME | NOT NULL | 作成日時 |
| updated_at | DATETIME | NOT NULL | 更新日時 |

**インデックス:**
- UNIQUE INDEX on `serial`
- INDEX on `pcname`

#### setup_logs テーブル
| カラム名 | 型 | 制約 | 説明 |
|---------|---|------|------|
| id | INTEGER | PRIMARY KEY | 自動採番ID |
| serial | VARCHAR(100) | NOT NULL | PCシリアル番号 |
| pcname | VARCHAR(50) | NOT NULL | PC名 |
| status | VARCHAR(20) | NOT NULL | ステータス |
| timestamp | DATETIME | NOT NULL | タイムスタンプ |
| logs | TEXT | NULL | ログメッセージ |
| step | VARCHAR(50) | NULL | 現在のステップ |
| error_message | TEXT | NULL | エラーメッセージ |

**インデックス:**
- INDEX on `status`
- INDEX on `serial`
- INDEX on `pcname`
- INDEX on `timestamp`

### データ操作

#### バックアップ
```bash
cp pc_setup.db pc_setup_backup_$(date +%Y%m%d_%H%M%S).db
```

#### リストア
```bash
cp pc_setup_backup_YYYYMMDD_HHMMSS.db pc_setup.db
```

#### データ確認（SQLite CLI）
```bash
sqlite3 pc_setup.db
```

SQLite内で：
```sql
-- PC一覧
SELECT * FROM pc_master;

-- ログ一覧
SELECT * FROM setup_logs ORDER BY timestamp DESC LIMIT 10;

-- 統計情報
SELECT
    COUNT(*) as total_pcs,
    (SELECT COUNT(*) FROM setup_logs WHERE status='completed') as completed,
    (SELECT COUNT(*) FROM setup_logs WHERE status='in_progress') as in_progress,
    (SELECT COUNT(*) FROM setup_logs WHERE status='failed') as failed
FROM pc_master;
```

---

## 🌐 本番環境への移行（推奨）

### 1. Gunicorn + Nginx構成

#### Gunicornインストール
```bash
source venv/bin/activate
pip install gunicorn
```

#### Gunicorn起動
```bash
cd flask-app
gunicorn -w 4 -b 0.0.0.0:5000 --access-logfile ../logs/access.log --error-logfile ../logs/error.log 'app:create_app()'
```

#### systemd サービス登録
`/etc/systemd/system/pc-setup.service`:
```ini
[Unit]
Description=PC Setup Automation Flask App
After=network.target

[Service]
User=kensan
Group=kensan
WorkingDirectory=/mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/flask-app
Environment="PATH=/mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/venv/bin"
ExecStart=/mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 'app:create_app()'
Restart=always

[Install]
WantedBy=multi-user.target
```

有効化：
```bash
sudo systemctl daemon-reload
sudo systemctl enable pc-setup
sudo systemctl start pc-setup
sudo systemctl status pc-setup
```

#### Nginxインストール・設定
```bash
sudo apt update
sudo apt install -y nginx
```

`/etc/nginx/sites-available/pc-setup`:
```nginx
server {
    listen 80;
    server_name 192.168.3.135;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    location /static {
        alias /mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/flask-app/static;
    }
}
```

有効化：
```bash
sudo ln -s /etc/nginx/sites-available/pc-setup /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 2. PostgreSQL移行（オプション）

#### PostgreSQLインストール
```bash
sudo apt update
sudo apt install -y postgresql postgresql-contrib
```

#### データベース作成
```bash
sudo -u postgres psql
```

PostgreSQL内で：
```sql
CREATE DATABASE pc_setup_db;
CREATE USER pc_setup_user WITH PASSWORD 'your_password_here';
GRANT ALL PRIVILEGES ON DATABASE pc_setup_db TO pc_setup_user;
\q
```

#### .env更新
```.env
DATABASE_URL=postgresql://pc_setup_user:your_password_here@localhost:5432/pc_setup_db
```

#### マイグレーション
```bash
cd flask-app
flask db init
flask db migrate -m "Initial migration"
flask db upgrade
```

---

## 🔐 セキュリティ設定

### 1. ファイアウォール設定
```bash
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS（将来用）
sudo ufw enable
```

### 2. アプリケーション設定

#### SECRET_KEY変更
.envファイル：
```bash
SECRET_KEY=$(python3 -c 'import secrets; print(secrets.token_hex(32))')
echo "SECRET_KEY=$SECRET_KEY" >> .env
```

#### デバッグモード無効化
本番環境では `FLASK_ENV=production` に設定

---

## 📊 監視・ログ

### アプリケーションログ
```bash
# リアルタイム監視
tail -f /mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/logs/flask.log

# エラーのみ抽出
grep ERROR /mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/logs/flask.log
```

### アクセスログ（Gunicorn使用時）
```bash
tail -f /mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/logs/access.log
```

### システムログ（systemd使用時）
```bash
sudo journalctl -u pc-setup -f
```

---

## 🧪 テスト実行

### APIテスト
```bash
# PC情報取得
curl http://localhost:5000/api/pcinfo?serial=TEST001

# PC登録
curl -X POST http://localhost:5000/api/pcs \
  -H "Content-Type: application/json" \
  -d '{"serial":"TEST999","pcname":"20251117M","odj_path":"/srv/odj/20251117M.txt"}'

# ログ登録
curl -X POST http://localhost:5000/api/log \
  -H "Content-Type: application/json" \
  -d '{"serial":"TEST001","pcname":"20251116M","status":"completed","timestamp":"2025-11-17 12:00:00"}'
```

### 自動テスト実行
```bash
cd /mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project
source venv/bin/activate
pytest tests/ -v
```

---

## 🚨 トラブルシューティング

### アプリケーションが起動しない
```bash
# ログ確認
tail -50 logs/flask.log

# ポート使用状況確認
sudo lsof -i :5000

# プロセス確認
ps aux | grep python
```

### データベースエラー
```bash
# データベースファイルの確認
ls -lh pc_setup.db

# 権限確認
ls -l pc_setup.db

# バックアップから復元
cp pc_setup_backup_*.db pc_setup.db
```

### APIが応答しない
```bash
# ヘルスチェック
curl -v http://localhost:5000/health

# ネットワーク確認
ping 192.168.3.135

# ファイアウォール確認
sudo ufw status
```

---

## 📞 サポート

問題が発生した場合は、以下を確認してください：

1. ログファイル: `/mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/logs/flask.log`
2. テスト結果: `TEST_RESULTS_SUMMARY.md`
3. プロジェクトドキュメント: `README.md`

---

**デプロイ完了日**: 2025-11-17
**デプロイ担当**: Claude Code + kensan
**システムステータス**: ✅ 稼働中
