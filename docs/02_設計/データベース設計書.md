# データベース設計書

**文書番号**: DB-001
**バージョン**: 1.0
**作成日**: 2025-11-17
**最終更新日**: 2025-11-17

---

## 1. 概要

本書は、会社キッティング自動化フレームワークで使用するデータベースの設計を定義します。PC管理マスタとセットアップログを管理し、REST API経由でのデータ提供を実現します。

### 1.1 データベース種別選定

| 項目 | SQLite | PostgreSQL |
|------|--------|------------|
| 用途 | 小規模（年間100台程度） | 大規模（年間500台以上） |
| メリット | セットアップ不要、軽量 | 高性能、並行処理強い |
| デメリット | 並行書込制限 | セットアップ・運用コスト |
| 推奨環境 | 単一サーバ、小規模運用 | 複数サーバ、大規模運用 |

**本プロジェクト採用**: **SQLite**（年間100台規模、単一サーバ運用のため）

---

## 2. データベース構成

### 2.1 データベースファイル

**SQLiteの場合**:
- ファイルパス: `/var/lib/pc-setup/db.sqlite3`
- 権限: `640` (所有者:rw、グループ:r)
- 所有者: `flask-app:flask-app`

**PostgreSQLの場合**:
- データベース名: `pc_setup`
- ユーザー: `flask_app`
- パスワード: 環境変数管理
- 接続: localhost:5432

### 2.2 テーブル一覧

| テーブル名 | 用途 | レコード数想定 |
|------------|------|----------------|
| pc_master | PC基本情報管理 | 累計1000件/年 |
| setup_logs | セットアップログ | 累計5000件/年 |

---

## 3. テーブル定義

### 3.1 pc_masterテーブル（PC基本情報）

**用途**: Serial番号とPC名、ODJファイルパスの紐付け管理

#### SQLite版 CREATE TABLE文

```sql
CREATE TABLE pc_master (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    serial TEXT NOT NULL UNIQUE,
    pcname TEXT NOT NULL,
    odj_path TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- インデックス作成
CREATE INDEX idx_pc_master_serial ON pc_master(serial);
CREATE INDEX idx_pc_master_pcname ON pc_master(pcname);
CREATE INDEX idx_pc_master_created_at ON pc_master(created_at);

-- 更新日時自動更新トリガー
CREATE TRIGGER update_pc_master_timestamp
AFTER UPDATE ON pc_master
FOR EACH ROW
BEGIN
    UPDATE pc_master SET updated_at = CURRENT_TIMESTAMP WHERE id = NEW.id;
END;
```

#### PostgreSQL版 CREATE TABLE文

```sql
CREATE TABLE pc_master (
    id SERIAL PRIMARY KEY,
    serial VARCHAR(50) NOT NULL UNIQUE,
    pcname VARCHAR(50) NOT NULL,
    odj_path VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- インデックス作成
CREATE INDEX idx_pc_master_serial ON pc_master(serial);
CREATE INDEX idx_pc_master_pcname ON pc_master(pcname);
CREATE INDEX idx_pc_master_created_at ON pc_master(created_at);

-- 更新日時自動更新関数
CREATE OR REPLACE FUNCTION update_modified_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_pc_master_timestamp
BEFORE UPDATE ON pc_master
FOR EACH ROW
EXECUTE FUNCTION update_modified_column();
```

#### カラム定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| id | INTEGER/SERIAL | NOT NULL | AUTO | 主キー（自動採番） |
| serial | TEXT/VARCHAR(50) | NOT NULL | - | PCのBIOS Serial番号（UNIQUE制約） |
| pcname | TEXT/VARCHAR(50) | NOT NULL | - | PC名（YYYYMMDDM形式） |
| odj_path | TEXT/VARCHAR(255) | NULL | - | ODJファイルの絶対パス |
| created_at | DATETIME/TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | レコード作成日時 |
| updated_at | DATETIME/TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | レコード更新日時（トリガーで自動更新） |

#### 制約

- PRIMARY KEY: `id`
- UNIQUE: `serial`（同一Serial重複登録防止）

#### サンプルデータ

```sql
INSERT INTO pc_master (serial, pcname, odj_path) VALUES
('ABC123456', '20251116M', '/srv/odj/20251116M.txt'),
('DEF789012', '20251116M', '/srv/odj/20251116M.txt'),
('GHI345678', '20251117M', '/srv/odj/20251117M.txt');
```

---

### 3.2 setup_logsテーブル（セットアップログ）

**用途**: セットアップ処理の進捗・完了・エラーログ記録

#### SQLite版 CREATE TABLE文

```sql
CREATE TABLE setup_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    serial TEXT NOT NULL,
    pcname TEXT NOT NULL,
    status TEXT NOT NULL,
    phase TEXT,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    logs TEXT,
    error_message TEXT
);

-- インデックス作成
CREATE INDEX idx_setup_logs_serial ON setup_logs(serial);
CREATE INDEX idx_setup_logs_pcname ON setup_logs(pcname);
CREATE INDEX idx_setup_logs_status ON setup_logs(status);
CREATE INDEX idx_setup_logs_timestamp ON setup_logs(timestamp);
CREATE INDEX idx_setup_logs_composite ON setup_logs(serial, timestamp);
```

#### PostgreSQL版 CREATE TABLE文

```sql
CREATE TABLE setup_logs (
    id SERIAL PRIMARY KEY,
    serial VARCHAR(50) NOT NULL,
    pcname VARCHAR(50) NOT NULL,
    status VARCHAR(20) NOT NULL,
    phase VARCHAR(50),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    logs TEXT,
    error_message TEXT
);

-- インデックス作成
CREATE INDEX idx_setup_logs_serial ON setup_logs(serial);
CREATE INDEX idx_setup_logs_pcname ON setup_logs(pcname);
CREATE INDEX idx_setup_logs_status ON setup_logs(status);
CREATE INDEX idx_setup_logs_timestamp ON setup_logs(timestamp);
CREATE INDEX idx_setup_logs_composite ON setup_logs(serial, timestamp);
```

#### カラム定義

| カラム名 | データ型 | NULL | デフォルト | 説明 |
|----------|----------|------|------------|------|
| id | INTEGER/SERIAL | NOT NULL | AUTO | 主キー（自動採番） |
| serial | TEXT/VARCHAR(50) | NOT NULL | - | PCのBIOS Serial番号 |
| pcname | TEXT/VARCHAR(50) | NOT NULL | - | PC名（YYYYMMDDM形式） |
| status | TEXT/VARCHAR(20) | NOT NULL | - | セットアップ状態（下記参照） |
| phase | TEXT/VARCHAR(50) | NULL | - | セットアップフェーズ（下記参照） |
| timestamp | DATETIME/TIMESTAMP | NOT NULL | CURRENT_TIMESTAMP | ログ記録日時 |
| logs | TEXT | NULL | - | 詳細ログメッセージ |
| error_message | TEXT | NULL | - | エラー発生時のメッセージ |

#### status値定義

| status値 | 説明 | 備考 |
|----------|------|------|
| started | セットアップ開始 | Windows初回起動時 |
| api_called | API問い合わせ完了 | GET /api/pcinfo成功 |
| pc_renamed | PC名設定完了 | Rename-Computer成功 |
| odj_applied | ODJ適用完了 | djoin実行成功 |
| rebooted | 再起動完了 | ドメイン参加後 |
| windows_update_started | Windows Update開始 | |
| windows_update_completed | Windows Update完了 | |
| apps_installed | アプリインストール完了 | |
| completed | すべて完了 | 最終状態 |
| failed | セットアップ失敗 | エラー発生 |
| pending | 保留中 | 手動介入待ち |

#### phase値定義

| phase値 | 説明 |
|----------|------|
| initialization | 初期化処理 |
| api_communication | API通信処理 |
| pc_configuration | PC設定処理 |
| domain_join | ドメイン参加処理 |
| windows_update | Windows Update処理 |
| application_install | アプリインストール処理 |
| finalization | 最終処理 |
| error_handling | エラーハンドリング |

#### サンプルデータ

```sql
INSERT INTO setup_logs (serial, pcname, status, phase, logs) VALUES
('ABC123456', '20251116M', 'started', 'initialization', 'Setup script started'),
('ABC123456', '20251116M', 'api_called', 'api_communication', 'GET /api/pcinfo success'),
('ABC123456', '20251116M', 'pc_renamed', 'pc_configuration', 'Renamed to 20251116M'),
('ABC123456', '20251116M', 'odj_applied', 'domain_join', 'ODJ applied successfully'),
('ABC123456', '20251116M', 'windows_update_completed', 'windows_update', '25 updates installed'),
('ABC123456', '20251116M', 'apps_installed', 'application_install', 'All apps installed'),
('ABC123456', '20251116M', 'completed', 'finalization', 'Setup completed successfully');

-- エラー例
INSERT INTO setup_logs (serial, pcname, status, phase, error_message) VALUES
('DEF789012', '20251116M', 'failed', 'domain_join', 'ODJ file not found: /srv/odj/20251116M.txt');
```

---

## 4. インデックス戦略

### 4.1 pc_masterテーブル

| インデックス名 | カラム | 目的 |
|----------------|--------|------|
| idx_pc_master_serial | serial | API検索（GET /api/pcinfo?serial=XXX）高速化 |
| idx_pc_master_pcname | pcname | PC名検索高速化 |
| idx_pc_master_created_at | created_at | 登録日ソート高速化 |

### 4.2 setup_logsテーブル

| インデックス名 | カラム | 目的 |
|----------------|--------|------|
| idx_setup_logs_serial | serial | Serial番号でのログ検索 |
| idx_setup_logs_pcname | pcname | PC名でのログ検索 |
| idx_setup_logs_status | status | ステータス別集計 |
| idx_setup_logs_timestamp | timestamp | 時系列ソート |
| idx_setup_logs_composite | serial, timestamp | Serial番号の時系列ログ検索 |

---

## 5. データベース操作例

### 5.1 INSERT操作

#### PC基本情報登録

```sql
-- 単一登録
INSERT INTO pc_master (serial, pcname, odj_path)
VALUES ('ABC123456', '20251116M', '/srv/odj/20251116M.txt');

-- 複数登録
INSERT INTO pc_master (serial, pcname, odj_path) VALUES
('ABC123456', '20251116M', '/srv/odj/20251116M.txt'),
('DEF789012', '20251116M', '/srv/odj/20251116M.txt'),
('GHI345678', '20251117M', '/srv/odj/20251117M.txt');
```

#### セットアップログ記録

```sql
INSERT INTO setup_logs (serial, pcname, status, phase, logs)
VALUES ('ABC123456', '20251116M', 'completed', 'finalization', 'Setup completed successfully');

-- エラーログ記録
INSERT INTO setup_logs (serial, pcname, status, phase, error_message)
VALUES ('DEF789012', '20251116M', 'failed', 'api_communication', 'API server timeout after 3 retries');
```

### 5.2 SELECT操作

#### API用クエリ（GET /api/pcinfo）

```sql
-- Serial番号からPC情報取得
SELECT pcname, odj_path
FROM pc_master
WHERE serial = 'ABC123456';

-- Python Flask例
# SELECT pcname, odj_path FROM pc_master WHERE serial = ?
result = db.execute("SELECT pcname, odj_path FROM pc_master WHERE serial = ?", (serial,)).fetchone()
if result:
    return {"pcname": result[0], "odj_path": result[1]}
else:
    return {"error": "PC not found"}, 404
```

#### セットアップログ取得

```sql
-- Serial番号の全ログを時系列で取得
SELECT id, status, phase, timestamp, logs, error_message
FROM setup_logs
WHERE serial = 'ABC123456'
ORDER BY timestamp ASC;

-- 最新ステータス取得
SELECT status, phase, timestamp
FROM setup_logs
WHERE serial = 'ABC123456'
ORDER BY timestamp DESC
LIMIT 1;

-- 完了済みPC一覧
SELECT DISTINCT serial, pcname
FROM setup_logs
WHERE status = 'completed'
ORDER BY timestamp DESC;

-- 失敗PC一覧
SELECT DISTINCT serial, pcname, error_message, timestamp
FROM setup_logs
WHERE status = 'failed'
ORDER BY timestamp DESC;
```

#### 統計クエリ

```sql
-- 日別セットアップ完了数
SELECT DATE(timestamp) AS setup_date, COUNT(DISTINCT serial) AS completed_count
FROM setup_logs
WHERE status = 'completed'
GROUP BY DATE(timestamp)
ORDER BY setup_date DESC;

-- ステータス別集計
SELECT status, COUNT(*) AS count
FROM setup_logs
GROUP BY status
ORDER BY count DESC;

-- フェーズ別失敗数
SELECT phase, COUNT(*) AS failure_count
FROM setup_logs
WHERE status = 'failed'
GROUP BY phase
ORDER BY failure_count DESC;
```

### 5.3 UPDATE操作

```sql
-- ODJパス更新
UPDATE pc_master
SET odj_path = '/srv/odj/20251116M_new.txt'
WHERE serial = 'ABC123456';

-- PC名変更（稀）
UPDATE pc_master
SET pcname = '20251118M'
WHERE serial = 'ABC123456';
```

### 5.4 DELETE操作

```sql
-- PC基本情報削除（運用中は非推奨、論理削除推奨）
DELETE FROM pc_master WHERE serial = 'ABC123456';

-- 古いログ削除（1年以上前）
DELETE FROM setup_logs WHERE timestamp < datetime('now', '-1 year');
```

---

## 6. CSV一括インポート

### 6.1 CSVフォーマット

**pc_master.csv**:
```csv
serial,pcname,odj_path
ABC123456,20251116M,/srv/odj/20251116M.txt
DEF789012,20251116M,/srv/odj/20251116M.txt
GHI345678,20251117M,/srv/odj/20251117M.txt
```

### 6.2 SQLiteへのインポート

```bash
# コマンドライン
sqlite3 /var/lib/pc-setup/db.sqlite3 <<EOF
.mode csv
.import pc_master.csv pc_master_temp
INSERT INTO pc_master (serial, pcname, odj_path)
SELECT serial, pcname, odj_path FROM pc_master_temp
WHERE serial NOT IN (SELECT serial FROM pc_master);
DROP TABLE pc_master_temp;
EOF
```

### 6.3 Pythonスクリプトでのインポート

```python
import sqlite3
import csv

def import_csv_to_db(csv_file, db_file):
    conn = sqlite3.connect(db_file)
    cursor = conn.cursor()

    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        for row in reader:
            try:
                cursor.execute(
                    "INSERT INTO pc_master (serial, pcname, odj_path) VALUES (?, ?, ?)",
                    (row['serial'], row['pcname'], row['odj_path'])
                )
            except sqlite3.IntegrityError as e:
                print(f"Skip duplicate serial: {row['serial']}")

    conn.commit()
    conn.close()

# 実行例
import_csv_to_db('pc_master.csv', '/var/lib/pc-setup/db.sqlite3')
```

---

## 7. バックアップ・リストア

### 7.1 SQLiteバックアップ

#### 方法1: ファイルコピー

```bash
# デイリーバックアップ（cron設定）
#!/bin/bash
BACKUP_DIR="/var/backups/pc-setup"
DATE=$(date +%Y%m%d)
cp /var/lib/pc-setup/db.sqlite3 $BACKUP_DIR/db_$DATE.sqlite3
gzip $BACKUP_DIR/db_$DATE.sqlite3

# 7日以上前のバックアップ削除
find $BACKUP_DIR -name "db_*.sqlite3.gz" -mtime +7 -delete
```

#### 方法2: SQLダンプ

```bash
# ダンプ
sqlite3 /var/lib/pc-setup/db.sqlite3 .dump > backup_$(date +%Y%m%d).sql
gzip backup_$(date +%Y%m%d).sql

# リストア
gunzip backup_20251116.sql.gz
sqlite3 /var/lib/pc-setup/db_restore.sqlite3 < backup_20251116.sql
```

### 7.2 PostgreSQLバックアップ

```bash
# バックアップ
pg_dump -U flask_app -h localhost -F c pc_setup > /var/backups/pc_setup_$(date +%Y%m%d).dump

# リストア
pg_restore -U flask_app -h localhost -d pc_setup /var/backups/pc_setup_20251116.dump
```

### 7.3 自動バックアップcron設定

```bash
# /etc/cron.d/pc-setup-backup
0 2 * * * root /usr/local/bin/backup_pc_setup_db.sh
```

---

## 8. パフォーマンス最適化

### 8.1 クエリ最適化

#### EXPLAIN分析（SQLite）

```sql
-- インデックス使用確認
EXPLAIN QUERY PLAN
SELECT pcname, odj_path FROM pc_master WHERE serial = 'ABC123456';

-- 期待される出力: SEARCH TABLE pc_master USING INDEX idx_pc_master_serial
```

#### VACUUM実行（SQLite）

```sql
-- データベース最適化（月次推奨）
VACUUM;

-- 自動VACUUM有効化
PRAGMA auto_vacuum = FULL;
```

### 8.2 接続プーリング（Flask + SQLAlchemy）

```python
from flask_sqlalchemy import SQLAlchemy

app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:////var/lib/pc-setup/db.sqlite3'
app.config['SQLALCHEMY_POOL_SIZE'] = 10
app.config['SQLALCHEMY_POOL_TIMEOUT'] = 30
app.config['SQLALCHEMY_POOL_RECYCLE'] = 3600

db = SQLAlchemy(app)
```

---

## 9. セキュリティ

### 9.1 アクセス制御

```bash
# SQLiteファイル権限
chown flask-app:flask-app /var/lib/pc-setup/db.sqlite3
chmod 640 /var/lib/pc-setup/db.sqlite3

# ディレクトリ権限
chown flask-app:flask-app /var/lib/pc-setup
chmod 750 /var/lib/pc-setup
```

### 9.2 SQLインジェクション対策

```python
# ❌ 危険（SQLインジェクション脆弱性）
serial = request.args.get('serial')
query = f"SELECT * FROM pc_master WHERE serial = '{serial}'"
cursor.execute(query)

# ✅ 安全（パラメータ化クエリ）
serial = request.args.get('serial')
query = "SELECT * FROM pc_master WHERE serial = ?"
cursor.execute(query, (serial,))
```

### 9.3 暗号化（PostgreSQL）

```sql
-- 機密情報暗号化（pgcrypto拡張）
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 暗号化して保存
INSERT INTO pc_master (serial, pcname, odj_path)
VALUES (pgp_sym_encrypt('ABC123456', 'encryption_key'), '20251116M', '/srv/odj/20251116M.txt');

-- 復号化して取得
SELECT pgp_sym_decrypt(serial::bytea, 'encryption_key') AS serial FROM pc_master;
```

---

## 10. データ保持ポリシー

### 10.1 保持期間

| テーブル | 保持期間 | 削除方法 |
|----------|----------|----------|
| pc_master | 永続（5年） | 手動削除 |
| setup_logs | 1年 | 自動削除（cron） |

### 10.2 自動削除スクリプト

```bash
#!/bin/bash
# /usr/local/bin/cleanup_old_logs.sh

sqlite3 /var/lib/pc-setup/db.sqlite3 <<EOF
DELETE FROM setup_logs WHERE timestamp < datetime('now', '-1 year');
VACUUM;
EOF

echo "Old logs deleted: $(date)" >> /var/log/pc-setup/cleanup.log
```

```bash
# cron設定（毎月1日午前3時）
0 3 1 * * root /usr/local/bin/cleanup_old_logs.sh
```

---

## 11. マイグレーション

### 11.1 スキーマ変更例（カラム追加）

```sql
-- pc_masterにメーカー情報追加
ALTER TABLE pc_master ADD COLUMN manufacturer TEXT;

-- setup_logsに完了時間追加
ALTER TABLE setup_logs ADD COLUMN duration_minutes INTEGER;
```

### 11.2 データ移行（SQLite → PostgreSQL）

```bash
# 1. SQLiteからダンプ
sqlite3 /var/lib/pc-setup/db.sqlite3 .dump > sqlite_dump.sql

# 2. PostgreSQL互換に変換（sed使用）
sed -i 's/AUTOINCREMENT//' sqlite_dump.sql
sed -i 's/INTEGER PRIMARY KEY/SERIAL PRIMARY KEY/' sqlite_dump.sql

# 3. PostgreSQLへインポート
psql -U flask_app -d pc_setup < sqlite_dump.sql
```

---

## 12. SQLAlchemyモデル定義（Python Flask）

```python
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime

db = SQLAlchemy()

class PCMaster(db.Model):
    __tablename__ = 'pc_master'

    id = db.Column(db.Integer, primary_key=True)
    serial = db.Column(db.String(50), unique=True, nullable=False, index=True)
    pcname = db.Column(db.String(50), nullable=False, index=True)
    odj_path = db.Column(db.String(255))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    updated_at = db.Column(db.DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    def to_dict(self):
        return {
            'id': self.id,
            'serial': self.serial,
            'pcname': self.pcname,
            'odj_path': self.odj_path,
            'created_at': self.created_at.isoformat(),
            'updated_at': self.updated_at.isoformat()
        }

class SetupLog(db.Model):
    __tablename__ = 'setup_logs'

    id = db.Column(db.Integer, primary_key=True)
    serial = db.Column(db.String(50), nullable=False, index=True)
    pcname = db.Column(db.String(50), nullable=False, index=True)
    status = db.Column(db.String(20), nullable=False, index=True)
    phase = db.Column(db.String(50))
    timestamp = db.Column(db.DateTime, default=datetime.utcnow, index=True)
    logs = db.Column(db.Text)
    error_message = db.Column(db.Text)

    def to_dict(self):
        return {
            'id': self.id,
            'serial': self.serial,
            'pcname': self.pcname,
            'status': self.status,
            'phase': self.phase,
            'timestamp': self.timestamp.isoformat(),
            'logs': self.logs,
            'error_message': self.error_message
        }
```

---

## 13. 関連ドキュメント

| ドキュメント名 | パス | 説明 |
|----------------|------|------|
| システムアーキテクチャ設計書 | `/docs/02_設計/システムアーキテクチャ設計書.md` | 全体構成 |
| インターフェース設計書 | `/docs/02_設計/インターフェース設計書.md` | REST API仕様 |
| 実装ガイド | `/docs/03_実装/` | Flask実装詳細 |

---

## 14. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|------------|------|----------|--------|
| 1.0 | 2025-11-17 | 初版作成 | Database Architect |

---

**承認欄**

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| データベース設計者 | | | |
| システムアーキテクト | | | |
| 技術責任者 | | | |
