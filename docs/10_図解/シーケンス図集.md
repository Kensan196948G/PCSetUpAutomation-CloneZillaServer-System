# シーケンス図集

## 概要

会社キッティング自動化フレームワークにおける主要なプロセスフローをシーケンス図で示します。

## 目次

1. [PXEブート〜Clonezilla展開シーケンス](#pxeブートclonezilla展開シーケンス)
2. [PowerShell自動セットアップシーケンス](#powershell自動セットアップシーケンス)
3. [API呼び出しシーケンス詳細](#api呼び出しシーケンス詳細)
4. [ODJ適用シーケンス](#odj適用シーケンス)
5. [エラーハンドリングシーケンス](#エラーハンドリングシーケンス)
6. [Windows Update自動実行シーケンス](#windows-update自動実行シーケンス)

---

## PXEブート〜Clonezilla展開シーケンス

```mermaid
sequenceDiagram
    participant PC as 新規PC
    participant NIC as NIC(PXE対応)
    participant DHCP as DRBLサーバDHCP
    participant TFTP as DRBLサーバTFTP
    participant Clone as Clonezilla

    Note over PC: 電源ON、LANケーブル接続済み

    PC->>NIC: BIOS起動
    NIC->>NIC: PXEブート有効確認
    NIC->>DHCP: DHCP Discover (ブロードキャスト)
    Note over DHCP: PXE用DHCP Option 66, 67設定

    DHCP->>NIC: DHCP Offer (IP: 192.168.2.100)
    NIC->>DHCP: DHCP Request
    DHCP->>NIC: DHCP Ack + Next Server: 192.168.2.1 + Boot File: pxelinux.0

    NIC->>TFTP: TFTP Read Request: pxelinux.0
    TFTP->>NIC: pxelinux.0 転送
    NIC->>PC: pxelinux.0 ロード・実行

    PC->>TFTP: TFTP Read Request: pxelinux.cfg/default
    TFTP->>PC: メニュー設定ファイル

    Note over PC: PXEメニュー表示<br/>(自動選択: Clonezilla SE)

    PC->>TFTP: TFTP Read Request: vmlinuz, initrd.img
    TFTP->>PC: カーネル・initrd転送
    PC->>PC: Clonezilla起動

    PC->>Clone: Clonezilla Live起動
    Clone->>Clone: 展開モード設定読込<br/>(ocs-sr --batch)

    Note over Clone: 自動展開開始

    Clone->>DHCP: マスターイメージパス取得<br/>/home/partimag/MASTER_2025_v1
    Clone->>Clone: ディスク展開処理<br/>(partclone.ntfs 使用)

    Note over Clone: 展開中... (20〜40分)

    Clone->>Clone: 展開完了確認
    Clone->>PC: 展開完了通知
    PC->>PC: 再起動 (自動)

    Note over PC: Windows初回起動へ
```

**所要時間**: 約20〜40分（ネットワーク速度、ディスク容量依存）

---

## PowerShell自動セットアップシーケンス

```mermaid
sequenceDiagram
    participant Win as Windows OS
    participant Script as setup.ps1
    participant BIOS as BIOS/UEFI
    participant API as Flask API
    participant DB as Database
    participant ODJ as ODJファイルストレージ
    participant WU as Windows Update

    Note over Win: 初回起動完了<br/>自動ログオン(unattend.xml)

    Win->>Script: スクリプト自動起動<br/>(スタートアップ登録)
    Script->>Script: ログ初期化

    Script->>BIOS: Get-CimInstance Win32_BIOS
    BIOS->>Script: SerialNumber = "ABC123456"

    Script->>Script: Serial検証(空白チェック)

    alt Serial取得成功
        Script->>API: GET /api/pcinfo?serial=ABC123456
        API->>DB: SELECT pcname, odj_path WHERE serial='ABC123456'
        DB->>API: 結果返却
        API->>Script: {"pcname":"20251116M","odj_path":"/srv/odj/20251116M.txt"}

        Script->>Script: PC名検証

        Script->>Win: Rename-Computer -NewName "20251116M" -Force
        Win->>Script: PC名変更完了

        Script->>ODJ: HTTP GET /srv/odj/20251116M.txt
        ODJ->>Script: ODJファイル内容
        Script->>Script: C:\temp\odj.txt に保存

        Script->>Win: djoin /requestODJ /loadfile C:\temp\odj.txt /localos
        Win->>Script: ODJ適用完了

        Script->>API: POST /api/log<br/>{"serial":"ABC123456","status":"odj_applied"}
        API->>DB: INSERT INTO setup_logs

        Script->>Win: Restart-Computer -Force

        Note over Win: 再起動後、ドメイン参加完了状態

        Script->>WU: Install-Module PSWindowsUpdate
        WU->>Script: モジュールインストール完了

        Script->>WU: Get-WindowsUpdate -AcceptAll -Install -AutoReboot
        Note over WU: Windows Update実行<br/>(複数回ループ可能性)

        WU->>Script: Update完了通知

        Script->>Script: Install-Apps関数呼出
        Script->>Win: 会社標準アプリ導入<br/>(サイレントインストール)

        Script->>API: POST /api/log<br/>{"serial":"ABC123456","status":"completed"}
        API->>DB: UPDATE setup_logs

        Script->>Script: セットアップ完了<br/>スタートアップ登録削除

    else Serial取得失敗
        Script->>API: POST /api/log<br/>{"serial":"UNKNOWN","status":"error_no_serial"}
        Script->>Script: エラーログ記録
        Note over Script: 管理者介入待ち
    end
```

**所要時間**: 約40〜60分（Windows Update内容依存）

---

## API呼び出しシーケンス詳細

### GET /api/pcinfo

```mermaid
sequenceDiagram
    participant Client as PowerShellクライアント
    participant Flask as Flask WebアプリAPI
    participant Valid as バリデーション層
    participant DB as SQLite Database
    participant Log as アプリケーションログ

    Client->>Flask: GET /api/pcinfo?serial=ABC123456
    Flask->>Flask: リクエスト受信

    Flask->>Valid: Serial形式検証
    Valid->>Valid: 英数字チェック、長さチェック

    alt バリデーション成功
        Valid->>Flask: OK

        Flask->>DB: SELECT pcname, odj_path FROM pc_master<br/>WHERE serial = 'ABC123456' LIMIT 1

        alt レコード存在
            DB->>Flask: {"pcname":"20251116M","odj_path":"/srv/odj/20251116M.txt"}
            Flask->>Log: アクセスログ記録(INFO)
            Flask->>Client: HTTP 200 OK<br/>{"pcname":"20251116M","odj_path":"/srv/odj/20251116M.txt"}
        else レコード不存在
            DB->>Flask: NULL
            Flask->>Log: 警告ログ記録(WARN)
            Flask->>Client: HTTP 404 Not Found<br/>{"error":"Serial not found"}
        end

    else バリデーション失敗
        Valid->>Flask: NG (不正形式)
        Flask->>Log: エラーログ記録(ERROR)
        Flask->>Client: HTTP 400 Bad Request<br/>{"error":"Invalid serial format"}
    end
```

### POST /api/log

```mermaid
sequenceDiagram
    participant Client as PowerShellクライアント
    participant Flask as Flask WebアプリAPI
    participant Valid as バリデーション層
    participant DB as SQLite Database
    participant Log as アプリケーションログ

    Client->>Flask: POST /api/log<br/>Body: {"serial":"ABC123456","pcname":"20251116M",<br/>"status":"completed","logs":"Setup finished"}

    Flask->>Flask: Content-Type確認(application/json)

    Flask->>Valid: リクエストボディ検証
    Valid->>Valid: 必須項目チェック(serial, status)
    Valid->>Valid: status値チェック(pending/in_progress/completed/error)

    alt バリデーション成功
        Valid->>Flask: OK

        Flask->>DB: INSERT INTO setup_logs<br/>(serial, pcname, status, timestamp, logs)<br/>VALUES ('ABC123456', '20251116M', 'completed', NOW(), 'Setup finished')

        alt INSERT成功
            DB->>Flask: SUCCESS
            Flask->>Log: ログ記録成功(INFO)
            Flask->>Client: HTTP 200 OK<br/>{"result":"ok"}
        else INSERT失敗
            DB->>Flask: ERROR (DB制約違反等)
            Flask->>Log: エラーログ記録(ERROR)
            Flask->>Client: HTTP 500 Internal Server Error<br/>{"error":"Database error"}
        end

    else バリデーション失敗
        Valid->>Flask: NG
        Flask->>Log: エラーログ記録(ERROR)
        Flask->>Client: HTTP 400 Bad Request<br/>{"error":"Invalid request body"}
    end
```

---

## ODJ適用シーケンス

```mermaid
sequenceDiagram
    participant PS as PowerShellスクリプト
    participant API as Flask API
    participant FS as ファイルシステム/srv/odj/
    participant Temp as C:\temp\
    participant Djoin as djoinコマンド
    participant Reg as Windowsレジストリ
    participant AD as Active Directory

    Note over PS: PC名設定完了後

    PS->>API: GET /api/pcinfo?serial=ABC123456
    API->>PS: {"odj_path":"/srv/odj/20251116M.txt"}

    PS->>PS: odj_path検証(空白チェック)

    PS->>FS: HTTP GET http://192.168.2.1/odj/20251116M.txt
    FS->>PS: ODJファイル内容(Base64エンコードされたバイナリ)

    PS->>Temp: ODJファイル保存<br/>C:\temp\odj.txt

    PS->>PS: ファイル存在確認<br/>Test-Path C:\temp\odj.txt

    alt ファイル存在
        PS->>Djoin: djoin.exe /requestODJ /loadfile C:\temp\odj.txt /localos
        Djoin->>Djoin: ODJデータ解析・検証

        alt ODJ適用成功
            Djoin->>Reg: ドメイン参加情報書込<br/>HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon
            Reg->>Djoin: 書込完了
            Djoin->>PS: 終了コード 0 (成功)

            PS->>API: POST /api/log<br/>{"status":"odj_applied","logs":"djoin success"}
            API->>PS: {"result":"ok"}

            PS->>Temp: Remove-Item C:\temp\odj.txt (クリーンアップ)

            PS->>PS: Restart-Computer -Force
            Note over PS: 再起動後、ADドメイン参加完了

        else ODJ適用失敗
            Djoin->>PS: 終了コード 非0 (失敗)
            PS->>PS: エラーログ取得<br/>$LASTEXITCODE, $Error[0]

            PS->>API: POST /api/log<br/>{"status":"error_odj_failed","logs":"djoin error: code 5"}
            API->>PS: {"result":"ok"}

            Note over PS: 管理者介入待ち<br/>スクリプト停止
        end

    else ファイル不存在
        PS->>API: POST /api/log<br/>{"status":"error_odj_file_not_found"}
        Note over PS: 管理者介入待ち
    end
```

**djoinコマンド詳細**:
```powershell
djoin.exe /requestODJ /loadfile <ODJファイルパス> /localos
```

**主要終了コード**:
- `0`: 成功
- `5`: アクセス拒否（要管理者権限）
- `87`: パラメータ不正
- その他: システムエラー

---

## エラーハンドリングシーケンス

### API不応答時のリトライ処理

```mermaid
sequenceDiagram
    participant PS as PowerShellスクリプト
    participant API as Flask API
    participant Retry as リトライロジック
    participant Log as ローカルログ

    PS->>API: GET /api/pcinfo?serial=ABC123456 (試行1)

    alt API応答あり
        API->>PS: HTTP 200 OK
        PS->>PS: 正常処理続行
    else API無応答/タイムアウト
        Note over API: タイムアウト (30秒)
        PS->>Retry: エラー検知
        Retry->>Log: エラーログ記録(試行1失敗)
        Retry->>Retry: 10秒待機

        Retry->>API: GET /api/pcinfo?serial=ABC123456 (試行2)

        alt API応答あり
            API->>Retry: HTTP 200 OK
            Retry->>PS: 正常処理続行
        else API無応答/タイムアウト
            Retry->>Log: エラーログ記録(試行2失敗)
            Retry->>Retry: 20秒待機

            Retry->>API: GET /api/pcinfo?serial=ABC123456 (試行3)

            alt API応答あり
                API->>Retry: HTTP 200 OK
                Retry->>PS: 正常処理続行
            else API無応答/タイムアウト (3回失敗)
                Retry->>Log: 致命的エラーログ記録
                Retry->>Log: C:\setup_error.log に詳細記録
                Retry->>PS: スクリプト停止
                Note over PS: デスクトップにエラー通知表示<br/>管理者介入待ち
            end
        end
    end
```

**リトライ設定**:
- 最大リトライ回数: 3回
- 待機時間: 1回目10秒、2回目20秒
- タイムアウト: 30秒/回

---

## Windows Update自動実行シーケンス

```mermaid
sequenceDiagram
    participant PS as PowerShellスクリプト
    participant PSGallery as PowerShell Gallery
    participant WU as PSWindowsUpdateモジュール
    participant WSUS as Windows Updateサービス
    participant Reboot as 再起動制御

    Note over PS: ODJ適用・再起動完了後

    PS->>PSGallery: Install-Module PSWindowsUpdate -Force
    PSGallery->>PS: モジュールインストール完了

    PS->>WU: Import-Module PSWindowsUpdate
    WU->>PS: モジュールロード完了

    loop 更新が存在する限りループ
        PS->>WU: Get-WindowsUpdate -AcceptAll -Install -AutoReboot
        WU->>WSUS: 更新プログラム検索
        WSUS->>WU: 更新リスト返却

        alt 更新あり
            WU->>WU: ダウンロード開始
            Note over WU: ダウンロード中...

            WU->>WU: インストール開始
            Note over WU: インストール中...

            WU->>PS: インストール完了結果

            alt 再起動必要
                PS->>Reboot: Restart-Computer -Force
                Note over PS: 再起動...
                Note over PS: 再起動後、スクリプト再開
            else 再起動不要
                PS->>PS: 次の更新チェックへ
            end

        else 更新なし
            WU->>PS: "No updates available"
            PS->>PS: Windows Update完了
            Note over PS: アプリ導入フェーズへ
        end
    end

    PS->>PS: Windows Updateログ記録
    PS->>PS: Install-Apps関数呼出
```

**注意事項**:
- 複数回の再起動が発生する可能性
- スクリプトはスタートアップ登録により再起動後も継続実行
- タイムアウト: 1回のUpdate処理は最大120分

---

## 関連ドキュメント

- [システム構成図.md](./システム構成図.md) - 全体アーキテクチャ
- [業務フロー図.md](./業務フロー図.md) - 業務プロセス詳細
- [シーケンス図_PXE_ODJ.html](./シーケンス図_PXE_ODJ.html) - HTML版シーケンス図
- [コンポーネント図.md](./コンポーネント図.md) - 各レイヤーコンポーネント詳細

---

## シーケンス図凡例

| 記号 | 意味 |
|------|------|
| `→` | 同期呼び出し（応答待ち） |
| `--→` | 非同期呼び出し（応答待たない） |
| `Note` | 処理の補足説明 |
| `alt` | 条件分岐 |
| `loop` | 繰り返し処理 |

---

**作成日**: 2025-11-17
**バージョン**: 1.0
**作成者**: System Architecture Designer
