# 業務フロー図

## 概要

会社キッティング自動化フレームワークにおける業務プロセスフローを示します。導入準備からPC展開完了まで、および運用保守フローを網羅します。

## 目次

1. [箱OCR〜CSV登録フロー](#箱ocrcsv登録フロー)
2. [PC展開業務フロー](#pc展開業務フロー)
3. [マスターイメージ更新フロー](#マスターイメージ更新フロー)
4. [エラー発生時の対応フロー](#エラー発生時の対応フロー)
5. [ODJファイル生成・登録フロー](#odjファイル生成登録フロー)
6. [月次・年次運用フロー](#月次年次運用フロー)

---

## 箱OCR〜CSV登録フロー

```mermaid
flowchart TD
    Start([100台分のPC納品]) --> A1[PC箱側面確認]
    A1 --> A2{Serial番号<br/>印字確認}

    A2 -->|印字あり| A3[スマホカメラで撮影]
    A2 -->|印字なし| Error1[手動でSerial確認<br/>PC本体から取得]

    A3 --> A4[ChatGPT OCR起動]
    A4 --> A5[画像アップロード]
    A5 --> A6[プロンプト実行<br/>Serial抽出依頼]
    A6 --> A7[ChatGPT応答確認]

    A7 --> A8{OCR精度<br/>確認}
    A8 -->|正確| A9[Serial番号コピー]
    A8 -->|不正確| A10[手動修正]
    A10 --> A9

    Error1 --> A9

    A9 --> B1[Excel/スプレッドシート<br/>に入力]
    B1 --> B2[PC名自動生成<br/>YYYYMMDDM]

    B2 --> B3{導入日<br/>確認}
    B3 -->|同一日| B4[同じYYYYMMDDM]
    B3 -->|異なる日| B5[日付別YYYYMMDDM]

    B4 --> C1[CSV形式で保存<br/>serial,pcname]
    B5 --> C1

    C1 --> C2[管理GUI Web画面アクセス]
    C2 --> C3[CSVインポート機能選択]
    C3 --> C4[CSVファイルアップロード]

    C4 --> C5{CSVフォーマット<br/>検証}
    C5 -->|OK| C6[プレビュー表示]
    C5 -->|NG| C7[エラーメッセージ表示<br/>フォーマット修正]

    C7 --> C4

    C6 --> C8[インポート実行]
    C8 --> C9[pc_masterテーブル<br/>一括INSERT]

    C9 --> C10{DB登録<br/>成功}
    C10 -->|成功| End1([登録完了<br/>100台分])
    C10 -->|失敗| C11[エラーログ確認<br/>重複Serial等]

    C11 --> C12[データ修正]
    C12 --> C4

    style Start fill:#e3f2fd
    style End1 fill:#c8e6c9
    style Error1 fill:#ffccbc
    style C7 fill:#ffccbc
    style C11 fill:#ffccbc
```

**想定所要時間**: 100台分で約2〜3時間（OCR + 手動確認含む）

**CSVフォーマット例**:
```csv
serial,pcname
ABC123456,20251116M
DEF789012,20251116M
GHI345678,20251117M
```

---

## PC展開業務フロー

```mermaid
flowchart TD
    Start([PC展開開始]) --> A1[新規PCをキッティング<br/>ネットワークに接続]
    A1 --> A2[LANケーブル接続]
    A2 --> A3[電源投入]

    A3 --> B1[BIOS/UEFI起動]
    B1 --> B2{Boot順序<br/>確認}

    B2 -->|PXE最優先| B3[PXEブート開始]
    B2 -->|PXE無効| B4[BIOS設定変更<br/>PXE有効化]
    B4 --> B3

    B3 --> C1[DHCPサーバから<br/>IPアドレス取得]
    C1 --> C2[TFTPサーバから<br/>pxelinux.0取得]
    C2 --> C3[Clonezillaメニュー表示]

    C3 --> C4{自動展開<br/>設定確認}
    C4 -->|自動| C5[自動展開開始<br/>ユーザー操作不要]
    C4 -->|手動| C6[メニューから<br/>マスターイメージ選択]

    C5 --> D1[マスターイメージ<br/>ダウンロード開始]
    C6 --> D1

    D1 --> D2[ディスク展開処理<br/>20〜40分]
    D2 --> D3{展開成功<br/>確認}

    D3 -->|成功| D4[自動再起動]
    D3 -->|失敗| Error1[エラーログ確認<br/>ディスク不良等]

    D4 --> E1[Windows初回起動]
    E1 --> E2[unattend.xml適用<br/>自動ログオン]
    E2 --> E3[PowerShellスクリプト<br/>自動起動]

    E3 --> F1[Serial番号取得]
    F1 --> F2[API /pcinfo 呼出]
    F2 --> F3{PC名・ODJパス<br/>取得成功}

    F3 -->|成功| F4[PC名設定]
    F3 -->|失敗| Error2[API不応答<br/>リトライ3回]

    F4 --> F5[ODJファイル取得]
    F5 --> F6[djoin適用]
    F6 --> F7{ODJ適用<br/>成功}

    F7 -->|成功| F8[再起動]
    F7 -->|失敗| Error3[ODJ適用失敗<br/>ログ送信]

    F8 --> G1[ドメイン参加完了]
    G1 --> G2[Windows Update実行]
    G2 --> G3{更新あり}

    G3 -->|あり| G4[ダウンロード・インストール]
    G3 -->|なし| H1[アプリ導入開始]

    G4 --> G5{再起動必要}
    G5 -->|必要| G6[再起動]
    G5 -->|不要| G2

    G6 --> G2

    H1 --> H2[Microsoft 365 Apps<br/>サイレントインストール]
    H2 --> H3[セキュリティソフト<br/>インストール]
    H3 --> H4[その他会社標準アプリ<br/>インストール]

    H4 --> I1[完了ログAPI送信<br/>POST /api/log]
    I1 --> I2[スタートアップ登録削除]
    I2 --> End1([セットアップ完了<br/>ユーザー引渡可能])

    Error1 --> ErrorHandle1[エラー対応フロー]
    Error2 --> ErrorHandle1
    Error3 --> ErrorHandle1

    style Start fill:#e3f2fd
    style End1 fill:#c8e6c9
    style Error1 fill:#ffccbc
    style Error2 fill:#ffccbc
    style Error3 fill:#ffccbc
    style ErrorHandle1 fill:#fff9c4
```

**所要時間**: 1台あたり60〜90分（ネットワーク環境、Windows Update内容に依存）

**同時展開**: 10〜20台並行可能（DRBL性能による）

---

## マスターイメージ更新フロー

```mermaid
flowchart TD
    Start([マスターイメージ更新<br/>年2回想定]) --> A1[マスターPC準備]
    A1 --> A2[Windows 11<br/>クリーンインストール]

    A2 --> B1[会社標準構成適用]
    B1 --> B2[Microsoft 365 Apps導入]
    B2 --> B3[セキュリティソフト導入]
    B3 --> B4[その他標準アプリ導入]
    B4 --> B5[Windows Update<br/>最新化]

    B5 --> C1[動作確認テスト]
    C1 --> C2{正常動作<br/>確認}

    C2 -->|OK| D1[Sysprep前処理]
    C2 -->|NG| C3[問題修正]
    C3 --> C1

    D1 --> D2[AppX除外処理実行]
    D2 --> D3[不要ファイル削除]
    D3 --> D4[unattend.xml配置<br/>C:\Windows\System32\Sysprep\]

    D4 --> E1[Sysprep実行<br/>/generalize /oobe /shutdown]
    E1 --> E2{Sysprep成功<br/>確認}

    E2 -->|成功| E3[マスターPCシャットダウン]
    E2 -->|失敗| Error1[ログ確認<br/>AppX除外漏れ等]

    Error1 --> D2

    E3 --> F1[PXEブートでClonezilla起動]
    F1 --> F2[Clonezillaメニュー<br/>「saveparts」選択]
    F2 --> F3[保存先ディレクトリ指定<br/>/home/partimag/MASTER_YYYY_vX]

    F3 --> F4[イメージ化実行<br/>30〜60分]
    F4 --> F5{イメージ作成<br/>成功}

    F5 -->|成功| G1[イメージファイル確認]
    F5 -->|失敗| Error2[ディスク容量確認<br/>権限確認]

    G1 --> G2[DRBLサーバで<br/>イメージ切替設定]
    G2 --> G3[テスト展開実施<br/>1台で検証]

    G3 --> G4{テスト展開<br/>成功}
    G4 -->|成功| H1[本番環境へ適用]
    G4 -->|失敗| Error3[イメージ再作成]

    Error3 --> D1

    H1 --> H2[旧マスターイメージ<br/>バックアップ保存]
    H2 --> H3[新マスターイメージ<br/>デフォルト設定]

    H3 --> End1([マスターイメージ更新完了])

    style Start fill:#e3f2fd
    style End1 fill:#c8e6c9
    style Error1 fill:#ffccbc
    style Error2 fill:#ffccbc
    style Error3 fill:#ffccbc
```

**更新頻度**: 年2回（4月、10月推奨）

**所要時間**: 1回あたり4〜6時間（テスト含む）

---

## エラー発生時の対応フロー

```mermaid
flowchart TD
    Start([エラー検知]) --> A1{エラー種別<br/>判定}

    A1 -->|Serial取得失敗| B1[Serial取得失敗対応]
    A1 -->|API不応答| C1[API不応答対応]
    A1 -->|ODJ適用失敗| D1[ODJ適用失敗対応]
    A1 -->|Windows Update失敗| E1[Windows Update失敗対応]
    A1 -->|アプリ導入失敗| F1[アプリ導入失敗対応]

    B1 --> B2[PC本体からSerial確認]
    B2 --> B3[BIOS画面で確認]
    B3 --> B4{Serial取得}
    B4 -->|成功| B5[手動でDBに登録]
    B4 -->|失敗| B6[ハードウェア不良<br/>交換・返品]

    B5 --> Recovery[リカバリー処理]

    C1 --> C2[DRBLサーバ稼働確認]
    C2 --> C3{サーバ稼働}
    C3 -->|稼働中| C4[ネットワーク疎通確認<br/>ping, traceroute]
    C3 -->|停止| C5[サーバ再起動<br/>Flask/Nginx確認]

    C4 --> C6{疎通OK}
    C6 -->|OK| C7[APIログ確認<br/>/var/log/flask.log]
    C6 -->|NG| C8[ネットワーク設定確認<br/>スイッチ、ケーブル]

    C5 --> Recovery
    C7 --> Recovery
    C8 --> Recovery

    D1 --> D2[djoin終了コード確認]
    D2 --> D3{終了コード}
    D3 -->|5アクセス拒否| D4[管理者権限確認<br/>スクリプト実行権限]
    D3 -->|87パラメータ不正| D5[ODJファイル破損確認<br/>再生成]
    D3 -->|その他| D6[イベントログ確認<br/>詳細エラー]

    D4 --> D7[権限付与・再実行]
    D5 --> D8[AD側でODJ再生成]
    D6 --> D9[マニュアル対応]

    D7 --> Recovery
    D8 --> Recovery

    E1 --> E2[PSWindowsUpdateログ確認]
    E2 --> E3{エラー原因}
    E3 -->|ディスク容量不足| E4[不要ファイル削除<br/>ディスク拡張]
    E3 -->|更新サーバ不通| E5[WSUS/インターネット確認]
    E3 -->|更新プログラム競合| E6[手動で更新適用]

    E4 --> Recovery
    E5 --> Recovery
    E6 --> Recovery

    F1 --> F2[アプリログ確認]
    F2 --> F3{原因特定}
    F3 -->|インストーラ不正| F4[インストーラ再ダウンロード]
    F3 -->|依存関係不足| F5[前提アプリ導入]
    F3 -->|ライセンス不正| F6[ライセンス確認]

    F4 --> Recovery
    F5 --> Recovery
    F6 --> Recovery

    Recovery --> R1[エラー解消後<br/>スクリプト再実行]
    R1 --> R2{セットアップ<br/>完了}

    R2 -->|成功| End1([正常完了])
    R2 -->|失敗| R3[エスカレーション<br/>上位管理者]

    R3 --> ManualFix[手動セットアップ]

    style Start fill:#ffccbc
    style End1 fill:#c8e6c9
    style Recovery fill:#fff9c4
    style ManualFix fill:#ffe0b2
```

**エスカレーション基準**:
- 自動リトライ3回失敗
- ハードウェア不良の疑い
- システムエラー（原因不明）

---

## ODJファイル生成・登録フロー

```mermaid
flowchart TD
    Start([ODJファイル生成開始]) --> A1[Active Directoryサーバ<br/>管理者権限で接続]

    A1 --> A2[CSVから対象PC一覧取得]
    A2 --> A3[PowerShellスクリプト起動<br/>一括ODJ生成]

    A3 --> B1[ループ: 各PC名に対して]
    B1 --> B2[djoin /provision /domain example.local<br/>/machine PC名 /savefile ODJファイルパス]

    B2 --> B3{djoin成功}
    B3 -->|成功| B4[ODJファイル生成確認]
    B3 -->|失敗| Error1[エラーログ記録<br/>PC名重複等]

    B4 --> B5[次のPC名へ]
    B5 --> B6{全PC処理完了}

    B6 -->|未完了| B1
    B6 -->|完了| C1[ODJファイル一覧取得]

    C1 --> C2[DRBLサーバへ転送<br/>scp /srv/odj/]
    C2 --> C3[ファイル権限設定<br/>chmod 644, chown www-data]

    C3 --> D1[管理GUIでパス登録]
    D1 --> D2[pc_masterテーブル<br/>UPDATE odj_path]

    D2 --> D3{全ODJパス<br/>登録完了}
    D3 -->|完了| End1([ODJ登録完了])
    D3 -->|未完了| Error2[不整合確認<br/>手動修正]

    Error1 --> ErrorHandle
    Error2 --> ErrorHandle

    ErrorHandle[エラー対応<br/>PC名修正、再実行]

    style Start fill:#e3f2fd
    style End1 fill:#c8e6c9
    style Error1 fill:#ffccbc
    style Error2 fill:#ffccbc
```

**djoinコマンド例**:
```powershell
djoin /provision `
  /domain example.local `
  /machine 20251116M `
  /savefile \\DRBL-Server\odj\20251116M.txt `
  /machineou "OU=Kitting,DC=example,DC=local"
```

---

## 月次・年次運用フロー

```mermaid
flowchart TD
    Start([定期運用タスク]) --> A1{運用タイプ}

    A1 -->|月次| M1[月次運用フロー]
    A1 -->|年次| Y1[年次運用フロー]

    M1 --> M2[セットアップログ確認<br/>setup_logs分析]
    M2 --> M3[失敗率算出]
    M3 --> M4{失敗率1%超過}

    M4 -->|超過| M5[原因分析<br/>改善策検討]
    M4 -->|未超過| M6[正常運用継続]

    M5 --> M7[マスターイメージ見直し<br/>スクリプト改善]
    M6 --> M8[月次レポート作成]
    M7 --> M8

    M8 --> M9[pc_masterテーブル<br/>古いレコード削除<br/>3ヶ月以上前]

    M9 --> M10[DRBLサーバ<br/>ディスク容量確認]
    M10 --> M11{容量不足}

    M11 -->|不足| M12[古いマスターイメージ削除<br/>ログローテーション]
    M11 -->|十分| M13[月次運用完了]

    M12 --> M13

    Y1 --> Y2[マスターイメージ更新<br/>4月、10月]
    Y2 --> Y3[Windows 11最新ビルド確認]
    Y3 --> Y4[会社標準アプリ更新確認]

    Y4 --> Y5[マスターイメージ更新フロー実行]
    Y5 --> Y6[年次テスト展開<br/>10台で検証]

    Y6 --> Y7{テスト合格}
    Y7 -->|合格| Y8[本番環境適用]
    Y7 -->|不合格| Y9[問題修正<br/>再テスト]

    Y8 --> Y10[システム全体バックアップ<br/>DRBL, DB, ODJ]
    Y10 --> Y11[障害復旧手順確認<br/>DRドリル]

    Y11 --> Y12[運用ドキュメント更新]
    Y12 --> Y13[年次運用完了]

    style Start fill:#e3f2fd
    style M13 fill:#c8e6c9
    style Y13 fill:#c8e6c9
    style M5 fill:#fff9c4
    style Y9 fill:#fff9c4
```

**月次タスク所要時間**: 2〜4時間

**年次タスク所要時間**: 1〜2日（テスト期間含む）

---

## 関連ドキュメント

- [システム構成図.md](./システム構成図.md) - アーキテクチャ全体像
- [シーケンス図集.md](./シーケンス図集.md) - 詳細シーケンス図
- [BPMNフロー図.html](./BPMNフロー図.html) - HTML版BPMNフロー
- [コンポーネント図.md](./コンポーネント図.md) - レイヤー別コンポーネント

---

## 業務フロー設計原則

### 自動化優先度

| 優先度 | 業務プロセス | 自動化率 |
|-------|------------|---------|
| 高 | PXE〜Windows初回起動 | 100% |
| 高 | ODJ適用・ドメイン参加 | 100% |
| 高 | Windows Update | 100% |
| 中 | アプリ導入 | 90%（一部手動確認） |
| 低 | 箱OCR〜CSV作成 | 70%（OCR精度99%） |
| 低 | マスターイメージ更新 | 50%（手動介入必要） |

### エラー対応SLA

| エラー種別 | 対応時間 | エスカレーション条件 |
|-----------|---------|-------------------|
| API不応答 | 10分以内 | 3回リトライ失敗 |
| Serial取得失敗 | 30分以内 | ハードウェア不良疑い |
| ODJ適用失敗 | 1時間以内 | AD側エラー |
| 展開失敗 | 1時間以内 | Clonezillaエラー |

---

**作成日**: 2025-11-17
**バージョン**: 1.0
**作成者**: System Architecture Designer
