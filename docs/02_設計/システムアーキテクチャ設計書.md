# システムアーキテクチャ設計書

**文書番号**: ARCH-001
**バージョン**: 1.0
**作成日**: 2025-11-17
**最終更新日**: 2025-11-17

---

## 1. 概要

本書は、会社キッティング自動化フレームワークのシステムアーキテクチャを定義します。年間100台規模のWindows PCを完全自動でキッティングするシステムで、4レイヤー構造によりマスターイメージ作成から完全自動展開までを実現します。

### 1.1 設計原則

- **完全自動化**: 人的介入を最小化（LANケーブル接続と電源ON操作のみ）
- **スケーラビリティ**: 10〜20台の同時展開が可能
- **信頼性**: 展開成功率99%以上を保証
- **トレーサビリティ**: すべてのセットアップログを記録
- **保守性**: 各レイヤーの疎結合により個別更新が可能

### 1.2 アーキテクチャ概要

本システムは以下の4レイヤーで構成されます：

```
┌─────────────────────────────────────────────────────────────┐
│  Layer 1: マスターPC構築レイヤー                              │
│  - Sysprep実行、Clonezillaイメージ化                          │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  Layer 2: 前処理レイヤー（箱OCR）                             │
│  - ChatGPT Vision API、CSV生成                               │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  Layer 3: インフラレイヤー                                    │
│  - DRBL/Clonezilla + Flask管理GUI + SQLite                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  Layer 4: 実行レイヤー                                        │
│  - PXEブート → Clonezilla展開 → PowerShell自動処理           │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. レイヤー1: マスターPC構築レイヤー

### 2.1 目的

会社標準構成のWindows 11マスターイメージを作成し、Clonezilla形式で保存します。

### 2.2 コンポーネント構成

```
[マスターPC（Windows 11）]
    ├── OS: Windows 11 Pro/Enterprise
    ├── 会社標準アプリケーション
    │   ├── Microsoft 365 Apps
    │   ├── セキュリティソフト
    │   ├── その他業務ソフト
    └── 構築スクリプト
        ├── AppX除外処理スクリプト
        ├── Sysprepスクリプト
        └── unattend.xml（自動ログオン設定）

[Clonezilla Live（USB/DVD）]
    └── マスターイメージ保存先: DRBLサーバ /home/partimag/
```

### 2.3 処理フロー

1. Windows 11インストール（OEM版推奨）
2. Windows Update適用
3. 会社標準アプリケーションインストール
4. AppX除外処理実行
   ```powershell
   Get-AppxPackage | Remove-AppxPackage -ErrorAction SilentlyContinue
   Get-AppxProvisionedPackage -Online | Remove-AppxProvisionedPackage -Online
   ```
5. Sysprep実行
   ```cmd
   C:\Windows\System32\Sysprep\sysprep.exe /generalize /oobe /shutdown /unattend:C:\unattend.xml
   ```
6. Clonezilla Liveブート
7. イメージ保存（zstd圧縮推奨）

### 2.4 技術スタック

| 項目 | 技術 |
|------|------|
| OS | Windows 11 Pro/Enterprise |
| 圧縮形式 | zstd（高速）or gzip（互換性） |
| イメージ保存先 | DRBLサーバ /home/partimag/ |
| unattend.xml | 自動ログオン、OOBE自動化 |

### 2.5 注意事項

- Sysprep実行前にAppX完全除外を実施（失敗原因の99%）
- unattend.xmlは自動ログオン設定必須（PowerShell自動実行のため）
- マスターイメージ更新は年数回を想定（Windows大型アップデート時）

---

## 3. レイヤー2: 前処理レイヤー（箱OCR）

### 3.1 目的

PC箱からSerial番号を抽出し、PC名を自動生成してCSV形式で管理GUIに登録します。

### 3.2 コンポーネント構成

```
[スマートフォン]
    └── カメラ（箱側面Serial番号撮影）

[ChatGPT Vision API]
    ├── OCR処理（Serial番号抽出）
    └── 精度: 99%以上

[PC名生成ロジック]
    ├── 導入日ベース（YYYYMMDDM）
    └── 例: 2025年11月16日 → 20251116M

[CSV生成]
    ├── フォーマット: serial,pcname
    └── 出力先: 管理GUI一括登録機能
```

### 3.3 処理フロー

1. PC箱側面をスマホで撮影
2. ChatGPT Vision APIへ画像送信
3. OCRでSerial番号抽出
   - プロンプト例: "この画像からSerial番号を抽出してください。Serial: XXXXXXXXの形式のみ返してください。"
4. 導入日を入力（または撮影日自動取得）
5. PC名生成（YYYYMMDDM形式）
6. CSV生成
   ```csv
   serial,pcname
   ABC123456,20251116M
   DEF789012,20251116M
   ```
7. 管理GUIへCSVアップロード

### 3.4 技術スタック

| 項目 | 技術 |
|------|------|
| OCR | ChatGPT Vision API (GPT-4V) |
| プログラミング言語 | Python or JavaScript |
| CSVライブラリ | pandas (Python) or csv (標準) |
| セキュリティ | Serial番号のみ送信（機微情報なし） |

### 3.5 PC命名規則

**YYYYMMDDM形式**:
- YYYY: 導入年（4桁）
- MM: 導入月（2桁）
- DD: 導入日（2桁）
- M: 固定サフィックス（Machine）

**例**:
- 2025年11月16日導入 → `20251116M`
- 2025年12月05日導入 → `20251205M`

### 3.6 エラーハンドリング

- OCR失敗時: 手動入力モード切替
- Serial番号形式不正時: 警告表示 + 再撮影
- 同一Serial重複時: エラー通知

---

## 4. レイヤー3: インフラレイヤー

### 4.1 目的

PXEブート環境、マスターイメージ保持、PC管理データベース、REST APIを提供します。

### 4.2 コンポーネント構成

```
[DRBLサーバ（Ubuntu 22.04 LTS）]
    ├── DHCP/TFTP/PXE
    ├── Clonezilla Server Edition
    ├── マスターイメージ格納: /home/partimag/
    └── 同時展開: 10〜20台（マルチキャスト）

[Flask管理Webアプリケーション]
    ├── Web UI（Bootstrap 5）
    ├── REST API
    │   ├── GET /api/pcinfo?serial=XXX
    │   └── POST /api/log
    ├── CSV一括登録機能
    └── ODJファイルアップロード機能

[SQLiteデータベース]
    ├── テーブル: pc_master
    ├── テーブル: setup_logs
    └── データベースファイル: /var/lib/pc-setup/db.sqlite3

[ODJファイル格納領域]
    ├── 保存先: /srv/odj/
    ├── ファイル名: {pcname}.txt
    └── 権限: 600（読取制限）
```

### 4.3 技術スタック

| コンポーネント | 技術 |
|----------------|------|
| OSサーバ | Ubuntu Server 22.04 LTS |
| PXEサーバ | DRBL (Diskless Remote Boot in Linux) |
| イメージ展開 | Clonezilla Server Edition |
| Webフレームワーク | Flask 3.0 |
| データベース | SQLite 3.x（小規模）or PostgreSQL（大規模） |
| WebUI | Bootstrap 5 + Jinja2 |
| API | Flask-RESTful or Flask Blueprint |
| ODJ保存先 | /srv/odj/ (Linux filesystem) |

### 4.4 DRBLサーバ構成

**ハードウェア要件**:
- CPU: 4コア以上
- メモリ: 8GB以上
- ディスク: 500GB以上（マスターイメージ保存用）
- NIC: Gigabit Ethernet 2ポート（管理用 + PXE配信用）

**ソフトウェア構成**:
```
/
├── /home/partimag/           # Clonezillaイメージ格納
│   └── win11-master-2025Q4/  # マスターイメージ
├── /srv/odj/                 # ODJファイル格納
├── /tftpboot/                # PXEブートファイル
├── /opt/flask-app/           # Flask管理アプリ
└── /var/lib/pc-setup/        # SQLiteデータベース
```

### 4.5 Flask管理Webアプリケーション

**ディレクトリ構成**:
```
/opt/flask-app/
├── app.py              # メインアプリケーション
├── models.py           # データベースモデル（SQLAlchemy）
├── api.py              # REST APIエンドポイント
├── views.py            # Web画面ビュー
├── templates/          # HTMLテンプレート
│   ├── base.html
│   ├── dashboard.html
│   ├── pc_list.html
│   ├── csv_import.html
│   └── log_view.html
├── static/             # 静的ファイル
│   ├── css/
│   ├── js/
│   └── img/
├── config.py           # 設定ファイル
└── requirements.txt    # Pythonパッケージ
```

**主要機能**:
1. ダッシュボード（展開状況可視化）
2. PC一覧・追加・編集・削除
3. CSV一括登録（100台以上対応）
4. ODJファイルアップロード・紐付け
5. セットアップログ表示
6. REST API提供

### 4.6 データフロー

```
[クライアントPC]
    ↓ ① PXEブート要求（DHCP/TFTP）
[DRBLサーバ]
    ↓ ② Clonezillaイメージ配信（マルチキャスト）
[クライアントPC]
    ↓ ③ Windows起動後、Serial番号取得
    ↓ ④ GET /api/pcinfo?serial=XXX
[Flask API]
    ↓ ⑤ SQLiteから pcname, odj_path 検索
    ↓ ⑥ JSON返却: {"pcname": "20251116M", "odj_path": "/srv/odj/20251116M.txt"}
[クライアントPC]
    ↓ ⑦ PC名設定 + ODJ適用 + Windows Update
    ↓ ⑧ POST /api/log（完了ログ送信）
[Flask API]
    ↓ ⑨ setup_logs テーブルへINSERT
```

### 4.7 セキュリティ考慮

- **API通信**: 社内LANのみ（外部公開禁止）
- **ODJファイル**: 権限600（root読取のみ）
- **データベース**: バックアップ日次実行
- **Webアプリ**: Basic認証 or LDAP認証
- **ログ保存**: 改ざん防止（追記専用）

---

## 5. レイヤー4: 実行レイヤー（PXEブート → 完全自動化）

### 5.1 目的

PXEブートからWindows初期セットアップまでを完全自動で実行します。

### 5.2 処理フロー全体

```
┌──────────────────────────────────────────────────────────┐
│ 1. PXEブート（DHCP → TFTP → Clonezillaメニュー）         │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│ 2. Clonezillaイメージ展開（マルチキャスト 10〜20台同時） │
│    - 展開時間: 20〜30分（100GB想定）                     │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│ 3. Windows初回起動（unattend.xml自動ログオン）           │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│ 4. PowerShell自動セットアップスクリプト実行              │
│    - Serial番号取得                                      │
│    - DRBL API問い合わせ（GET /api/pcinfo）               │
│    - PC名設定（Rename-Computer）                         │
│    - ODJファイル取得・適用（djoin /requestODJ）          │
│    - 再起動                                              │
└──────────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────────┐
│ 5. ドメイン参加後処理                                    │
│    - Windows Update実行（複数回ループ）                  │
│    - 会社標準アプリインストール                          │
│    - セットアップ完了ログ送信（POST /api/log）           │
└──────────────────────────────────────────────────────────┘
```

### 5.3 PowerShell自動セットアップスクリプト構成

**ファイル構成**:
```
C:\ProgramData\CompanySetup\
├── setup.ps1                   # メインスクリプト
├── modules/
│   ├── SerialModule.psm1       # Serial番号取得
│   ├── APIModule.psm1          # REST API通信
│   ├── ODJModule.psm1          # ODJ適用
│   ├── WindowsUpdateModule.psm1 # Windows Update
│   └── AppInstallModule.psm1   # アプリインストール
├── config/
│   ├── api_config.json         # DRBL APIエンドポイント
│   └── apps.json               # インストールアプリ一覧
└── logs/
    └── setup.log               # ローカルログ
```

**主要関数**:
```powershell
# Serial番号取得
function Get-SerialNumber {
    (Get-CimInstance Win32_BIOS).SerialNumber
}

# DRBL API問い合わせ
function Get-PCInfoFromAPI($serial) {
    $uri = "http://drbl-server:5000/api/pcinfo?serial=$serial"
    Invoke-RestMethod -Uri $uri -Method Get
}

# PC名設定
function Set-PCName($pcname) {
    Rename-Computer -NewName $pcname -Force
}

# ODJ適用
function Apply-ODJ($odjPath) {
    djoin.exe /requestODJ /loadfile $odjPath /windowspath %SystemRoot% /localos
}

# Windows Update
function Run-WindowsUpdate {
    Install-Module PSWindowsUpdate -Force
    Get-WindowsUpdate -Install -AcceptAll -AutoReboot
}

# アプリインストール
function Install-Apps {
    # apps.jsonからインストール対象取得
    # サイレントインストール実行
}

# セットアップログ送信
function Send-SetupLog($serial, $pcname, $status) {
    $uri = "http://drbl-server:5000/api/log"
    $body = @{
        serial = $serial
        pcname = $pcname
        status = $status
        timestamp = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
    } | ConvertTo-Json
    Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json"
}
```

### 5.4 自動実行設定

**unattend.xml（自動ログオン）**:
```xml
<AutoLogon>
    <Username>Administrator</Username>
    <Password>
        <Value>TempPassword123</Value>
        <PlainText>true</PlainText>
    </Password>
    <Enabled>true</Enabled>
    <LogonCount>3</LogonCount>
</AutoLogon>
<FirstLogonCommands>
    <SynchronousCommand>
        <CommandLine>powershell.exe -ExecutionPolicy Bypass -File C:\ProgramData\CompanySetup\setup.ps1</CommandLine>
        <Order>1</Order>
    </SynchronousCommand>
</FirstLogonCommands>
```

### 5.5 エラーハンドリング

| エラー種別 | 対処 |
|------------|------|
| API不応答 | 3回リトライ → エラーログ送信 → 管理者通知 |
| Serial番号取得失敗 | イベントログ記録 → 手動介入通知 |
| ODJ適用失敗 | Windowsイベントログ送信 → ロールバック |
| Windows Update失敗 | 最大3回リトライ → 部分完了として記録 |

---

## 6. コンポーネント間連携

### 6.1 連携マトリクス

| From | To | Protocol | Data |
|------|-----|----------|------|
| クライアントPC | DRBLサーバ | PXE/TFTP | ブートイメージ要求 |
| DRBLサーバ | クライアントPC | マルチキャスト | Clonezillaイメージ |
| クライアントPC | Flask API | HTTP/JSON | GET /api/pcinfo |
| Flask API | SQLite | SQL | SELECT pc_master |
| クライアントPC | Flask API | HTTP/JSON | POST /api/log |
| 管理者 | Flask Web | HTTP/HTML | PC管理・CSV登録 |

### 6.2 シーケンス図（PXEブート〜セットアップ完了）

```
クライアントPC  DRBLサーバ  Flask API  SQLite
    |              |           |         |
    |--DHCP Req--->|           |         |
    |<--DHCP Res---|           |         |
    |--TFTP Req--->|           |         |
    |<--Boot Img---|           |         |
    |              |           |         |
    |--Multicast-->|           |         |
    |<--Image------|           |         |
    |              |           |         |
    |==Windows Boot==          |         |
    |              |           |         |
    |--GET /api/pcinfo?serial=XXX------->|
    |              |           |--SELECT->|
    |              |           |<--Data---|
    |<----------JSON(pcname,odj)---------|
    |              |           |         |
    |==PC名設定・ODJ適用・再起動==        |
    |              |           |         |
    |--POST /api/log---------------------->|
    |              |           |--INSERT->|
    |<----------{"result":"ok"}------------|
```

---

## 7. 技術スタック一覧

### 7.1 サーバサイド

| 項目 | 技術 | バージョン |
|------|------|------------|
| OS | Ubuntu Server | 22.04 LTS |
| PXEサーバ | DRBL | 最新安定版 |
| イメージ展開 | Clonezilla SE | 最新安定版 |
| Webフレームワーク | Flask | 3.0以上 |
| データベース | SQLite | 3.x |
| Python | Python | 3.10以上 |
| Webサーバ | Gunicorn + Nginx | 最新安定版 |

### 7.2 クライアントサイド

| 項目 | 技術 | バージョン |
|------|------|------------|
| OS | Windows 11 | Pro/Enterprise |
| 自動化言語 | PowerShell | 5.1以上 |
| ODJ | djoin.exe | Windows標準 |
| Windows Update | PSWindowsUpdate | 最新版 |

### 7.3 開発ツール

| 項目 | 技術 |
|------|------|
| OCR | ChatGPT Vision API (GPT-4V) |
| バージョン管理 | Git |
| ドキュメント | Markdown |
| テスト | pytest（Python）、Pester（PowerShell） |

---

## 8. 非機能要件

### 8.1 性能要件

| 項目 | 目標値 |
|------|--------|
| Sysprep成功率 | 100% |
| API応答時間 | 200ms以下（LAN環境） |
| 同時展開台数 | 10〜20台 |
| 展開時間 | 60〜90分/台 |
| 展開失敗率 | 1%未満 |
| OCR精度 | 99%以上 |

### 8.2 可用性

- DRBLサーバ稼働率: 99%以上（営業時間内）
- データベースバックアップ: 日次実行
- ログ保存期間: 1年以上

### 8.3 拡張性

- マスターイメージ追加: 複数OS/構成対応可能
- 同時展開スケール: 20台→50台（サーバ増強で対応）
- API拡張: RESTful設計により機能追加容易

---

## 9. 関連ドキュメント

| ドキュメント名 | パス | 説明 |
|----------------|------|------|
| データベース設計書 | `/docs/02_設計/データベース設計書.md` | テーブル定義、スキーマ |
| ネットワーク設計書 | `/docs/02_設計/ネットワーク設計書.md` | PXE、マルチキャスト、VLAN |
| インターフェース設計書 | `/docs/02_設計/インターフェース設計書.md` | REST API、画面仕様 |
| 要件定義書 | `/docs/01_要件定義/` | 機能要件、非機能要件 |
| 実装ガイド | `/docs/03_実装/` | コーディング規約、テスト |

---

## 10. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|------------|------|----------|--------|
| 1.0 | 2025-11-17 | 初版作成 | System Architect |

---

**承認欄**

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| システムアーキテクト | | | |
| プロジェクトマネージャー | | | |
| 技術責任者 | | | |
