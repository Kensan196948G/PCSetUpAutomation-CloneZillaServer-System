# コーディング規約

## 目次
1. [全般的なルール](#全般的なルール)
2. [Pythonコーディング規約](#pythonコーディング規約)
3. [PowerShellコーディング規約](#powershellコーディング規約)
4. [HTML/CSS/JavaScriptコーディング規約](#htmlcssjavascriptコーディング規約)
5. [コードレビューガイドライン](#コードレビューガイドライン)

---

## 全般的なルール

### 基本原則
- **読みやすさを最優先**: コードは書くよりも読まれる回数が多い
- **DRY原則**: Don't Repeat Yourself（同じコードを繰り返さない）
- **KISS原則**: Keep It Simple, Stupid（シンプルに保つ）
- **YAGNI原則**: You Aren't Gonna Need It（必要になるまで実装しない）

### バージョン管理
- コミットメッセージは日本語で明確に記述
- 1コミット1機能を原則とする
- コミット前に必ずlintとテストを実行

### ドキュメント
- 公開関数・クラスには必ずdocstringを記述
- 複雑なロジックにはコメントを追加
- READMEとAPIドキュメントを常に最新に保つ

---

## Pythonコーディング規約

### 基準
**PEP 8準拠**を基本とし、以下のルールを追加適用します。

### 1. 命名規則

#### モジュール名
```python
# Good
api_handlers.py
database_utils.py
pc_master_model.py

# Bad
ApiHandlers.py
database-utils.py
PCMaster.py
```

#### クラス名（PascalCase）
```python
# Good
class PCMaster:
    pass

class SetupLogService:
    pass

class DatabaseConnection:
    pass

# Bad
class pc_master:
    pass

class setupLogService:
    pass
```

#### 関数名・変数名（snake_case）
```python
# Good
def get_pc_info(serial_number):
    pc_name = "20251116M"
    odj_path = "/srv/odj/file.txt"
    return pc_name, odj_path

# Bad
def GetPCInfo(serialNumber):
    PCName = "20251116M"
    return PCName
```

#### 定数名（UPPER_SNAKE_CASE）
```python
# Good
MAX_RETRY_COUNT = 3
API_TIMEOUT_SECONDS = 30
DEFAULT_ODJ_PATH = "/srv/odj"

# Bad
maxRetryCount = 3
api_timeout = 30
```

#### プライベート変数・メソッド（先頭アンダースコア）
```python
class PCMasterService:
    def __init__(self):
        self._db_connection = None  # プライベート変数

    def _validate_serial(self, serial):  # プライベートメソッド
        return len(serial) > 0

    def get_pc_info(self, serial):  # パブリックメソッド
        if self._validate_serial(serial):
            return self._fetch_from_db(serial)
```

### 2. インデントとフォーマット

#### インデント
```python
# スペース4つを使用（タブは禁止）
def example_function():
    if condition:
        do_something()
        do_another_thing()
```

#### 行の長さ
```python
# 1行は最大88文字（Black準拠）
# 長い行は適切に改行

# Good
result = some_function(
    parameter1="value1",
    parameter2="value2",
    parameter3="value3"
)

# Bad
result = some_function(parameter1="value1", parameter2="value2", parameter3="value3", parameter4="value4")
```

#### インポート
```python
# 標準ライブラリ → サードパーティ → ローカル の順
# グループ間は空行で区切る

# 標準ライブラリ
import os
import sys
from datetime import datetime

# サードパーティライブラリ
from flask import Flask, request, jsonify
from sqlalchemy import Column, String, Integer

# ローカルモジュール
from models import PCMaster, SetupLog
from utils import validate_serial
```

### 3. 文字列

#### 文字列リテラル
```python
# ダブルクォート（"）を推奨
message = "セットアップ完了"

# シングルクォート（'）も可（一貫性を保つ）
# プロジェクト内で統一すること

# f-stringを活用
serial = "ABC123456"
pc_name = "20251116M"
log_message = f"PC {pc_name} (Serial: {serial}) のセットアップが完了しました"
```

#### 長い文字列
```python
# Good
error_message = (
    "セットアップ中にエラーが発生しました。"
    "ネットワーク接続を確認してください。"
)

# または
error_message = """
セットアップ中にエラーが発生しました。
ネットワーク接続を確認してください。
""".strip()
```

### 4. コメントとDocstring

#### Docstring（Google スタイル）
```python
def get_pc_info(serial: str) -> dict:
    """シリアル番号からPC情報を取得する.

    Args:
        serial: PCのシリアル番号

    Returns:
        PC情報を含む辞書
        {
            'pcname': 'PC名',
            'odj_path': 'ODJファイルパス'
        }

    Raises:
        ValueError: シリアル番号が不正な場合
        DatabaseError: データベース接続エラーの場合

    Examples:
        >>> get_pc_info("ABC123456")
        {'pcname': '20251116M', 'odj_path': '/srv/odj/20251116M.txt'}
    """
    if not serial:
        raise ValueError("シリアル番号が指定されていません")

    # データベースから検索
    pc = PCMaster.query.filter_by(serial=serial).first()
    if not pc:
        return {}

    return {
        'pcname': pc.pcname,
        'odj_path': pc.odj_path
    }
```

#### インラインコメント
```python
# Good - 複雑なロジックを説明
retry_count = 0
while retry_count < MAX_RETRY_COUNT:
    # APIリクエストが失敗する可能性があるため、リトライを実装
    try:
        response = call_api()
        break
    except RequestException:
        retry_count += 1
        time.sleep(2 ** retry_count)  # 指数バックオフ

# Bad - 自明なコメント
x = x + 1  # xに1を加算
```

### 5. エラーハンドリング

#### 例外処理
```python
# Good - 具体的な例外をキャッチ
try:
    pc = PCMaster.query.filter_by(serial=serial).first()
except SQLAlchemyError as e:
    logger.error(f"データベースエラー: {e}")
    raise DatabaseError("PC情報の取得に失敗しました") from e

# Bad - 広範囲の例外キャッチ
try:
    pc = PCMaster.query.filter_by(serial=serial).first()
except Exception:
    pass  # 何もしない
```

#### カスタム例外
```python
# カスタム例外クラスの定義
class PCSetupError(Exception):
    """PCセットアップに関する基底例外クラス"""
    pass

class SerialNotFoundError(PCSetupError):
    """シリアル番号が見つからない場合の例外"""
    pass

class ODJFileNotFoundError(PCSetupError):
    """ODJファイルが見つからない場合の例外"""
    pass

# 使用例
def get_pc_info(serial):
    pc = PCMaster.query.filter_by(serial=serial).first()
    if not pc:
        raise SerialNotFoundError(f"シリアル番号 {serial} は登録されていません")
    return pc
```

### 6. 関数設計

#### 関数は単一責任を持つ
```python
# Good - 単一責任
def validate_serial(serial: str) -> bool:
    """シリアル番号の妥当性を検証"""
    return len(serial) >= 8 and serial.isalnum()

def get_pc_from_db(serial: str) -> PCMaster:
    """データベースからPC情報を取得"""
    return PCMaster.query.filter_by(serial=serial).first()

def format_pc_response(pc: PCMaster) -> dict:
    """PC情報をレスポンス形式に整形"""
    return {
        'pcname': pc.pcname,
        'odj_path': pc.odj_path
    }

# Bad - 複数責任
def get_and_validate_and_format_pc_info(serial):
    """検証、取得、整形を全て行う（分割すべき）"""
    if len(serial) < 8:
        return None
    pc = PCMaster.query.filter_by(serial=serial).first()
    return {'pcname': pc.pcname, 'odj_path': pc.odj_path}
```

#### 型ヒントの使用
```python
from typing import Optional, Dict, List

def get_pc_info(serial: str) -> Optional[Dict[str, str]]:
    """型ヒントを明示"""
    pc = PCMaster.query.filter_by(serial=serial).first()
    if not pc:
        return None

    return {
        'pcname': pc.pcname,
        'odj_path': pc.odj_path
    }

def get_all_pcs() -> List[PCMaster]:
    """PCのリストを返す"""
    return PCMaster.query.all()
```

### 7. クラス設計

#### データクラスの活用
```python
from dataclasses import dataclass
from datetime import datetime

@dataclass
class PCInfo:
    """PC情報データクラス"""
    serial: str
    pcname: str
    odj_path: str
    created_at: datetime

    def is_recent(self, days: int = 7) -> bool:
        """指定日数以内に作成されたかチェック"""
        delta = datetime.now() - self.created_at
        return delta.days <= days
```

### 8. リストと辞書

#### リスト内包表記の活用
```python
# Good
pc_names = [pc.pcname for pc in pcs if pc.status == 'active']

# Bad
pc_names = []
for pc in pcs:
    if pc.status == 'active':
        pc_names.append(pc.pcname)
```

#### 辞書の操作
```python
# Good - get()メソッドを使用
odj_path = config.get('odj_path', '/srv/odj/default')

# Bad - KeyErrorのリスク
odj_path = config['odj_path']

# Good - 辞書内包表記
pc_dict = {pc.serial: pc.pcname for pc in pcs}
```

### 9. ロギング

```python
import logging

# ロガーの設定
logger = logging.getLogger(__name__)

def process_setup(serial: str):
    """セットアップ処理"""
    logger.info(f"セットアップ開始: Serial={serial}")

    try:
        pc_info = get_pc_info(serial)
        logger.debug(f"PC情報取得: {pc_info}")

        apply_odj(pc_info['odj_path'])
        logger.info(f"ODJ適用完了: {pc_info['pcname']}")

    except Exception as e:
        logger.error(f"セットアップエラー: {e}", exc_info=True)
        raise

# ログレベル
# DEBUG: 詳細な診断情報
# INFO: 一般的な情報メッセージ
# WARNING: 警告メッセージ
# ERROR: エラーメッセージ
# CRITICAL: 致命的なエラー
```

---

## PowerShellコーディング規約

### 1. 命名規則

#### 関数名（動詞-名詞形式）
```powershell
# Good - 承認された動詞を使用
function Get-SerialNumber { }
function Set-PCName { }
function Test-NetworkConnection { }
function Start-WindowsUpdate { }

# Bad
function GetSerial { }
function RenamePCName { }
function CheckNetwork { }
```

**承認された動詞一覧**:
```powershell
# 確認: Get-Verb で確認可能
Get-Verb | Select-Object Verb, Group

# よく使う動詞
# Get, Set, New, Remove, Test, Start, Stop, Invoke, Write, Read
```

#### 変数名（PascalCase）
```powershell
# Good
$SerialNumber = "ABC123456"
$PCName = "20251116M"
$ODJFilePath = "C:\ODJ\file.txt"

# Bad
$serialnumber = "ABC123456"
$pc_name = "20251116M"
$odjfilepath = "C:\ODJ\file.txt"
```

#### 定数（全て大文字）
```powershell
# Good
$MAX_RETRY_COUNT = 3
$API_BASE_URL = "http://drbl-server:5000"
$DEFAULT_TIMEOUT = 30

# スコープを明示
Set-Variable -Name MAX_RETRY_COUNT -Value 3 -Option Constant
```

### 2. コメントベースヘルプ

```powershell
function Get-PCInfoFromAPI {
    <#
    .SYNOPSIS
        DRBL APIからPC情報を取得する

    .DESCRIPTION
        シリアル番号を使用してDRBL管理APIに問い合わせ、
        PC名とODJファイルパスを取得します。

    .PARAMETER Serial
        PCのシリアル番号（必須）

    .PARAMETER APIBaseUrl
        APIのベースURL（デフォルト: http://drbl-server:5000）

    .PARAMETER Timeout
        タイムアウト秒数（デフォルト: 30秒）

    .EXAMPLE
        Get-PCInfoFromAPI -Serial "ABC123456"

        PC名とODJパスを含むハッシュテーブルを返す

    .EXAMPLE
        Get-PCInfoFromAPI -Serial "ABC123456" -APIBaseUrl "http://192.168.1.100:5000"

        カスタムAPIエンドポイントを指定

    .OUTPUTS
        System.Collections.Hashtable
        @{
            PCName = "20251116M"
            ODJPath = "/srv/odj/20251116M.txt"
        }

    .NOTES
        Author: IT部門
        Date: 2025-11-16
        Version: 1.0
    #>

    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [ValidateNotNullOrEmpty()]
        [string]$Serial,

        [Parameter(Mandatory=$false)]
        [string]$APIBaseUrl = "http://drbl-server:5000",

        [Parameter(Mandatory=$false)]
        [int]$Timeout = 30
    )

    # 実装...
}
```

### 3. パラメータバリデーション

```powershell
function Set-PCName {
    param(
        # 必須パラメータ
        [Parameter(Mandatory=$true)]
        [ValidateNotNullOrEmpty()]
        [string]$NewName,

        # パターンマッチング検証
        [Parameter(Mandatory=$true)]
        [ValidatePattern('^\d{8}M$')]  # YYYYMMDDMの形式
        [string]$PCName,

        # 範囲検証
        [Parameter(Mandatory=$false)]
        [ValidateRange(1, 10)]
        [int]$RetryCount = 3,

        # セット検証
        [Parameter(Mandatory=$false)]
        [ValidateSet('Development', 'Production')]
        [string]$Environment = 'Production',

        # スクリプトブロック検証
        [Parameter(Mandatory=$false)]
        [ValidateScript({Test-Path $_})]
        [string]$LogPath = "C:\Logs\setup.log"
    )

    # 実装...
}
```

### 4. エラーハンドリング

```powershell
function Invoke-SafeOperation {
    [CmdletBinding()]
    param(
        [string]$Operation
    )

    # ErrorActionPreferenceの設定
    $ErrorActionPreference = 'Stop'

    try {
        Write-Verbose "処理開始: $Operation"

        # 何らかの処理
        $Result = Invoke-Expression $Operation

        Write-Verbose "処理成功"
        return $Result

    } catch [System.Net.WebException] {
        # 特定の例外をキャッチ
        Write-Error "ネットワークエラー: $_"
        throw

    } catch {
        # その他の例外
        Write-Error "予期しないエラー: $_"
        Write-Error "スタックトレース: $($_.ScriptStackTrace)"
        throw

    } finally {
        # クリーンアップ処理
        Write-Verbose "クリーンアップ完了"
    }
}
```

### 5. 関数の戻り値

```powershell
# Good - 明示的にreturn
function Get-SerialNumber {
    [CmdletBinding()]
    [OutputType([string])]
    param()

    $Serial = (Get-CimInstance Win32_BIOS).SerialNumber

    if ([string]::IsNullOrEmpty($Serial)) {
        Write-Error "シリアル番号を取得できませんでした"
        return $null
    }

    return $Serial
}

# Good - パイプラインに出力
function Get-AllPCInfo {
    [CmdletBinding()]
    param()

    $PCs | ForEach-Object {
        [PSCustomObject]@{
            Serial = $_.Serial
            PCName = $_.PCName
            Status = $_.Status
        }
    }
}
```

### 6. ロギング

```powershell
function Write-SetupLog {
    param(
        [Parameter(Mandatory=$true)]
        [ValidateSet('Info', 'Warning', 'Error')]
        [string]$Level,

        [Parameter(Mandatory=$true)]
        [string]$Message,

        [Parameter(Mandatory=$false)]
        [string]$LogFile = "C:\Logs\setup.log"
    )

    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $LogEntry = "[$Timestamp] [$Level] $Message"

    # コンソール出力
    switch ($Level) {
        'Info'    { Write-Host $LogEntry -ForegroundColor Green }
        'Warning' { Write-Warning $LogEntry }
        'Error'   { Write-Error $LogEntry }
    }

    # ファイル出力
    Add-Content -Path $LogFile -Value $LogEntry -Encoding UTF8
}

# 使用例
Write-SetupLog -Level Info -Message "セットアップ開始"
Write-SetupLog -Level Error -Message "API接続失敗"
```

### 7. スクリプト構造

```powershell
#Requires -Version 5.1
#Requires -RunAsAdministrator

<#
.SYNOPSIS
    PC自動セットアップスクリプト
.DESCRIPTION
    PXEブート後のWindows初回起動時に実行され、
    PC名設定、ODJ適用、Windows Updateを自動実行します。
#>

[CmdletBinding()]
param(
    [string]$APIBaseUrl = "http://drbl-server:5000"
)

# ----- 設定 -----
$ErrorActionPreference = 'Stop'
$VerbosePreference = 'Continue'

# ----- 定数 -----
$MAX_RETRY_COUNT = 3
$RETRY_INTERVAL_SECONDS = 5
$LOG_FILE = "C:\Logs\setup.log"

# ----- 関数定義 -----
function Get-SerialNumber { ... }
function Get-PCInfoFromAPI { ... }
function Set-PCName { ... }

# ----- メイン処理 -----
try {
    Write-SetupLog -Level Info -Message "セットアップ開始"

    $Serial = Get-SerialNumber
    $PCInfo = Get-PCInfoFromAPI -Serial $Serial
    Set-PCName -NewName $PCInfo.PCName

    Write-SetupLog -Level Info -Message "セットアップ完了"

} catch {
    Write-SetupLog -Level Error -Message "セットアップ失敗: $_"
    exit 1
}
```

---

## HTML/CSS/JavaScriptコーディング規約

### 1. HTML（Jinja2テンプレート）

```html
<!-- Good - セマンティックHTML -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PC管理システム{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">PC管理</a>
        </div>
    </nav>

    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer mt-auto py-3 bg-light">
        <div class="container text-center">
            <span class="text-muted">PC Setup Automation System</span>
        </div>
    </footer>

    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>
```

### 2. CSS（Bootstrap使用）

```css
/* カスタムスタイルは最小限に */
/* Bootstrap変数をオーバーライド */

:root {
    --primary-color: #0056b3;
    --secondary-color: #6c757d;
}

/* ユーティリティクラスを優先 */
.custom-card {
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

/* レスポンシブデザイン */
@media (max-width: 768px) {
    .custom-card {
        margin-bottom: 1rem;
    }
}
```

### 3. JavaScript

```javascript
// 'use strict'を使用
'use strict';

/**
 * PC情報をAPIから取得
 * @param {string} serial - シリアル番号
 * @returns {Promise<Object>} PC情報
 */
async function fetchPCInfo(serial) {
    try {
        const response = await fetch(`/api/pcinfo?serial=${serial}`, {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + API_TOKEN,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();

    } catch (error) {
        console.error('PC情報取得エラー:', error);
        throw error;
    }
}

// イベントリスナー
document.addEventListener('DOMContentLoaded', function() {
    const searchButton = document.getElementById('search-button');

    searchButton.addEventListener('click', async function() {
        const serial = document.getElementById('serial-input').value;

        if (!serial) {
            alert('シリアル番号を入力してください');
            return;
        }

        try {
            const pcInfo = await fetchPCInfo(serial);
            displayPCInfo(pcInfo);
        } catch (error) {
            alert('エラーが発生しました: ' + error.message);
        }
    });
});
```

---

## コードレビューガイドライン

### チェックリスト

#### 機能性
- [ ] 要件を満たしているか
- [ ] エッジケースが考慮されているか
- [ ] エラーハンドリングが適切か

#### コード品質
- [ ] 命名規則に準拠しているか
- [ ] 適切にコメント・docstringが記述されているか
- [ ] DRY原則が守られているか
- [ ] 関数/メソッドが単一責任か

#### テスト
- [ ] ユニットテストが書かれているか
- [ ] テストカバレッジが十分か
- [ ] テストが通るか

#### セキュリティ
- [ ] 入力検証が行われているか
- [ ] SQLインジェクション対策があるか
- [ ] 機密情報がハードコードされていないか

#### パフォーマンス
- [ ] N+1問題がないか
- [ ] 不要なループがないか
- [ ] キャッシュが適切に使われているか

---

## ツール設定

### Black（Pythonフォーマッター）

```bash
# インストール
pip install black

# 実行
black .

# 設定ファイル: pyproject.toml
[tool.black]
line-length = 88
target-version = ['py310']
include = '\.pyi?$'
```

### Flake8（Pythonリンター）

```bash
# インストール
pip install flake8

# 実行
flake8 .

# 設定ファイル: .flake8
[flake8]
max-line-length = 88
extend-ignore = E203, W503
exclude = .git,__pycache__,venv
```

### isort（インポート整理）

```bash
# インストール
pip install isort

# 実行
isort .

# 設定ファイル: pyproject.toml
[tool.isort]
profile = "black"
line_length = 88
```

---

## 参考資料

- [PEP 8 - Style Guide for Python Code](https://peps.python.org/pep-0008/)
- [Google Python Style Guide](https://google.github.io/styleguide/pyguide.html)
- [PowerShell Best Practices](https://learn.microsoft.com/en-us/powershell/scripting/developer/cmdlet/cmdlet-development-guidelines)
- [Airbnb JavaScript Style Guide](https://github.com/airbnb/javascript)
