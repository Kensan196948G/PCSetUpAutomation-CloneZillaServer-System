# マスターイメージ作成ガイド

**バージョン**: 1.0
**最終更新**: 2025-11-17
**対象OS**: Windows 11 Pro/Enterprise

---

## 目次

1. [概要](#概要)
2. [事前準備](#事前準備)
3. [Windows 11インストール手順](#windows-11インストール手順)
4. [会社標準アプリケーション導入](#会社標準アプリケーション導入)
5. [Sysprep実行前チェックリスト](#sysprep実行前チェックリスト)
6. [Sysprep実行手順](#sysprep実行手順)
7. [Clonezillaイメージ化手順](#clonezillaイメージ化手順)
8. [マスターイメージ更新時の注意事項](#マスターイメージ更新時の注意事項)
9. [トラブルシューティング](#トラブルシューティング)

---

## 概要

本ガイドは、年間100台規模のWindows PCキッティング自動化において使用する**マスターイメージ**の作成手順を定義します。

### マスターイメージの役割

- 会社標準構成のWindows 11環境
- Clonezillaによる高速展開の元となるイメージ
- Sysprep処理済み（PC固有情報を削除）
- 初回起動後の自動セットアップスクリプト組み込み済み

### 更新頻度

- **年4回**（四半期ごと）を推奨
- Windows Updateの累積更新プログラム適用後
- 会社標準アプリケーションの大幅変更時

---

## 事前準備

### 必要なもの

| 項目 | 詳細 |
|------|------|
| Windows 11 ISO | `/media/Windows11.iso` (5.7GB) |
| マスターPC | **新品またはクリーンインストール済みPC** |
| ライセンスキー | Windows 11 Pro/Enterprise ボリュームライセンス |
| USBメモリ | 16GB以上（インストールメディア作成用） |
| ネットワーク接続 | インターネット接続（Windows Update用） |
| 外付けHDD | Clonezillaイメージ保存用（100GB以上推奨） |

### インストールメディア作成

```bash
# Linuxの場合
sudo dd if=/mnt/Linux-ExHDD/PCSetUpAutomation-CloneZillaServer-Project/media/Windows11.iso \
         of=/dev/sdX bs=4M status=progress && sync

# sdXは実際のUSBデバイス名に置き換え（例: sdb）
```

---

## Windows 11インストール手順

### 1. BIOS/UEFI設定

1. マスターPCの電源投入時に **F2** または **Del** キーでBIOS/UEFI設定画面へ
2. 以下を確認・設定：
   - **Boot Mode**: UEFI（レガシーBIOSは使用しない）
   - **Secure Boot**: 有効
   - **TPM 2.0**: 有効
   - **Boot Order**: USBメモリを最優先

### 2. Windows 11インストール

1. USBメモリから起動
2. インストール画面で以下を選択：
   - **言語**: 日本語
   - **時刻と通貨の形式**: 日本語（日本）
   - **キーボード**: Microsoft IME
3. **カスタム: Windowsのみをインストールする** を選択
4. パーティション構成：
   - **システムパーティション**: 自動作成（GPT形式）
   - **メインパーティション**: 残り全容量
5. インストール開始（約20-30分）

### 3. 初期セットアップ（OOBE）

**重要**: この段階ではドメイン参加しない（Sysprep後に自動化）

1. **地域設定**: 日本
2. **キーボードレイアウト**: Microsoft IME
3. **ネットワーク**: 接続スキップ（後で設定）
4. **アカウント作成**:
   - **ユーザー名**: `Administrator`（ローカル管理者）
   - **パスワード**: 複雑なパスワード（記録必須）
5. **プライバシー設定**: すべて無効化

### 4. Windows Update実行

```powershell
# PowerShell（管理者権限）で実行
Install-Module PSWindowsUpdate -Force
Import-Module PSWindowsUpdate
Get-WindowsUpdate -Install -AcceptAll -AutoReboot

# 再起動後、更新が完了するまで繰り返し実行
```

**目安**: 累積更新プログラム + セキュリティ更新プログラム（3-5回の再起動）

---

## 会社標準アプリケーション導入

### 導入リスト

| アプリケーション | バージョン | サイレントインストールコマンド |
|------------------|------------|-------------------------------|
| **Microsoft 365 Apps** | 最新 | `setup.exe /configure configuration.xml` |
| **Google Chrome** | 最新 | `ChromeSetup.exe /silent /install` |
| **Adobe Acrobat Reader DC** | 最新 | `AcroRdrDC.exe /sAll /rs /msi EULA_ACCEPT=YES` |
| **セキュリティソフト** | 会社指定 | ベンダー提供のサイレントインストール手順 |
| **Microsoft Teams** | 最新 | `Teams_windows_x64.exe /silent` |
| **7-Zip** | 最新 | `7z-x64.msi /quiet /norestart` |
| **社内VPNクライアント** | 会社指定 | 個別手順参照 |

### 導入スクリプト例

```powershell
# C:\Temp\InstallApps.ps1

# Microsoft 365 Apps
Start-Process -FilePath "\\fileserver\software\Office365\setup.exe" `
              -ArgumentList "/configure configuration.xml" `
              -Wait

# Google Chrome
Start-Process -FilePath "\\fileserver\software\Chrome\ChromeSetup.exe" `
              -ArgumentList "/silent /install" `
              -Wait

# Adobe Acrobat Reader DC
Start-Process -FilePath "\\fileserver\software\Adobe\AcroRdrDC.exe" `
              -ArgumentList "/sAll /rs /msi EULA_ACCEPT=YES" `
              -Wait

# セキュリティソフト
Start-Process -FilePath "\\fileserver\software\Antivirus\setup.exe" `
              -ArgumentList "/S" `
              -Wait

Write-Host "アプリケーション導入完了" -ForegroundColor Green
```

### AppX（ストアアプリ）の削除

**Sysprep成功率向上のため、不要なAppXアプリを削除**

```powershell
# C:\Temp\RemoveAppx.ps1

# 削除対象リスト（一例）
$AppxList = @(
    "Microsoft.BingNews"
    "Microsoft.BingWeather"
    "Microsoft.GetHelp"
    "Microsoft.Getstarted"
    "Microsoft.MicrosoftOfficeHub"
    "Microsoft.MicrosoftSolitaireCollection"
    "Microsoft.People"
    "Microsoft.WindowsFeedbackHub"
    "Microsoft.Xbox.TCUI"
    "Microsoft.XboxApp"
    "Microsoft.XboxGameOverlay"
    "Microsoft.XboxGamingOverlay"
    "Microsoft.XboxIdentityProvider"
    "Microsoft.XboxSpeechToTextOverlay"
    "Microsoft.ZuneMusic"
    "Microsoft.ZuneVideo"
)

foreach ($App in $AppxList) {
    Write-Host "削除中: $App" -ForegroundColor Yellow
    Get-AppxPackage -Name $App -AllUsers | Remove-AppxPackage -ErrorAction SilentlyContinue
    Get-AppxProvisionedPackage -Online | Where-Object {$_.DisplayName -eq $App} | Remove-AppxProvisionedPackage -Online -ErrorAction SilentlyContinue
}

Write-Host "AppX削除完了" -ForegroundColor Green
```

### Windows機能の有効化/無効化

```powershell
# .NET Framework 3.5を有効化（必要な場合）
Enable-WindowsOptionalFeature -Online -FeatureName NetFx3 -All

# Hyper-Vを無効化（VDI環境でない限り不要）
Disable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All
```

---

## Sysprep実行前チェックリスト

### 必須チェック項目

- [ ] **Windows Updateが完全に完了**（保留中の更新なし）
- [ ] **すべてのアプリケーションが正常動作**
- [ ] **AppXアプリの削除が完了**
- [ ] **ドメイン参加していない**（ローカルアカウントで動作）
- [ ] **C:\Temp フォルダにunattend.xmlを配置**
- [ ] **C:\Temp フォルダに自動セットアップスクリプトを配置**
- [ ] **ライセンス認証状態を確認**（`slmgr /dlv`）
- [ ] **イベントログにエラーがないか確認**
- [ ] **ディスククリーンアップ実行済み**

### ディスククリーンアップ

```powershell
# 一時ファイル削除
cleanmgr /sageset:1
cleanmgr /sagerun:1

# Windows.oldフォルダ削除（存在する場合）
Remove-Item -Path "C:\Windows.old" -Recurse -Force -ErrorAction SilentlyContinue
```

---

## Sysprep実行手順

### 1. unattend.xml配置

**配置先**: `C:\Windows\System32\Sysprep\unattend.xml`

```powershell
Copy-Item -Path "C:\Temp\unattend.xml" `
          -Destination "C:\Windows\System32\Sysprep\unattend.xml" `
          -Force
```

unattend.xmlの詳細は `configs/sysprep/unattend.xml` を参照。

### 2. 自動セットアップスクリプト配置

```powershell
# スクリプト配置先ディレクトリ作成
New-Item -Path "C:\AutoSetup" -ItemType Directory -Force

# スクリプトをコピー
Copy-Item -Path "\\fileserver\scripts\setup.ps1" `
          -Destination "C:\AutoSetup\setup.ps1" `
          -Force

# 実行ポリシー設定（unattend.xmlで自動実行）
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope LocalMachine -Force
```

### 3. Sysprep実行

```powershell
# PowerShell（管理者権限）で実行
C:\Windows\System32\Sysprep\sysprep.exe /generalize /oobe /shutdown /unattend:C:\Windows\System32\Sysprep\unattend.xml
```

**パラメータ説明**:
- `/generalize`: PC固有情報（SID、デバイスドライバ等）を削除
- `/oobe`: 次回起動時にOOBE（Out-Of-Box Experience）を実行
- `/shutdown`: Sysprep完了後シャットダウン
- `/unattend`: 応答ファイル指定

**実行時間**: 約5-10分

### 4. Sysprep成功確認

**成功条件**:
- PCが自動的にシャットダウン
- `C:\Windows\System32\Sysprep\Panther\setuperr.log` にエラーなし

**失敗時**:
```powershell
# エラーログ確認
Get-Content "C:\Windows\System32\Sysprep\Panther\setuperr.log" | Select-Object -Last 50
```

**よくあるエラー**:
- **AppXパッケージエラー**: AppX削除スクリプト再実行
- **ドライバエラー**: デバイスマネージャーで不明なデバイス削除
- **Windows Update未完了**: 保留中の更新を完了

---

## Clonezillaイメージ化手順

### 1. Clonezilla Live USB作成

```bash
# Linuxの場合
sudo dd if=clonezilla-live-*.iso of=/dev/sdX bs=4M status=progress && sync
```

### 2. Clonezilla起動

1. マスターPCにClonezilla Live USBを接続
2. USBから起動
3. 言語選択: **ja_JP.UTF-8**

### 3. イメージ保存モード選択

1. **device-image**: ディスク/パーティションをイメージとして保存
2. **local_dev**: ローカルデバイス（外付けHDD/USB）を選択
3. 外付けHDDをマウント
4. 保存先ディレクトリ選択: `/home/partimag/`

### 4. イメージ作成オプション

- **モード**: Beginner（初心者モード）
- **操作**: savedisk（ディスク全体を保存）
- **イメージ名**: `win11_master_YYYYMMDD`（例: `win11_master_20251117`）
- **保存対象**: ディスク全体（sda等）
- **圧縮レベル**: `-z1p`（並列gzip、バランス型）
- **分割サイズ**: デフォルト（4GB）
- **整合性チェック**: 有効（`-sfsck`）

### 5. イメージ作成実行

1. 設定確認後、Enterキー2回押下
2. イメージ作成開始（約30-60分）
3. 完了後、Clonezillaを終了

### 6. イメージ検証

```bash
# DRBLサーバ上で実行
cd /home/partimag/win11_master_20251117

# イメージファイル一覧確認
ls -lh

# 必須ファイル確認
# - disk（ディスク情報）
# - parts（パーティション情報）
# - sda*.gz（パーティションイメージ）
# - clonezilla-img（イメージメタデータ）

# 整合性確認
sha256sum sda*.gz > checksums.sha256
```

### 7. DRBLサーバへ転送

```bash
# 外付けHDDからDRBLサーバへコピー
rsync -avz --progress /media/external/win11_master_20251117/ \
      root@drbl-server:/home/partimag/win11_master_20251117/
```

---

## マスターイメージ更新時の注意事項

### 更新タイミング

1. **Windows 11のメジャーアップデート**（年2回: 春・秋）
2. **累積更新プログラムの蓄積**（3ヶ月ごと）
3. **会社標準アプリケーションの大幅変更**
4. **セキュリティポリシー変更**

### バージョン管理

```bash
# イメージ命名規則
win11_master_YYYYMMDD_v{version}

# 例
win11_master_20251117_v1.0  # 初版
win11_master_20260215_v2.0  # Windows 11 24H2対応
```

### ロールバック計画

- **過去3世代のイメージを保持**
- 新イメージ展開後、1週間は旧イメージを削除しない
- 問題発生時は即座に旧イメージへロールバック可能

### ドキュメント更新

マスターイメージ更新時は以下を更新：

- **変更履歴**: `docs/運用管理/マスターイメージ変更履歴.md`
- **アプリケーション一覧**: 本ガイド内の導入リスト
- **既知の問題**: トラブルシューティングセクション

---

## トラブルシューティング

### Sysprep失敗

#### 症状: AppXパッケージエラー

```
Error SYSPRP Package Microsoft.XXX was installed for a user, but not provisioned for all users.
```

**解決策**:
```powershell
# すべてのユーザー向けAppXを削除
Get-AppxPackage -AllUsers | Remove-AppxPackage -ErrorAction SilentlyContinue
```

#### 症状: ドライバエラー

```
Error SYSPRP Failed to remove driver package.
```

**解決策**:
1. デバイスマネージャーで不明なデバイスを削除
2. `C:\Windows\INF\setupapi.dev.log` でドライバ名確認
3. 該当ドライバをアンインストール

### Clonezillaイメージ展開失敗

#### 症状: パーティションサイズ不一致

**解決策**:
- マスターPCと展開先PCのディスク容量を確認
- 展開先が小さい場合は `-k1`オプション（パーティション自動リサイズ）使用

#### 症状: ブート失敗（UEFI）

**解決策**:
```bash
# UEFI起動修復
bootrec /fixboot
bootrec /rebuildbcd
```

### 初回起動後の自動セットアップ失敗

#### 症状: スクリプトが実行されない

**確認箇所**:
1. `C:\AutoSetup\setup.ps1` が存在するか
2. unattend.xmlのFirstLogonCommandsセクション確認
3. イベントログ（アプリケーションログ）でPowerShellエラー確認

**解決策**:
```powershell
# 手動実行
Set-ExecutionPolicy Bypass -Scope Process -Force
C:\AutoSetup\setup.ps1
```

---

## 付録

### 参考リンク

- [Microsoft: Sysprep公式ドキュメント](https://docs.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/sysprep--generalize--a-windows-installation)
- [Clonezilla公式サイト](https://clonezilla.org/)
- [DRBL公式ドキュメント](https://drbl.org/)

### 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2025-11-17 | 初版作成 |

---

**作成者**: API開発チーム
**承認者**: IT部門長
