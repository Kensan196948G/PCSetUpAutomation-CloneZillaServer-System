# トラブルシューティング集

## 目次
- [PXEブート関連](#pxeブート関連)
- [Clonezilla関連](#clonezilla関連)
- [PowerShell関連](#powershell関連)
- [API関連](#api関連)
- [ネットワーク関連](#ネットワーク関連)
- [データベース関連](#データベース関連)
- [ODJ関連](#odj関連)
- [その他](#その他)
- [緊急連絡先](#緊急連絡先)

---

## PXEブート関連

### PXE-001: PXEブートが開始されない

**症状**:
- PCを起動してもPXEブートメニューが表示されない
- "No bootable device found" エラー

**原因**:
1. BIOS設定でネットワークブートが無効化されている
2. ブート順序でネットワークが最優先になっていない
3. ネットワークケーブルが接続されていない
4. DRBLサーバのDHCPサービスが起動していない

**対処手順**:

```bash
# DRBLサーバでDHCPサービス確認
sudo systemctl status isc-dhcp-server
# または
sudo systemctl status dhcpd

# サービスが停止している場合、起動
sudo systemctl start isc-dhcp-server
sudo systemctl enable isc-dhcp-server

# DHCPログ確認
sudo tail -f /var/log/syslog | grep dhcp
```

**BIOS設定確認** (クライアントPC):
1. BIOS起動（通常F2, Del, F12等）
2. Boot → Network Boot 有効化
3. Boot Priority → Network Boot を最優先に設定
4. Secure Boot → 無効化（必要に応じて）

**予防策**:
- 標準BIOS設定手順書を作成
- DRBLサーバ自動起動設定確認

**緊急度**: 高
**対応所要時間**: 5-10分

---

### PXE-002: DHCP IPアドレスを取得できない

**症状**:
- "DHCP..." と表示されたまま進まない
- "PXE-E51: No DHCP or proxyDHCP offers were received"

**原因**:
1. DHCPスコープが枯渇している
2. ネットワークスイッチの問題
3. DHCP設定ファイルの誤り
4. ファイアウォールがDHCPをブロック

**対処手順**:

```bash
# DHCPリース状況確認
sudo cat /var/lib/dhcp/dhcpd.leases | grep lease

# DHCPスコープ確認
sudo cat /etc/dhcp/dhcpd.conf | grep range

# DHCPスコープ拡張（例: 192.168.1.100 - 192.168.1.200）
sudo nano /etc/dhcp/dhcpd.conf
# range 192.168.1.100 192.168.1.200; # 元の設定
# range 192.168.1.100 192.168.1.250; # 拡張

# DHCP再起動
sudo systemctl restart isc-dhcp-server

# ファイアウォール確認（UFW）
sudo ufw status
sudo ufw allow 67/udp
sudo ufw allow 68/udp
```

**ネットワークスイッチ確認**:
- スイッチのポートランプが点灯しているか確認
- 別のスイッチポートに変更して試行

**予防策**:
- DHCPスコープを十分に確保（最低50台分）
- DHCPリース時間を短縮（例: 1時間）

**緊急度**: 高
**対応所要時間**: 10-15分

---

### PXE-003: TFTPサーバに接続できない

**症状**:
- "TFTP..." と表示されたまま進まない
- "PXE-E32: TFTP open timeout"

**原因**:
1. TFTPサービスが起動していない
2. TFTPルートディレクトリが不正
3. ファイアウォールがTFTPをブロック
4. pxelinux.0ファイルが存在しない

**対処手順**:

```bash
# TFTPサービス確認
sudo systemctl status tftpd-hpa
# または
sudo systemctl status atftpd

# サービスが停止している場合、起動
sudo systemctl start tftpd-hpa
sudo systemctl enable tftpd-hpa

# TFTPルートディレクトリ確認
sudo cat /etc/default/tftpd-hpa
# TFTP_DIRECTORY="/var/lib/tftpboot" または "/tftpboot"

# pxelinux.0ファイル確認
sudo ls -l /var/lib/tftpboot/pxelinux.0

# ファイルが存在しない場合、DRBLを再設定
sudo drblsrv -i

# ファイアウォール設定
sudo ufw allow 69/udp

# TFTP接続テスト（別PCから）
sudo apt install tftp-hpa
tftp 192.168.1.10
tftp> get pxelinux.0
tftp> quit
```

**予防策**:
- TFTPサービス自動起動設定
- 定期的なTFTP接続確認

**緊急度**: 高
**対応所要時間**: 10-15分

---

### PXE-004: Clonezillaメニューが表示されない

**症状**:
- PXEブート後、黒い画面のまま進まない
- カーネルパニックが発生

**原因**:
1. Clonezillaイメージファイルが破損
2. NFS/NFSサービスが起動していない
3. pxelinux.cfg設定ファイルの誤り

**対処手順**:

```bash
# NFSサービス確認
sudo systemctl status nfs-server
sudo systemctl start nfs-server
sudo systemctl enable nfs-server

# NFS共有確認
sudo exportfs -v
# /home/partimag  192.168.1.0/24(rw,no_root_squash,async,no_subtree_check)

# pxelinux.cfg確認
sudo cat /var/lib/tftpboot/pxelinux.cfg/default

# Clonezillaカーネルファイル確認
sudo ls -l /var/lib/tftpboot/live/vmlinuz
sudo ls -l /var/lib/tftpboot/live/initrd.img

# ファイルが存在しない場合、DRBLを再設定
sudo drblpush -i
```

**予防策**:
- 定期的なDRBLサービス状態確認
- Clonezillaバージョン更新記録

**緊急度**: 高
**対応所要時間**: 15-20分

---

### PXE-005: 特定のPCだけPXEブートできない

**症状**:
- 他のPCは正常にPXEブートできるが、特定のPCだけ失敗する

**原因**:
1. ネットワークカードの互換性問題
2. UEFIモードとBIOSモードの不一致
3. MACアドレスフィルタリング

**対処手順**:

```bash
# DHCPログで該当PCのMACアドレス確認
sudo tail -f /var/log/syslog | grep DHCP

# MACアドレスベースの固定IP割り当て（必要に応じて）
sudo nano /etc/dhcp/dhcpd.conf
# host special-pc {
#   hardware ethernet AA:BB:CC:DD:EE:FF;
#   fixed-address 192.168.1.150;
# }

# DHCP再起動
sudo systemctl restart isc-dhcp-server
```

**クライアントPC設定**:
1. BIOSモード確認（UEFI or Legacy）
2. Secure Boot 無効化
3. Fast Boot 無効化
4. ネットワークカードドライバ更新

**予防策**:
- 対応ネットワークカード一覧作成
- 標準PC仕様統一

**緊急度**: 中
**対応所要時間**: 20-30分

---

### PXE-006: マルチキャストアドレス競合

**症状**:
- 複数台同時展開時、一部のPCが展開に参加できない

**原因**:
1. マルチキャストアドレス設定の誤り
2. ネットワークスイッチがマルチキャスト非対応

**対処手順**:

```bash
# マルチキャスト設定確認
sudo cat /etc/drbl/drblpush.conf | grep multicast

# マルチキャストアドレス変更
sudo drblpush -i
# "Do you want to use multicast?" → Yes
# "Multicast address" → 224.0.0.1（デフォルト、変更可）

# ネットワークスイッチのIGMP Snooping確認
# スイッチ管理画面でIGMP Snooping有効化
```

**予防策**:
- マルチキャスト対応スイッチ使用
- スイッチ設定ドキュメント化

**緊急度**: 中
**対応所要時間**: 15-20分

---

### PXE-007: PXEブート後にフリーズ

**症状**:
- PXEブート開始後、特定の画面でフリーズ
- キーボード入力を受け付けない

**原因**:
1. メモリ不足
2. ハードウェア互換性問題
3. Clonezillaカーネルパラメータ不適

**対処手順**:

```bash
# Clonezillaカーネルパラメータ追加
sudo nano /var/lib/tftpboot/pxelinux.cfg/default

# APPENDセクションに追加
# append initrd=live/initrd.img boot=live union=overlay username=user config components quiet noswap nolocales edd=on nomodeset ocs_live_run="ocs-live-general" ocs_live_extra_param="" keyboard-layouts=NONE ocs_live_batch="no" locales=en_US.UTF-8 vga=788 ip= net.ifnames=0 nosplash i915.blacklist=yes radeonhd.blacklist=yes nouveau.blacklist=yes vmwgfx.enable_fbdev=1
```

**クライアントPC確認**:
- メモリ最低4GB以上
- ディスプレイアダプタドライバの互換性

**予防策**:
- 標準ハードウェアスペック定義
- Clonezillaバージョン最新化

**緊急度**: 中
**対応所要時間**: 30-40分

---

### PXE-008: PXEブートは成功するが、イメージ一覧が表示されない

**症状**:
- Clonezillaメニューまで表示されるが、マスターイメージが選択肢に表示されない

**原因**:
1. マスターイメージ格納先パスの誤り
2. NFS共有権限の問題
3. イメージディレクトリ名の誤り

**対処手順**:

```bash
# マスターイメージ確認
sudo ls -l /home/partimag/
# drwxr-xr-x 2 root root 4096 Nov 16 12:00 win11-master-20251116

# NFS共有確認
sudo exportfs -v
# /home/partimag  192.168.1.0/24(rw,no_root_squash,async,no_subtree_check)

# NFS再エクスポート
sudo exportfs -ra

# NFSマウントテスト（別PCから）
sudo mount -t nfs 192.168.1.10:/home/partimag /mnt
ls /mnt
sudo umount /mnt
```

**予防策**:
- イメージ作成後、必ず一覧確認
- NFS共有権限ドキュメント化

**緊急度**: 高
**対応所要時間**: 10-15分

---

### PXE-009: "Kernel panic - not syncing" エラー

**症状**:
- PXEブート後、カーネルパニックエラーが表示される

**原因**:
1. initrd.imgファイル破損
2. カーネルバージョン不一致
3. ハードウェアドライバ非対応

**対処手順**:

```bash
# Clonezilla再インストール
sudo apt update
sudo apt reinstall clonezilla drbl

# DRBL再設定
sudo drblsrv -i
sudo drblpush -i

# カーネルファイル確認
sudo ls -lh /var/lib/tftpboot/live/vmlinuz
sudo ls -lh /var/lib/tftpboot/live/initrd.img

# ファイルサイズが異常に小さい場合、再取得
sudo drbl-ocs -b -g auto -e1 auto -e2 -r -j2 -k -p reboot restoredisk [image_name] [target_disk]
```

**予防策**:
- Clonezilla定期バージョン確認
- カーネルアップデート記録

**緊急度**: 高
**対応所要時間**: 30-45分

---

### PXE-010: DHCPとproxyDHCPの競合

**症状**:
- 既存のDHCPサーバとDRBL DHCPサーバが競合
- 誤ったIPアドレスを取得

**原因**:
1. ネットワーク内に複数のDHCPサーバが存在
2. proxyDHCP設定が不適切

**対処手順**:

```bash
# 既存DHCPサーバ確認
sudo nmap --script broadcast-dhcp-discover

# DRBLをproxyDHCPモードで運用
sudo drblsrv -i
# "Do you want to use the existing DHCP service in your network?" → Yes
# proxyDHCPモードに設定

# または既存DHCPサーバでPXEブート設定追加
# （既存DHCPサーバ設定ファイル例）
# next-server 192.168.1.10;
# filename "pxelinux.0";
```

**予防策**:
- ネットワーク設計時にDHCP運用方針決定
- DRBL専用VLANセグメント作成

**緊急度**: 中
**対応所要時間**: 20-30分

---

## Clonezilla関連

### CLZ-001: イメージ展開が途中で停止する

**症状**:
- イメージ展開が50%程度で停止
- "Broken pipe" エラー

**原因**:
1. ネットワーク接続不安定
2. ディスク不良セクタ
3. DRBLサーバのディスク容量不足

**対処手順**:

```bash
# DRBLサーバディスク容量確認
df -h /home/partimag

# 容量不足の場合、古いイメージ削除
sudo rm -rf /home/partimag/old-image-*

# ネットワーク接続確認（クライアントから）
ping 192.168.1.10

# ディスクエラーチェック（クライアントPC）
# Clonezillaメニューから "Enter shell" を選択
sudo badblocks -v /dev/sda
```

**予防策**:
- 定期的なディスク容量監視
- ネットワークケーブル品質確認
- クライアントPCディスク事前チェック

**緊急度**: 高
**対応所要時間**: 20-30分

---

### CLZ-002: イメージ展開後、Windowsが起動しない

**症状**:
- イメージ展開完了後、再起動してもWindowsが起動しない
- "No bootable device" エラー

**原因**:
1. ブートローダーが破損
2. UEFIとBIOSモードの不一致
3. パーティションテーブル破損

**対処手順**:

```bash
# Clonezilla Live USBで起動
# "Enter shell" を選択

# パーティション確認
sudo fdisk -l /dev/sda

# UEFIブートローダー修復
sudo mkdir /mnt/sda1
sudo mount /dev/sda1 /mnt/sda1
sudo mount /dev/sda2 /mnt/sda2

# EFIパーティション確認
ls /mnt/sda1/EFI/Microsoft/Boot/

# bootmgfw.efi が存在するか確認
# 存在しない場合、マスターイメージから再展開
```

**BIOS設定確認**:
- Boot Mode: UEFI（マスターPCと同じモード）
- Secure Boot: 無効
- CSM: 無効（UEFI Pure Mode）

**予防策**:
- マスターPC作成時にUEFI/BIOSモード統一
- ブートローダー確認手順書作成

**緊急度**: 高
**対応所要時間**: 30-45分

---

### CLZ-003: イメージ作成時に "Not enough space" エラー

**症状**:
- マスターイメージ作成時、容量不足エラー

**原因**:
1. /home/partimag のディスク容量不足
2. 圧縮率が低い
3. 一時ファイルが残存

**対処手順**:

```bash
# ディスク容量確認
df -h /home/partimag

# 不要な古いイメージ削除
sudo ls -lh /home/partimag/
sudo rm -rf /home/partimag/old-image-20241101

# 一時ファイル削除
sudo rm -rf /tmp/ocs-*

# 圧縮形式変更（zstd推奨）
# Clonezillaイメージ作成時、圧縮オプションで "-z1p" を選択
# -z1p: zstd最高圧縮率
```

**予防策**:
- /home/partimag 専用パーティション作成（最低500GB）
- イメージ作成前のディスク容量確認
- 定期的な古いイメージ削除運用

**緊急度**: 中
**対応所要時間**: 15-20分

---

### CLZ-004: マルチキャスト展開で一部のPCだけ失敗

**症状**:
- 10台同時展開で、2-3台だけ展開失敗
- エラーメッセージ: "Multicast timeout"

**原因**:
1. ネットワークスイッチのマルチキャスト設定不適
2. 特定PCのネットワークカード性能不足
3. マルチキャストバッファ不足

**対処手順**:

```bash
# マルチキャストタイムアウト延長
sudo nano /etc/drbl/drblpush.conf
# multicast_max_wait_time="3600" # 60分に延長

# udpcastバッファサイズ増加
sudo nano /opt/drbl/sbin/ocs-run
# --max-bitrate 1000m # ビットレート上限設定
# --min-receivers 1 # 最小受信者数（1台でも開始）

# DRBLサービス再起動
sudo systemctl restart drbl
```

**ネットワークスイッチ設定**:
- IGMP Snooping 有効化
- マルチキャストフラッディング有効化

**予防策**:
- マルチキャスト展開前の接続確認
- 失敗PCは個別展開（unicast）

**緊急度**: 中
**対応所要時間**: 20-30分

---

### CLZ-005: イメージファイルが破損している

**症状**:
- イメージ展開時、"Checksum mismatch" エラー
- ファイル破損警告

**原因**:
1. イメージ作成時のエラー
2. ネットワーク転送時の破損
3. ディスク不良

**対処手順**:

```bash
# イメージファイル整合性確認
sudo /usr/sbin/ocs-chkimg -b -g auto -e1 auto -e2 -nogui -i 2000 /home/partimag/win11-master-20251116

# チェックサムエラーが出た場合、イメージ再作成
# マスターPCから再度イメージ作成

# DRBLサーバディスクチェック
sudo smartctl -a /dev/sda
sudo badblocks -v /dev/sda
```

**予防策**:
- イメージ作成後、必ず整合性確認
- イメージファイルバックアップ作成
- 定期的なディスクヘルスチェック

**緊急度**: 高
**対応所要時間**: 60-90分（イメージ再作成含む）

---

### CLZ-006: 圧縮イメージ展開が遅い

**症状**:
- イメージ展開に1時間以上かかる
- 通常より著しく遅い

**原因**:
1. 圧縮形式が高圧縮率（展開時CPU負荷高）
2. クライアントPCのCPU性能不足
3. ネットワーク帯域不足

**対処手順**:

```bash
# 現在のイメージ圧縮形式確認
sudo cat /home/partimag/win11-master-20251116/parts

# 圧縮形式を変更してイメージ再作成
# 推奨: zstd（バランス型）
# -z1: gzip（低圧縮、高速）
# -z2: bzip2（中圧縮、中速）
# -z3: lzop（最低圧縮、最高速）
# -z5: xz（高圧縮、低速）
# -z1p: zstd（バランス、推奨）

# ネットワーク帯域確認
sudo iftop -i eth0
```

**予防策**:
- 用途に応じた圧縮形式選択
- クライアントPC最低スペック定義（CPU: 4コア以上）

**緊急度**: 低
**対応所要時間**: 90-120分（イメージ再作成含む）

---

### CLZ-007: "Partition table mismatch" エラー

**症状**:
- イメージ展開時、パーティションテーブル不一致エラー

**原因**:
1. マスターPCとクライアントPCのディスクサイズが異なる
2. パーティションテーブル形式が異なる（GPT vs MBR）

**対処手順**:

```bash
# Clonezillaオプションで "-icds" を使用
# -icds: ディスクサイズ異なる場合もスキップ

# または "-k1" オプション使用
# -k1: パーティションテーブル再作成

# Clonezilla Expert modeで実行
# "restoredisk" → Expert mode → "-icds -k1" オプション選択
```

**予防策**:
- クライアントPCディスクサイズ統一（最低128GB）
- パーティションテーブル形式統一（GPT推奨）

**緊急度**: 中
**対応所要時間**: 15-20分

---

### CLZ-008: NFS接続タイムアウト

**症状**:
- イメージ展開中、"NFS timeout" エラー
- ネットワーク切断エラー

**原因**:
1. NFSサーバが過負荷
2. ネットワーク不安定
3. NFSタイムアウト設定が短い

**対処手順**:

```bash
# NFS接続状態確認
sudo showmount -e 192.168.1.10

# NFSタイムアウト延長
sudo nano /etc/default/nfs-common
# RPCMOUNTDOPTS="--timeout 120" # 120秒に延長

# NFSサービス再起動
sudo systemctl restart nfs-server

# NFS再接続（クライアント側）
sudo umount /home/partimag
sudo mount -t nfs -o timeo=120,retrans=5 192.168.1.10:/home/partimag /home/partimag
```

**予防策**:
- NFSタイムアウト初期設定を長めに設定
- 同時展開台数制限（最大20台）

**緊急度**: 中
**対応所要時間**: 10-15分

---

## PowerShell関連

### PS-001: PowerShellスクリプトが自動起動しない

**症状**:
- Windows初回起動後、PowerShellスクリプトが実行されない
- セットアップが開始されない

**原因**:
1. 自動起動設定（RunOnce/タスクスケジューラ）が不正
2. 実行ポリシーでスクリプト実行がブロック
3. unattend.xmlの設定誤り

**対処手順**:

```powershell
# 自動起動設定確認
Get-ItemProperty -Path "HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce"

# タスクスケジューラ確認
Get-ScheduledTask | Where-Object {$_.TaskName -like "*Setup*"}

# 実行ポリシー確認
Get-ExecutionPolicy -List

# 実行ポリシー変更（必要に応じて）
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope LocalMachine -Force

# 手動でスクリプト実行
PowerShell.exe -ExecutionPolicy Bypass -File "C:\Setup\setup.ps1"
```

**unattend.xml確認**:

```xml
<FirstLogonCommands>
  <SynchronousCommand wcm:action="add">
    <Order>1</Order>
    <CommandLine>PowerShell.exe -ExecutionPolicy Bypass -File "C:\Setup\setup.ps1"</CommandLine>
  </SynchronousCommand>
</FirstLogonCommands>
```

**予防策**:
- マスターPC作成時にunattend.xml動作確認
- 実行ポリシー初期設定ドキュメント化

**緊急度**: 高
**対応所要時間**: 15-20分

---

### PS-002: Serial番号が取得できない

**症状**:
- `Get-CimInstance Win32_BIOS` で Serial番号が空
- API呼び出しに失敗

**原因**:
1. BIOS Serial番号が設定されていない
2. 仮想マシンで実行（Serial番号がダミー）
3. WMIサービスが起動していない

**対処手順**:

```powershell
# Serial番号取得確認
Get-CimInstance Win32_BIOS | Select-Object SerialNumber

# WMIサービス確認
Get-Service -Name Winmgmt
Start-Service -Name Winmgmt

# 代替方法: コマンドプロンプト
wmic bios get serialnumber

# Serial番号が取得できない場合、MACアドレス使用（代替案）
Get-NetAdapter | Select-Object Name, MacAddress
```

**BIOS設定確認**:
- BIOS画面で Serial番号が設定されているか確認
- 未設定の場合、BIOS管理者に連絡

**予防策**:
- PC調達時にSerial番号必須要求
- Serial番号確認手順書作成

**緊急度**: 高
**対応所要時間**: 10-15分

---

### PS-003: API呼び出しで "Connection timeout" エラー

**症状**:
- `Invoke-RestMethod` でタイムアウトエラー
- APIサーバに接続できない

**原因**:
1. DRBLサーバが起動していない
2. ネットワーク接続不良
3. ファイアウォールがHTTP/HTTPSをブロック

**対処手順**:

```powershell
# ネットワーク接続確認
Test-Connection -ComputerName 192.168.1.10 -Count 4

# API接続確認
Invoke-WebRequest -Uri "http://192.168.1.10:5000/api/pcinfo?serial=TEST" -UseBasicParsing

# ファイアウォール無効化テスト（一時的）
Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

# DRBLサーバでFlaskアプリ起動確認（DRBLサーバ側）
sudo systemctl status flask-app
sudo journalctl -u flask-app -f
```

**予防策**:
- APIサーバ自動起動設定
- ファイアウォール例外設定ドキュメント化

**緊急度**: 高
**対応所要時間**: 10-15分

---

### PS-004: PC名変更が失敗する

**症状**:
- `Rename-Computer` コマンドでエラー
- PC名が変更されない

**原因**:
1. PC名形式が不正（長すぎる、使用不可文字）
2. ドメイン参加済み（ドメイン参加後はPC名変更不可）
3. 管理者権限不足

**対処手順**:

```powershell
# 現在のPC名確認
hostname

# PC名変更（管理者権限必要）
Rename-Computer -NewName "20251116M" -Force -PassThru

# エラー詳細確認
$Error[0] | Format-List * -Force

# ドメイン参加状態確認
(Get-WmiObject Win32_ComputerSystem).Domain

# ドメイン参加後にPC名変更が必要な場合、ドメイン離脱後に実行
Remove-Computer -WorkgroupName "WORKGROUP" -Force -Restart
# 再起動後
Rename-Computer -NewName "20251116M" -Force -Restart
```

**PC名規則確認**:
- 最大15文字
- 使用可能文字: A-Z, 0-9, ハイフン（先頭/末尾不可）
- YYYYMMDDM形式: 9文字（問題なし）

**予防策**:
- PC名設定をドメイン参加前に実行
- セットアップ順序ドキュメント化

**緊急度**: 中
**対応所要時間**: 10-15分

---

### PS-005: Windows Update実行時にエラー

**症状**:
- `Install-WindowsUpdate` でエラー
- Windows Updateが完了しない

**原因**:
1. PSWindowsUpdateモジュール未インストール
2. Windows Updateサービス停止
3. ディスク容量不足
4. インターネット接続不良

**対処手順**:

```powershell
# PSWindowsUpdateモジュール確認
Get-Module -ListAvailable -Name PSWindowsUpdate

# モジュール未インストールの場合、インストール
Install-Module -Name PSWindowsUpdate -Force -Scope AllUsers

# Windows Updateサービス確認
Get-Service -Name wuauserv
Start-Service -Name wuauserv

# ディスク容量確認
Get-PSDrive C | Select-Object Used,Free

# Windows Update実行
Install-WindowsUpdate -AcceptAll -IgnoreReboot -Verbose

# 更新履歴確認
Get-WUHistory | Select-Object -First 10
```

**予防策**:
- マスターイメージにPSWindowsUpdateモジュール事前インストール
- ディスク容量最低20GB空き確保

**緊急度**: 中
**対応所要時間**: 20-30分

---

### PS-006: djoin.exeが失敗する

**症状**:
- `djoin.exe` 実行時にエラー
- ドメイン参加できない

**原因**:
1. ODJファイルが破損
2. ODJファイルパス誤り
3. Active Directoryとの通信不可

**対処手順**:

```powershell
# ODJファイル存在確認
Test-Path "C:\Temp\20251116M.txt"

# ODJファイル内容確認（Base64エンコードされている）
Get-Content "C:\Temp\20251116M.txt"

# djoin実行（詳細ログ出力）
djoin.exe /requestODJ /loadfile "C:\Temp\20251116M.txt" /windowspath %SystemRoot% /localos

# エラーコード確認
echo $LASTEXITCODE

# Active Directory接続確認
Test-Connection -ComputerName dc01.company.local -Count 4
nslookup dc01.company.local
```

**一般的なエラーコード**:
- 50: ODJファイルが不正
- 87: パラメータエラー
- 1355: ドメインコントローラに接続できない

**予防策**:
- ODJファイル生成後、テスト環境で検証
- Active Directoryドメインコントローラ死活監視

**緊急度**: 高
**対応所要時間**: 15-20分

---

### PS-007: ログファイルが作成されない

**症状**:
- `C:\SetupLogs\` ディレクトリが作成されない
- ログが記録されない

**原因**:
1. ディレクトリ作成権限不足
2. スクリプトエラーで途中終了
3. ディスク容量不足

**対処手順**:

```powershell
# ディレクトリ手動作成
New-Item -Path "C:\SetupLogs" -ItemType Directory -Force

# 権限確認
Get-Acl "C:\SetupLogs"

# 権限設定（Administratorsフルコントロール）
$acl = Get-Acl "C:\SetupLogs"
$permission = "BUILTIN\Administrators","FullControl","ContainerInherit,ObjectInherit","None","Allow"
$accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule $permission
$acl.SetAccessRule($accessRule)
Set-Acl "C:\SetupLogs" $acl

# ログ記録テスト
"Test log" | Out-File "C:\SetupLogs\test.log" -Append
```

**予防策**:
- スクリプト冒頭でログディレクトリ作成処理追加
- エラーハンドリング強化

**緊急度**: 低
**対応所要時間**: 5-10分

---

### PS-008: スクリプト実行中にブルースクリーン

**症状**:
- セットアップ中にブルースクリーンエラー（BSOD）
- 自動再起動ループ

**原因**:
1. ドライバ不具合
2. ハードウェア不良
3. Windows Updateでの不具合

**対処手順**:

```powershell
# セーフモードで起動
# 起動時にF8キー連打 → セーフモード選択

# イベントログ確認
Get-EventLog -LogName System -Newest 50 | Where-Object {$_.EntryType -eq "Error"}

# ブルースクリーンエラーコード確認
# C:\Windows\Minidump\ に.dmpファイルが生成される
# BlueScreenView等のツールで解析

# 問題のあるドライバ無効化
Disable-PnpDevice -InstanceId "デバイスインスタンスID" -Confirm:$false

# Windows Update ロールバック
dism /online /get-packages
dism /online /remove-package /packagename:[パッケージ名]
```

**予防策**:
- マスターPC作成時にドライバ最新化
- ハードウェア互換性リスト作成

**緊急度**: 高
**対応所要時間**: 30-60分

---

## API関連

### API-001: Flask APIが起動しない

**症状**:
- `sudo systemctl status flask-app` で "failed" 表示
- APIサーバに接続できない

**原因**:
1. Pythonパッケージ不足
2. ポート5000が既に使用中
3. 設定ファイルエラー

**対処手順**:

```bash
# Flask起動ログ確認
sudo journalctl -u flask-app -n 50

# Pythonパッケージ確認
pip3 list | grep Flask
pip3 list | grep SQLAlchemy

# 不足パッケージインストール
sudo pip3 install Flask Flask-SQLAlchemy Flask-CORS

# ポート使用状況確認
sudo netstat -tlnp | grep 5000
sudo lsof -i :5000

# ポート5000を使用しているプロセス停止
sudo kill -9 [PID]

# Flask手動起動（デバッグモード）
cd /opt/flask-app
python3 app.py

# systemdサービス再起動
sudo systemctl restart flask-app
```

**予防策**:
- Flask起動前にポート確認
- 依存パッケージリスト作成（requirements.txt）

**緊急度**: 高
**対応所要時間**: 10-15分

---

### API-002: データベース接続エラー

**症状**:
- API呼び出し時に "Database connection error"
- SQLiteファイルが見つからない

**原因**:
1. データベースファイルパス誤り
2. データベースファイル権限不足
3. データベース初期化未実施

**対処手順**:

```bash
# データベースファイル確認
ls -l /opt/flask-app/pc_setup.db

# ファイルが存在しない場合、データベース初期化
cd /opt/flask-app
python3 << EOF
from app import db
db.create_all()
print("Database initialized")
EOF

# データベース権限設定
sudo chown www-data:www-data /opt/flask-app/pc_setup.db
sudo chmod 664 /opt/flask-app/pc_setup.db

# データベース接続テスト
sqlite3 /opt/flask-app/pc_setup.db "SELECT * FROM pc_master LIMIT 5;"
```

**予防策**:
- データベース初期化手順ドキュメント化
- バックアップ運用開始

**緊急度**: 高
**対応所要時間**: 10-15分

---

### API-003: 404 Not Found エラー（Serial未登録）

**症状**:
- `/api/pcinfo?serial=XXX` で404エラー
- Serial番号が見つからない

**原因**:
1. Serial番号がpc_masterテーブルに未登録
2. Serial番号の大文字小文字不一致
3. CSVインポート失敗

**対処手順**:

```bash
# データベース直接確認
sqlite3 /opt/flask-app/pc_setup.db

# SQLiteプロンプトで
sqlite> SELECT * FROM pc_master WHERE serial = 'ABC123456789';

# Serial番号一覧確認
sqlite> SELECT serial, pcname FROM pc_master ORDER BY created_at DESC LIMIT 10;

# Serial番号手動登録
sqlite> INSERT INTO pc_master (serial, pcname, odj_path, created_at) VALUES ('ABC123456789', '20251116M', '/srv/odj/20251116M.txt', datetime('now'));

# .quit でSQLite終了
sqlite> .quit

# API再テスト
curl "http://192.168.1.10:5000/api/pcinfo?serial=ABC123456789"
```

**予防策**:
- CSV一括インポート前にSerial番号重複確認
- Serial番号登録確認手順書作成

**緊急度**: 中
**対応所要時間**: 5-10分

---

### API-004: 500 Internal Server Error

**症状**:
- API呼び出し時に500エラー
- サーバ内部エラー

**原因**:
1. Pythonコードエラー
2. データベーススキーマ不一致
3. 未処理例外

**対処手順**:

```bash
# Flaskログ確認
sudo journalctl -u flask-app -f

# Python手動実行でエラー詳細確認
cd /opt/flask-app
python3 app.py

# エラースタックトレース確認
# Flaskデバッグモード有効化（本番環境では無効化）
sudo nano /opt/flask-app/app.py
# app.run(debug=True, host='0.0.0.0', port=5000)

# Flask再起動
sudo systemctl restart flask-app
```

**予防策**:
- エラーハンドリング実装
- ログレベル設定（INFO, ERROR）
- 例外発生時の詳細ログ記録

**緊急度**: 高
**対応所要時間**: 15-20分

---

### API-005: APIレスポンスが遅い（200ms超過）

**症状**:
- API応答時間が500ms以上
- セットアップ処理が遅延

**原因**:
1. データベースインデックス未設定
2. 大量レコードで全件スキャン
3. DRBLサーバのリソース不足

**対処手順**:

```bash
# データベースインデックス追加
sqlite3 /opt/flask-app/pc_setup.db

sqlite> CREATE INDEX idx_serial ON pc_master(serial);
sqlite> CREATE INDEX idx_pcname ON pc_master(pcname);
sqlite> .quit

# クエリ実行計画確認
sqlite3 /opt/flask-app/pc_setup.db
sqlite> EXPLAIN QUERY PLAN SELECT * FROM pc_master WHERE serial = 'ABC123456789';

# DRBLサーバリソース確認
top
free -h
iostat

# Flaskワーカー数増加（Gunicorn使用）
sudo pip3 install gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

**予防策**:
- データベース設計時にインデックス設定
- 定期的なパフォーマンステスト

**緊急度**: 中
**対応所要時間**: 15-20分

---

### API-006: CORS エラー（ブラウザから呼び出し時）

**症状**:
- ブラウザから`fetch()`でAPI呼び出し時、CORSエラー
- "Access-Control-Allow-Origin" エラー

**原因**:
1. Flask-CORS未設定
2. CORSヘッダー不足

**対処手順**:

```bash
# Flask-CORSインストール
sudo pip3 install Flask-CORS

# app.py修正
sudo nano /opt/flask-app/app.py
```

```python
from flask import Flask
from flask_cors import CORS

app = Flask(__name__)
CORS(app)  # すべてのドメインからのリクエスト許可

# または特定ドメインのみ許可
# CORS(app, resources={r"/api/*": {"origins": "http://192.168.1.10"}})
```

```bash
# Flask再起動
sudo systemctl restart flask-app
```

**予防策**:
- Flask初期構築時にCORS設定
- セキュリティ要件に応じたCORS設定

**緊急度**: 低
**対応所要時間**: 5-10分

---

## ネットワーク関連

### NET-001: ネットワーク速度が遅い（100Mbps以下）

**症状**:
- イメージ展開が著しく遅い
- ネットワーク速度が100Mbps以下

**原因**:
1. LANケーブルがCat5（100Mbps上限）
2. スイッチポートが100Mbpsモード
3. オートネゴシエーション失敗

**対処手順**:

```bash
# DRBLサーバでネットワーク速度確認
ethtool eth0 | grep Speed
# Speed: 1000Mb/s（期待値）

# オートネゴシエーション確認
ethtool eth0 | grep "Auto-negotiation"
# Auto-negotiation: on

# ネットワーク速度固定設定（一時的）
sudo ethtool -s eth0 speed 1000 duplex full autoneg off

# 恒久的設定（/etc/network/interfaces）
sudo nano /etc/network/interfaces
# post-up ethtool -s eth0 speed 1000 duplex full autoneg off
```

**LANケーブル確認**:
- Cat5e以上使用（Gigabit対応）
- ケーブル長20m以下推奨

**スイッチ確認**:
- Gigabit Ethernet対応スイッチ
- ポート速度設定確認

**予防策**:
- 標準LANケーブル規格統一（Cat6推奨）
- スイッチポート設定ドキュメント化

**緊急度**: 高
**対応所要時間**: 10-15分

---

### NET-002: IPアドレス競合

**症状**:
- "IP address conflict" エラー
- ネットワーク接続不安定

**原因**:
1. 固定IPアドレス重複
2. DHCPスコープ外の固定IP使用
3. 他デバイスとの競合

**対処手順**:

```bash
# IPアドレス確認
ip addr show

# ARP テーブル確認（重複MACアドレス検出）
arp -a | grep 192.168.1.10

# DHCP リース確認
sudo cat /var/lib/dhcp/dhcpd.leases | grep 192.168.1.10

# 競合している場合、DHCPリース削除
sudo nano /var/lib/dhcp/dhcpd.leases
# 該当エントリ削除

# DHCP再起動
sudo systemctl restart isc-dhcp-server

# 固定IP再設定
sudo nano /etc/netplan/00-installer-config.yaml
# addresses: [192.168.1.11/24]  # IPアドレス変更

sudo netplan apply
```

**予防策**:
- 固定IPアドレス管理表作成
- DHCPスコープと固定IP範囲分離

**緊急度**: 高
**対応所要時間**: 10-15分

---

### NET-003: DNS名前解決失敗

**症状**:
- `nslookup dc01.company.local` で失敗
- ドメインコントローラに接続できない

**原因**:
1. DNSサーバ設定誤り
2. DNSサーバダウン
3. ネットワーク経路問題

**対処手順**:

```bash
# DNS設定確認
cat /etc/resolv.conf
# nameserver 192.168.1.1

# DNS動作確認
nslookup google.com 8.8.8.8  # Googleパブリック DNS

# 社内DNS確認
nslookup dc01.company.local 192.168.1.1

# DNS設定変更（一時的）
sudo nano /etc/resolv.conf
# nameserver 192.168.1.1  # 社内DNSサーバ
# nameserver 8.8.8.8      # Googleパブリック DNS（フォールバック）

# DNS設定変更（恒久的、Netplan）
sudo nano /etc/netplan/00-installer-config.yaml
# nameservers:
#   addresses: [192.168.1.1, 8.8.8.8]

sudo netplan apply
```

**予防策**:
- DNS冗長化設定（プライマリ、セカンダリ）
- DNSサーバ死活監視

**緊急度**: 中
**対応所要時間**: 10-15分

---

### NET-004: ファイアウォールでブロックされている

**症状**:
- `telnet 192.168.1.10 5000` で接続失敗
- "Connection refused"

**原因**:
1. UFWファイアウォールでポートブロック
2. iptablesルール不適

**対処手順**:

```bash
# UFW状態確認
sudo ufw status verbose

# 必要ポート開放
sudo ufw allow 5000/tcp  # Flask API
sudo ufw allow 67/udp    # DHCP
sudo ufw allow 69/udp    # TFTP
sudo ufw allow 2049/tcp  # NFS

# UFW無効化テスト（一時的）
sudo ufw disable

# 接続テスト
telnet 192.168.1.10 5000

# UFW再有効化
sudo ufw enable

# iptables確認
sudo iptables -L -n -v
```

**予防策**:
- ファイアウォールルールドキュメント化
- 必要ポート一覧作成

**緊急度**: 高
**対応所要時間**: 10-15分

---

### NET-005: スイッチングループ発生

**症状**:
- ネットワーク全体が応答しない
- スイッチポートランプ高速点滅

**原因**:
1. ネットワークケーブル誤接続（ループ）
2. STP（スパニングツリープロトコル）未設定

**対処手順**:

```bash
# ネットワークトポロジー確認
# 物理的にケーブル接続を確認し、ループを特定

# 一時的にポート無効化（スイッチ側）
# スイッチ管理画面で該当ポート無効化

# STP設定確認（スイッチ管理画面）
# Spanning Tree Protocol: Enabled
```

**予防策**:
- ネットワーク配線図作成
- スイッチSTP有効化
- ケーブル接続手順書作成

**緊急度**: 高
**対応所要時間**: 15-30分

---

### NET-006: VLANタグ不一致

**症状**:
- 特定のPCだけネットワーク接続できない
- DRBLサーバに接続できない

**原因**:
1. VLAN設定不一致
2. トランクポート設定誤り

**対処手順**:

```bash
# VLAN設定確認（DRBLサーバ）
ip link show
# eth0.10@eth0: VLAN ID 10

# VLAN設定追加（必要に応じて）
sudo apt install vlan
sudo modprobe 8021q

sudo nano /etc/netplan/00-installer-config.yaml
# network:
#   version: 2
#   ethernets:
#     eth0:
#       dhcp4: no
#   vlans:
#     vlan10:
#       id: 10
#       link: eth0
#       addresses: [192.168.10.10/24]

sudo netplan apply
```

**スイッチ設定確認**:
- DRBLサーバポート: Trunk Port（全VLANタグ通過）
- クライアントポート: Access Port（VLAN 10）

**予防策**:
- VLAN設計ドキュメント作成
- スイッチポート設定一覧表

**緊急度**: 中
**対応所要時間**: 20-30分

---

### NET-007: マルチキャストパケット届かない

**症状**:
- マルチキャスト展開で特定のPCだけ参加できない

**原因**:
1. スイッチでIGMP Snooping無効
2. マルチキャストルーティング設定不足

**対処手順**:

```bash
# マルチキャストルート確認
route -n
netstat -g

# マルチキャストアドレス追加
sudo ip maddr add 224.0.0.1 dev eth0

# スイッチ設定確認（管理画面）
# IGMP Snooping: Enabled
# Multicast Flooding: Enabled
```

**予防策**:
- マルチキャスト対応スイッチ使用
- IGMP Snooping初期設定

**緊急度**: 中
**対応所要時間**: 15-20分

---

### NET-008: ネットワークケーブル断線

**症状**:
- イメージ展開中に突然切断
- "Network unreachable"

**原因**:
1. LANケーブル物理的断線
2. コネクタ接触不良
3. スイッチポート故障

**対処手順**:

```bash
# リンク状態確認
ethtool eth0 | grep "Link detected"
# Link detected: yes

# ケーブルテスター使用
# LANケーブルテスターで断線確認

# 別のケーブル/ポートで試行
# スイッチポート変更

# ネットワークインターフェース再起動
sudo ip link set eth0 down
sudo ip link set eth0 up
```

**予防策**:
- 予備LANケーブル常備
- ケーブル品質確認
- 定期的なケーブル点検

**緊急度**: 高
**対応所要時間**: 5-10分

---

## データベース関連

### DB-001: SQLiteデータベースロック

**症状**:
- "database is locked" エラー
- API書き込みが失敗

**原因**:
1. 複数プロセスが同時書き込み
2. トランザクション未コミット
3. 長時間ロック保持

**対処手順**:

```bash
# データベースロック確認
sudo fuser /opt/flask-app/pc_setup.db

# ロックしているプロセス停止
sudo fuser -k /opt/flask-app/pc_setup.db

# データベース整合性確認
sqlite3 /opt/flask-app/pc_setup.db "PRAGMA integrity_check;"

# WALモード有効化（並行アクセス改善）
sqlite3 /opt/flask-app/pc_setup.db "PRAGMA journal_mode=WAL;"

# Flask再起動
sudo systemctl restart flask-app
```

**予防策**:
- SQLite WALモード初期設定
- PostgreSQL/MySQL移行検討（100台以上規模）

**緊急度**: 中
**対応所要時間**: 10-15分

---

### DB-002: データベース破損

**症状**:
- "database disk image is malformed" エラー
- データ読み取り不可

**原因**:
1. 不正なシャットダウン
2. ディスク不良
3. ファイルシステムエラー

**対処手順**:

```bash
# バックアップから復元
sudo cp /backup/pc_setup.db.bak /opt/flask-app/pc_setup.db

# データベース修復試行
sqlite3 /opt/flask-app/pc_setup.db ".recover" | sqlite3 /opt/flask-app/pc_setup_recovered.db

# 修復確認
sqlite3 /opt/flask-app/pc_setup_recovered.db "SELECT COUNT(*) FROM pc_master;"

# 修復成功の場合、置き換え
sudo mv /opt/flask-app/pc_setup.db /opt/flask-app/pc_setup.db.broken
sudo mv /opt/flask-app/pc_setup_recovered.db /opt/flask-app/pc_setup.db

# Flask再起動
sudo systemctl restart flask-app
```

**予防策**:
- 定期的なデータベースバックアップ（毎日）
- ディスクヘルスチェック

**緊急度**: 高
**対応所要時間**: 30-45分

---

### DB-003: レコード重複エラー

**症状**:
- "UNIQUE constraint failed: pc_master.serial" エラー
- CSV一括登録失敗

**原因**:
1. 同じSerial番号を重複登録
2. CSVファイルに重複エントリ

**対処手順**:

```bash
# 重複確認
sqlite3 /opt/flask-app/pc_setup.db "SELECT serial, COUNT(*) FROM pc_master GROUP BY serial HAVING COUNT(*) > 1;"

# 重複レコード削除（IDが小さい方を残す）
sqlite3 /opt/flask-app/pc_setup.db << EOF
DELETE FROM pc_master
WHERE id NOT IN (
  SELECT MIN(id)
  FROM pc_master
  GROUP BY serial
);
EOF

# CSV重複確認（登録前）
sort pc_list.csv | uniq -d
```

**予防策**:
- CSV登録前に重複チェック実装
- Serial番号UNIQUE制約維持

**緊急度**: 低
**対応所要時間**: 10-15分

---

### DB-004: テーブルスキーマ不一致

**症状**:
- "no such column" エラー
- APIがカラムを見つけられない

**原因**:
1. データベース初期化不足
2. スキーマ変更未適用

**対処手順**:

```bash
# テーブルスキーマ確認
sqlite3 /opt/flask-app/pc_setup.db ".schema pc_master"

# カラム一覧確認
sqlite3 /opt/flask-app/pc_setup.db "PRAGMA table_info(pc_master);"

# カラム追加（例: status カラム）
sqlite3 /opt/flask-app/pc_setup.db "ALTER TABLE pc_master ADD COLUMN status TEXT DEFAULT 'pending';"

# データベース再作成（全データ削除注意）
cd /opt/flask-app
python3 << EOF
from app import db
db.drop_all()
db.create_all()
print("Database recreated")
EOF
```

**予防策**:
- データベースマイグレーション管理（Flask-Migrate）
- スキーマバージョン管理

**緊急度**: 中
**対応所要時間**: 15-20分

---

### DB-005: バックアップ失敗

**症状**:
- 定期バックアップが実行されない
- バックアップファイルが古い

**原因**:
1. cronジョブ未設定
2. バックアップスクリプトエラー
3. ディスク容量不足

**対処手順**:

```bash
# バックアップスクリプト作成
sudo nano /opt/flask-app/backup.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/backup/db"
DB_FILE="/opt/flask-app/pc_setup.db"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
sqlite3 $DB_FILE ".backup '$BACKUP_DIR/pc_setup_$DATE.db'"

# 7日以上前のバックアップ削除
find $BACKUP_DIR -name "pc_setup_*.db" -mtime +7 -delete
```

```bash
# 実行権限付与
sudo chmod +x /opt/flask-app/backup.sh

# cronジョブ設定（毎日午前3時）
sudo crontab -e
# 0 3 * * * /opt/flask-app/backup.sh >> /var/log/db_backup.log 2>&1

# 手動実行テスト
sudo /opt/flask-app/backup.sh

# バックアップ確認
ls -lh /backup/db/
```

**予防策**:
- バックアップ運用ドキュメント化
- バックアップ成功/失敗通知設定

**緊急度**: 中
**対応所要時間**: 15-20分

---

## ODJ関連

### ODJ-001: ODJファイルが生成されない

**症状**:
- Active DirectoryでODJファイル生成に失敗
- `djoin.exe /provision` エラー

**原因**:
1. ドメイン管理者権限不足
2. コンピュータオブジェクト作成権限なし
3. Active Directoryサービス異常

**対処手順**:

```powershell
# ドメインコントローラで実行（管理者権限）
djoin.exe /provision /domain company.local /machine 20251116M /savefile C:\ODJ\20251116M.txt

# エラーコード確認
echo $LASTEXITCODE

# Active Directoryユーザーとコンピュータで確認
# Computers OU にオブジェクトが作成されているか

# 権限不足の場合、ドメイン管理者に依頼
# または Computers OU に対する Create Computer Objects 権限付与
```

**一般的なエラーコード**:
- 5: アクセス拒否（権限不足）
- 1355: ドメインが見つからない
- 1326: ユーザー名またはパスワード不正

**予防策**:
- ODJ生成用サービスアカウント作成
- 権限委任ドキュメント化

**緊急度**: 高
**対応所要時間**: 15-20分

---

### ODJ-002: ODJファイルをDRBLサーバに転送できない

**症状**:
- SCPでファイル転送失敗
- "Permission denied"

**原因**:
1. SSH認証失敗
2. 転送先ディレクトリ権限不足
3. ネットワーク接続不良

**対処手順**:

```bash
# DRBLサーバでSSH有効化確認
sudo systemctl status ssh
sudo systemctl start ssh
sudo systemctl enable ssh

# 転送先ディレクトリ作成・権限設定
sudo mkdir -p /srv/odj
sudo chmod 755 /srv/odj
sudo chown drbl:drbl /srv/odj  # またはユーザー名

# Windowsから転送（PowerShell）
scp C:\ODJ\20251116M.txt drbl@192.168.1.10:/srv/odj/

# または WinSCP/FileZilla使用

# 転送確認
ls -l /srv/odj/20251116M.txt
```

**予防策**:
- SSH鍵認証設定
- 自動転送スクリプト作成

**緊急度**: 中
**対応所要時間**: 10-15分

---

### ODJ-003: ODJファイル適用後もドメイン参加されていない

**症状**:
- `djoin.exe` 成功したがドメイン参加していない
- `(Get-WmiObject Win32_ComputerSystem).Domain` が "WORKGROUP"

**原因**:
1. djoin実行後、再起動していない
2. ODJファイル形式が不正
3. ネットワーク経路でドメインコントローラに到達できない

**対処手順**:

```powershell
# ドメイン参加状態確認
(Get-WmiObject Win32_ComputerSystem).Domain
# 期待値: company.local

# 再起動実行
Restart-Computer -Force

# 再起動後、再確認
(Get-WmiObject Win32_ComputerSystem).Domain

# Active Directoryでコンピュータオブジェクト確認
# ドメインコントローラで
Get-ADComputer -Identity 20251116M

# ネットワーク経路確認
Test-Connection -ComputerName dc01.company.local -Count 4
nslookup dc01.company.local
```

**予防策**:
- djoin実行後、必ず自動再起動設定
- ドメインコントローラ疎通確認

**緊急度**: 高
**対応所要時間**: 10-15分

---

### ODJ-004: ODJファイルダウンロード失敗

**症状**:
- PowerShellスクリプトでODJファイルダウンロードエラー
- "404 Not Found"

**原因**:
1. ODJファイルパス誤り
2. Webサーバ未起動
3. ファイル権限不足

**対処手順**:

```bash
# DRBLサーバでWebサーバ起動（Nginx or Apache）
sudo apt install nginx
sudo systemctl start nginx
sudo systemctl enable nginx

# ODJファイル公開ディレクトリ設定
sudo nano /etc/nginx/sites-available/default
```

```nginx
server {
    listen 80;
    location /odj/ {
        alias /srv/odj/;
        autoindex on;
    }
}
```

```bash
# Nginx再起動
sudo systemctl restart nginx

# ブラウザでアクセステスト
http://192.168.1.10/odj/20251116M.txt

# PowerShellでダウンロード
Invoke-WebRequest -Uri "http://192.168.1.10/odj/20251116M.txt" -OutFile "C:\Temp\20251116M.txt"
```

**予防策**:
- ODJファイル公開用Webサーバ初期設定
- ファイルパス標準化

**緊急度**: 中
**対応所要時間**: 15-20分

---

### ODJ-005: ODJファイルが大量にあり管理困難

**症状**:
- /srv/odj/ に数百ファイルが存在
- 目的のファイルが見つからない

**原因**:
1. ファイル命名規則不統一
2. 古いファイル削除運用なし

**対処手順**:

```bash
# ファイル一覧確認（作成日時順）
ls -lt /srv/odj/ | head -20

# 90日以上前のファイル削除
find /srv/odj/ -name "*.txt" -mtime +90 -delete

# ファイル名一括変更（必要に応じて）
cd /srv/odj
for file in *.txt; do
  # ファイル名からPC名抽出、YYYYMMDDM形式に統一
  mv "$file" "$(echo $file | sed 's/[^0-9M]//g').txt"
done
```

**予防策**:
- ODJファイル命名規則統一（PC名.txt）
- 定期的な古いファイル削除（cronジョブ）
- データベースでodj_pathを一元管理

**緊急度**: 低
**対応所要時間**: 15-20分

---

### ODJ-006: ドメインコントローラが複数あり、ODJ適用後に認証失敗

**症状**:
- ODJ適用成功したが、ログオンできない
- "Trust relationship failed"

**原因**:
1. Active Directoryレプリケーション未完了
2. 時刻同期ずれ
3. 複数ドメインコントローラ間の不整合

**対処手順**:

```powershell
# ドメインコントローラレプリケーション確認（DC側）
repadmin /replsummary

# 時刻同期確認
w32tm /query /status

# 時刻同期強制実行
w32tm /resync /force

# クライアントPCで時刻確認
Get-Date

# ドメインコントローラとの時刻差が5分以上の場合、NTP設定
w32tm /config /manualpeerlist:"dc01.company.local" /syncfromflags:manual /reliable:yes /update
w32tm /resync

# Trust relationship修復
Reset-ComputerMachinePassword -Credential (Get-Credential)
```

**予防策**:
- Active Directory定期ヘルスチェック
- 時刻同期（NTP）設定統一

**緊急度**: 中
**対応所要時間**: 20-30分

---

## その他

### OTHER-001: マスターイメージが古く、Windows Updateに時間がかかる

**症状**:
- Windows Updateに2時間以上かかる
- 更新プログラム数が100個以上

**原因**:
1. マスターイメージ作成から3ヶ月以上経過
2. マスターイメージ更新運用なし

**対処手順**:

```bash
# マスターイメージ更新計画
# 1. マスターPCでWindows Update実行
# 2. 会社標準アプリ最新化
# 3. AppX削除、Sysprep実行
# 4. 新しいマスターイメージ作成

# 古いマスターイメージバックアップ
sudo mv /home/partimag/win11-master-20241101 /home/partimag/backup/

# 新しいマスターイメージ配置
sudo mv /home/partimag/win11-master-20251116 /home/partimag/
```

**予防策**:
- マスターイメージ更新頻度: 3ヶ月に1回
- 重大なWindows Update後、即更新

**緊急度**: 低
**対応所要時間**: 3-4時間（マスターイメージ更新含む）

---

### OTHER-002: セットアップログが管理GUIに表示されない

**症状**:
- セットアップ完了しているが、管理GUIにログが表示されない

**原因**:
1. API `/api/log` 送信失敗
2. データベース書き込みエラー
3. 管理GUI表示ロジックバグ

**対処手順**:

```bash
# データベース直接確認
sqlite3 /opt/flask-app/pc_setup.db "SELECT * FROM setup_logs ORDER BY timestamp DESC LIMIT 10;"

# レコードが存在しない場合、PowerShellログ確認（クライアントPC側）
Get-Content C:\SetupLogs\setup.log | Select-String "api/log"

# 手動でログ送信テスト
curl -X POST http://192.168.1.10:5000/api/log \
  -H "Content-Type: application/json" \
  -d '{"serial":"ABC123","pcname":"20251116M","status":"completed","timestamp":"2025-11-16 12:00:00","logs":"Manual test"}'

# 管理GUIでリロード
# ブラウザキャッシュクリア or Ctrl+F5
```

**予防策**:
- API送信失敗時のローカルログ保存
- 定期的なデータベース同期確認

**緊急度**: 低
**対応所要時間**: 10-15分

---

### OTHER-003: 年月日が変わり、PC名が重複

**症状**:
- 同じ日に複数台導入し、PC名が "20251116M" で重複

**原因**:
1. 命名規則にシーケンス番号なし
2. 1日に複数台導入想定不足

**対処手順**:

```bash
# データベースで重複PC名確認
sqlite3 /opt/flask-app/pc_setup.db "SELECT pcname, COUNT(*) FROM pc_master GROUP BY pcname HAVING COUNT(*) > 1;"

# PC名にシーケンス番号追加（例: 20251116M01, 20251116M02）
# CSVファイル修正
nano pc_list.csv
# Serial,PCName
# ABC123,20251116M01
# DEF456,20251116M02

# データベース更新
sqlite3 /opt/flask-app/pc_setup.db "UPDATE pc_master SET pcname='20251116M01' WHERE serial='ABC123';"
```

**予防策**:
- 命名規則見直し（YYYYMMDDMNN、NN=連番01-99）
- CSV生成時に自動連番付与

**緊急度**: 中
**対応所要時間**: 15-20分

---

### OTHER-004: 特定のアプリだけインストール失敗

**症状**:
- Windows Updateやドメイン参加は成功
- 特定のアプリケーション（例: PDF閲覧ソフト）だけ失敗

**原因**:
1. インストーラサイレントオプション誤り
2. インストーラファイル破損
3. 依存ソフトウェア未インストール

**対処手順**:

```powershell
# インストールログ確認
Get-Content C:\SetupLogs\app_install.log | Select-String "ERROR"

# 手動インストール試行（サイレントオプション確認）
Start-Process "C:\Installers\AdobeReader.exe" -ArgumentList "/sAll /rs /msi EULA_ACCEPT=YES" -Wait

# 終了コード確認
echo $LASTEXITCODE

# インストーラ公式ドキュメントでサイレントオプション確認
# 例: Adobe Reader
# /sAll /rs /msi EULA_ACCEPT=YES

# 依存ソフトウェア確認（例: .NET Framework）
Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full" | Select-Object Version
```

**予防策**:
- アプリインストールサイレントオプション一覧作成
- 依存ソフトウェア事前インストール

**緊急度**: 低
**対応所要時間**: 20-30分

---

### OTHER-005: DRBLサーバのディスク容量が不足

**症状**:
- 新しいマスターイメージが保存できない
- "No space left on device" エラー

**原因**:
1. 古いマスターイメージが蓄積
2. ログファイル肥大化
3. パーティションサイズ不足

**対処手順**:

```bash
# ディスク使用状況確認
df -h

# 容量の大きいディレクトリ特定
sudo du -sh /* | sort -h | tail -10

# 古いマスターイメージ削除
sudo ls -lht /home/partimag/
sudo rm -rf /home/partimag/win11-master-20240801

# ログファイル削除
sudo journalctl --vacuum-time=30d  # 30日以前のログ削除
sudo rm /var/log/*.gz

# 不要なAPTキャッシュ削除
sudo apt clean
sudo apt autoclean
```

**予防策**:
- 定期的なディスク容量監視（週次）
- 古いイメージ自動削除（90日以上前）
- /home/partimag 専用パーティション拡張

**緊急度**: 高
**対応所要時間**: 15-20分

---

## 緊急連絡先

### 社内サポート
- **IT部門ヘルプデスク**: 内線 1234
- **ネットワーク管理者**: 内線 5678
- **Active Directory管理者**: 内線 9012

### ベンダーサポート
- **DRBLコミュニティ**: https://drbl.org
- **Clonezilla公式**: https://clonezilla.org
- **Microsoft サポート**: https://support.microsoft.com

### エスカレーションフロー

1. **レベル1** (緊急度: 低): IT部門ヘルプデスク対応
2. **レベル2** (緊急度: 中): ネットワーク管理者対応
3. **レベル3** (緊急度: 高): システム責任者対応、ベンダーサポート連絡

---

**ドキュメントバージョン**: 1.0
**最終更新日**: 2025-11-17
**作成者**: IT部門
